<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNE PORTAL - Cashbill System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header h2 {
            color: var(--primary-color);
            font-weight: 600;
        }
        .portal-container {
            display: none;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100vh;
            background-color: var(--primary-color);
            transition: all 0.3s ease;
            z-index: 1000;
            padding-top: 60px;
            overflow-y: auto;
        }
        .sidebar.active {
            left: 0;
        }
        .sidebar-header {
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            font-weight: 600;
            text-align: center;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar-menu li a {
            display: block;
            padding: 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .sidebar-menu li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .sidebar-menu li a.active {
            background-color: var(--secondary-color);
            color: white;
        }
        .sidebar-menu li a i {
            margin-right: 10px;
        }
        .main-content {
            margin-left: 0;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        .main-content.shifted {
            margin-left: 250px;
        }
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: 600;
        }
        .content-section {
            display: none;
            padding: 20px;
        }
        .content-section.active {
            display: block;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table thead {
            background-color: var(--primary-color);
            color: white;
        }
        .product-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .product-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .product-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .price-tag {
            font-weight: 600;
            color: var(--danger-color);
        }
        .member-price {
            color: var(--success-color);
        }
        .min-order {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }
        .status-approved {
            background-color: var(--success-color);
            color: white;
        }
        .status-committed {
            background-color: var(--secondary-color);
            color: white;
        }
        .status-draft {
            background-color: #6c757d;
            color: white;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        .overlay.active {
            display: block;
        }
        .user-role {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .role-admin {
            background-color: var(--danger-color);
            color: white;
        }
        .role-staff {
            background-color: var(--secondary-color);
            color: white;
        }
        .cashbill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .cashbill-item:last-child {
            border-bottom: none;
        }
        .item-actions {
            display: flex;
            gap: 5px;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        .uncommitted-card {
            border-left: 4px solid var(--warning-color);
        }
        .uncommitted-card .card-header {
            background-color: var(--warning-color);
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            padding-left: 35px;
        }
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .print-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .print-header h2 {
            color: var(--primary-color);
            font-weight: 600;
        }
        .print-section {
            margin-bottom: 20px;
        }
        .print-section h5 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
        }
        .edit-mode {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .edit-mode label {
            font-weight: 600;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-header">
            <h2><i class="fas fa-file-invoice-dollar"></i> PNE PORTAL</h2>
            <p class="text-muted">Cashbill Management System</p>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Staff ID</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>
    <!-- Portal Container -->
    <div id="portalContainer" class="portal-container">
        <!-- Overlay for sidebar -->
        <div id="overlay" class="overlay"></div>
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                PNE PORTAL
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-link active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" class="menu-link" data-section="cashbill"><i class="fas fa-file-invoice-dollar"></i> New Cashbill</a></li>
                <li><a href="#" class="menu-link" data-section="cashbill-list"><i class="fas fa-list"></i> All Cashbills</a></li>
                <li><a href="#" class="menu-link" data-section="logbook"><i class="fas fa-book"></i> New Logbook</a></li>
                <li><a href="#" class="menu-link" data-section="logbook-list"><i class="fas fa-list"></i> All Logbooks</a></li>
                <li><a href="#" class="menu-link" data-section="products"><i class="fas fa-box"></i> Products</a></li>
                <li><a href="#" class="menu-link admin-only" data-section="uncommitted"><i class="fas fa-clipboard-list"></i> Uncommitted Requests</a></li>
                <li><a href="#" class="menu-link admin-only" data-section="staff"><i class="fas fa-users"></i> Staff Management</a></li>
                <li><a href="#" class="menu-link" data-section="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
        <!-- Main Content -->
        <div id="mainContent" class="main-content">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <button id="menuToggle" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a class="navbar-brand ms-2" href="#">PNE PORTAL</a>
                    <div class="ms-auto d-flex align-items-center">
                        <span id="userInfo" class="text-white me-3">
                            Welcome, <span id="userName">User</span>
                            <span id="userRole" class="user-role">Staff</span>
                        </span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog me-2"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn2"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="container-fluid">
                    <h2 class="mb-4">Dashboard</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Total Cashbills</h5>
                                    <h2 id="totalCashbills">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title">Completed</h5>
                                    <h2 id="completedCashbills">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title">Pending Approval</h5>
                                    <h2 id="pendingCashbills">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-danger">
                                <div class="card-body">
                                    <h5 class="card-title">Total Revenue</h5>
                                    <h2 id="totalRevenue">RM 0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    Recent Cashbills
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Customer</th>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentCashbillsTable">
                                                <tr>
                                                    <td colspan="6" class="text-center">No cashbills found</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    Quick Actions
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="newCashbillBtn">
                                            <i class="fas fa-plus-circle me-2"></i> New Cashbill
                                        </button>
                                        <button class="btn btn-outline-primary" id="newLogbookBtn">
                                            <i class="fas fa-plus-circle me-2"></i> New Logbook
                                        </button>
                                        <button class="btn btn-outline-secondary">
                                            <i class="fas fa-file-export me-2"></i> Export Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cashbill Section -->
            <div id="cashbill" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Create New Cashbill</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    Cashbill Information
                                </div>
                                <div class="card-body">
                                    <form id="cashbillForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="cashbillId" class="form-label">Cashbill ID</label>
                                                <input type="text" class="form-control" id="cashbillId" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="cashbillDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="cashbillDate" required>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Customer Information</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="customerFirstName" class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="customerFirstName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="customerLastName" class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="customerLastName" required>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="customerPhone" class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" id="customerPhone" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="customerEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="customerEmail">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerAddress" class="form-label">Address</label>
                                            <textarea class="form-control" id="customerAddress" rows="2" required></textarea>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Order Items</h5>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-md-5">
                                                    <label for="productSelect" class="form-label">Select Product</label>
                                                    <select class="form-select" id="productSelect">
                                                        <option value="">-- Select Product --</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="quantity" class="form-label">Quantity</label>
                                                    <input type="number" class="form-control" id="quantity" min="1" value="1">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="price" class="form-label">Price (RM)</label>
                                                    <input type="number" class="form-control" id="price" step="0.01" min="0">
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-primary" id="addItemBtn">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="card">
                                                <div class="card-header">
                                                    Order Items
                                                </div>
                                                <div class="card-body">
                                                    <div id="orderItems">
                                                        <div class="text-center text-muted py-3">No items added yet</div>
                                                    </div>
                                                    <div class="mt-3 text-end">
                                                        <h5>Total: RM <span id="totalAmount">0.00</span></h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Payment Information</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="paymentType" class="form-label">Payment Type</label>
                                                <select class="form-select" id="paymentType" required>
                                                    <option value="">-- Select Payment Type --</option>
                                                    <option value="cash">Cash</option>
                                                    <option value="bank-transfer">Bank Transfer</option>
                                                    <option value="credit-card">Credit Card</option>
                                                    <option value="e-wallet">E-Wallet</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="paymentStatus" class="form-label">Payment Status</label>
                                                <select class="form-select" id="paymentStatus" required>
                                                    <option value="pending">Pending</option>
                                                    <option value="partial">Partial</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="notes" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes" rows="2"></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-secondary" id="resetCashbillBtn">Reset</button>
                                            <div>
                                                <button type="button" class="btn btn-warning me-2" id="saveDraftBtn">Save as Draft</button>
                                                <button type="submit" class="btn btn-primary" id="commitCashbillBtn">Commit Cashbill</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cashbill List Section -->
            <div id="cashbill-list" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">All Cashbills</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Cashbill List</span>
                                    <button class="btn btn-sm btn-primary" id="newCashbillFromListBtn">
                                        <i class="fas fa-plus me-1"></i> New Cashbill
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="filter-section mb-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="search-box">
                                                    <i class="fas fa-search"></i>
                                                    <input type="text" class="form-control" id="searchCashbill" placeholder="Search by ID or customer name...">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="filterStatus">
                                                    <option value="">All Status</option>
                                                    <option value="draft">Draft</option>
                                                    <option value="committed">Committed</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="date" class="form-control" id="filterDate" placeholder="Filter by date">
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-outline-secondary w-100" id="clearFiltersBtn">Clear</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Customer</th>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Created By</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="allCashbillsTable">
                                                <tr>
                                                    <td colspan="7" class="text-center">No cashbills found</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Logbook Section -->
            <div id="logbook" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Create New Logbook Entry</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    Logbook Information
                                </div>
                                <div class="card-body">
                                    <form id="logbookForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="logbookId" class="form-label">Logbook ID</label>
                                                <input type="text" class="form-control" id="logbookId" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="logbookDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="logbookDate" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="cashbillRef" class="form-label">Cashbill Reference</label>
                                                <select class="form-select" id="cashbillRef" required>
                                                    <option value="">-- Select Cashbill --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="trackingNumber" class="form-label">Tracking Number</label>
                                                <input type="text" class="form-control" id="trackingNumber">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="courierName" class="form-label">Courier Name</label>
                                                <input type="text" class="form-control" id="courierName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="deliveryStatus" class="form-label">Delivery Status</label>
                                                <select class="form-select" id="deliveryStatus" required>
                                                    <option value="preparing">Preparing</option>
                                                    <option value="picked-up">Picked Up</option>
                                                    <option value="in-transit">In Transit</option>
                                                    <option value="delivered">Delivered</option>
                                                    <option value="returned">Returned</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="deliveryAddress" class="form-label">Delivery Address</label>
                                            <textarea class="form-control" id="deliveryAddress" rows="2" required></textarea>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="deliveryDate" class="form-label">Expected Delivery Date</label>
                                                <input type="date" class="form-control" id="deliveryDate">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="deliveryTime" class="form-label">Expected Delivery Time</label>
                                                <input type="time" class="form-control" id="deliveryTime">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="logbookNotes" class="form-label">Notes</label>
                                            <textarea class="form-control" id="logbookNotes" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-secondary" id="resetLogbookBtn">Reset</button>
                                            <div>
                                                <button type="button" class="btn btn-warning me-2" id="saveLogbookDraftBtn">Save as Draft</button>
                                                <button type="submit" class="btn btn-primary" id="saveLogbookBtn">Save Logbook</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Logbook List Section -->
            <div id="logbook-list" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">All Logbooks</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Logbook List</span>
                                    <button class="btn btn-sm btn-primary" id="newLogbookFromListBtn">
                                        <i class="fas fa-plus me-1"></i> New Logbook
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="filter-section mb-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="search-box">
                                                    <i class="fas fa-search"></i>
                                                    <input type="text" class="form-control" id="searchLogbook" placeholder="Search by ID or courier name...">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="filterDeliveryStatus">
                                                    <option value="">All Status</option>
                                                    <option value="preparing">Preparing</option>
                                                    <option value="picked-up">Picked Up</option>
                                                    <option value="in-transit">In Transit</option>
                                                    <option value="delivered">Delivered</option>
                                                    <option value="returned">Returned</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="date" class="form-control" id="filterLogbookDate" placeholder="Filter by date">
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-outline-secondary w-100" id="clearLogbookFiltersBtn">Clear</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Cashbill Ref</th>
                                                    <th>Courier</th>
                                                    <th>Date</th>
                                                    <th>Delivery Status</th>
                                                    <th>Tracking #</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="allLogbooksTable">
                                                <tr>
                                                    <td colspan="7" class="text-center">No logbooks found</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Uncommitted Requests Section (Admin Only) -->
            <div id="uncommitted" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Uncommitted Requests</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    Pending Approval
                                </div>
                                <div class="card-body">
                                    <div id="uncommittedList">
                                        <div class="text-center py-5">
                                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">No uncommitted requests found</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Products Section -->
            <div id="products" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Product Management</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Product Catalog</span>
                                    <button class="btn btn-sm btn-primary admin-only" id="addProductBtn">
                                        <i class="fas fa-plus me-1"></i> Add Product
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="productsList">
                                        <!-- Products will be dynamically loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Staff Management Section -->
            <div id="staff" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Staff Management</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Staff List</span>
                                    <button class="btn btn-sm btn-primary admin-only" id="addStaffBtn">
                                        <i class="fas fa-user-plus me-1"></i> Add New Staff
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Staff ID</th>
                                                    <th>Name</th>
                                                    <th>Username</th>
                                                    <th>Role</th>
                                                    <th>Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="staffTable">
                                                <!-- Staff will be dynamically loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Reports</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    Generate Reports
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-file-invoice-dollar fa-3x text-primary mb-3"></i>
                                                    <h5>Cashbill Report</h5>
                                                    <p class="text-muted">Generate cashbill reports with filters</p>
                                                    <button class="btn btn-primary generate-report" data-type="cashbill">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-truck fa-3x text-success mb-3"></i>
                                                    <h5>Delivery Report</h5>
                                                    <p class="text-muted">Generate delivery and logistics reports</p>
                                                    <button class="btn btn-primary generate-report" data-type="delivery">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                                                    <h5>Sales Report</h5>
                                                    <p class="text-muted">Generate sales and revenue reports</p>
                                                    <button class="btn btn-primary generate-report" data-type="sales">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-box fa-3x text-info mb-3"></i>
                                                    <h5>Inventory Report</h5>
                                                    <p class="text-muted">Generate inventory and stock reports</p>
                                                    <button class="btn btn-primary generate-report" data-type="inventory">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div class="toast-container"></div>
    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productIcon" class="form-label">Product Icon</label>
                                <select class="form-select" id="productIcon">
                                    <option value="">-- Select Icon --</option>
                                    <option value=""> Mosque</option>
                                    <option value=""> Book</option>
                                    <option value=""> Child</option>
                                    <option value=""> Label</option>
                                    <option value=""> Medal</option>
                                    <option value=""> Key</option>
                                    <option value=""> T-Shirt</option>
                                    <option value=""> Pants</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="regularPrice" class="form-label">Regular Price (RM)</label>
                                <input type="number" class="form-control" id="regularPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="memberPrice" class="form-label">Member Price (RM)</label>
                                <input type="number" class="form-control" id="memberPrice" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productUnit" class="form-label">Unit</label>
                                <select class="form-select" id="productUnit">
                                    <option value="per set">Per Set</option>
                                    <option value="per piece">Per Piece</option>
                                    <option value="each">Each</option>
                                    <option value="per pc">Per PC</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="minOrder" class="form-label">Minimum Order</label>
                                <input type="number" class="form-control" id="minOrder" min="0" value="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productFeatures" class="form-label">Features (one per line)</label>
                            <textarea class="form-control" id="productFeatures" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Staff Modal -->
    <div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStaffModalLabel">Add New Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStaffForm">
                        <div class="mb-3">
                            <label for="staffFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="staffFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="staffLastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffUsername" class="form-label">Staff ID</label>
                            <input type="text" class="form-control" id="staffUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="staffPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffRole" class="form-label">Role</label>
                            <select class="form-select" id="staffRole" required>
                                <option value="staff">Crew</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveStaffBtn">Save Staff</button>
                </div>
            </div>
        </div>
    </div>
    <!-- View Cashbill Modal -->
    <div class="modal fade" id="viewCashbillModal" tabindex="-1" aria-labelledby="viewCashbillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewCashbillModalLabel">Cashbill Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cashbillDetails">
                        <!-- Cashbill details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printCashbillBtn">Print</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Cashbill Modal -->
    <div class="modal fade" id="editCashbillModal" tabindex="-1" aria-labelledby="editCashbillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCashbillModalLabel">Edit Cashbill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCashbillForm">
                        <input type="hidden" id="editCashbillId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCashbillDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="editCashbillDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPaymentType" class="form-label">Payment Type</label>
                                <select class="form-select" id="editPaymentType" required>
                                    <option value="cash">Cash</option>
                                    <option value="bank-transfer">Bank Transfer</option>
                                    <option value="credit-card">Credit Card</option>
                                    <option value="e-wallet">E-Wallet</option>
                                </select>
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Customer Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCustomerFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="editCustomerFirstName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCustomerLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="editCustomerLastName" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCustomerPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editCustomerPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCustomerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editCustomerEmail">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editCustomerAddress" rows="2" required></textarea>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Order Items</h5>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-5">
                                    <label for="editProductSelect" class="form-label">Select Product</label>
                                    <select class="form-select" id="editProductSelect">
                                        <option value="">-- Select Product --</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="editQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editQuantity" min="1" value="1">
                                </div>
                                <div class="col-md-3">
                                    <label for="editPrice" class="form-label">Price (RM)</label>
                                    <input type="number" class="form-control" id="editPrice" step="0.01" min="0">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary" id="addEditItemBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    Order Items
                                </div>
                                <div class="card-body">
                                    <div id="editOrderItems">
                                        <!-- Items will be populated here -->
                                    </div>
                                    <div class="mt-3 text-end">
                                        <h5>Total: RM <span id="editTotalAmount">0.00</span></h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editPaymentStatus" class="form-label">Payment Status</label>
                                <select class="form-select" id="editPaymentStatus" required>
                                    <option value="pending">Pending</option>
                                    <option value="partial">Partial</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="editNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="updateDraftBtn">Update Draft</button>
                    <button type="button" class="btn btn-primary" id="updateAndCommitBtn">Update & Commit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- View Logbook Modal -->
    <div class="modal fade" id="viewLogbookModal" tabindex="-1" aria-labelledby="viewLogbookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewLogbookModalLabel">Logbook Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logbookDetails">
                        <!-- Logbook details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printLogbookBtn">Print</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Print Cashbill Template (Hidden) -->
    <div id="printCashbillTemplate" class="print-only" style="display: none;">
        <div class="print-header">
            <h2>PNE PORTAL</h2>
            <h4>CASHBILL INVOICE</h4>
        </div>
        <div class="print-section">
            <h5>Cashbill Information</h5>
            <div id="printCashbillInfo"></div>
        </div>
        <div class="print-section">
            <h5>Customer Information</h5>
            <div id="printCustomerInfo"></div>
        </div>
        <div class="print-section">
            <h5>Order Items</h5>
            <div id="printOrderItems"></div>
        </div>
        <div class="print-section">
            <h5>Payment Information</h5>
            <div id="printPaymentInfo"></div>
        </div>
        <div class="text-center mt-4">
            <p>Thank you for your business!</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data storage
            initializeDataStorage();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cashbillDate').value = today;
            document.getElementById('logbookDate').value = today;
            
            // Initialize variables
            let currentUser = null;
            let sidebarOpen = false;
            let currentSection = 'dashboard';
            let editingCashbillId = null;
            
            // DOM elements
            const loginPage = document.getElementById('loginPage');
            const portalContainer = document.getElementById('portalContainer');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('overlay');
            const menuToggle = document.getElementById('menuToggle');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutBtn2 = document.getElementById('logoutBtn2');
            const menuLinks = document.querySelectorAll('.menu-link');
            const contentSections = document.querySelectorAll('.content-section');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('pne_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPortal();
            }
            
            // Login form submission
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Authenticate user
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('pne_current_user', JSON.stringify(user));
                    showPortal();
                } else {
                    showToast('Invalid Staff ID or password', 'danger');
                }
            });
            
            // Show portal after login
            function showPortal() {
                loginPage.style.display = 'none';
                portalContainer.style.display = 'block';
                
                // Set user info
                userName.textContent = currentUser.name;
                userRole.textContent = currentUser.role === 'admin' ? 'Admin' : 'Crew';
                userRole.className = `user-role ${currentUser.role === 'admin' ? 'role-admin' : 'role-staff'}`;
                
                // Show success message
                showToast(`Welcome, ${currentUser.name}!`, 'success');
                
                // Check if user is admin to show/hide certain features
                if (currentUser.role === 'staff') {
                    // Hide admin-only features for regular staff
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'none';
                    });
                }
                
                // Load initial data
                loadDashboardData();
                loadProducts();
                loadStaff();
                loadCashbillList();
                loadLogbookList();
                updateCashbillRef();
            }
            
            // Logout functionality
            logoutBtn.addEventListener('click', logout);
            logoutBtn2.addEventListener('click', logout);
            
            function logout() {
                currentUser = null;
                localStorage.removeItem('pne_current_user');
                loginPage.style.display = 'block';
                portalContainer.style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showToast('You have been logged out', 'info');
            }
            
            // Toggle sidebar
            menuToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            function toggleSidebar() {
                sidebarOpen = !sidebarOpen;
                
                if (sidebarOpen) {
                    sidebar.classList.add('active');
                    mainContent.classList.add('shifted');
                    overlay.classList.add('active');
                } else {
                    closeSidebar();
                }
            }
            
            function closeSidebar() {
                sidebarOpen = false;
                sidebar.classList.remove('active');
                mainContent.classList.remove('shifted');
                overlay.classList.remove('active');
            }
            
            // Menu navigation
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const section = this.getAttribute('data-section');
                    if (section) {
                        showSection(section);
                        closeSidebar();
                    }
                });
            });
            
            function showSection(sectionName) {
                // Update active menu link
                menuLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-section') === sectionName) {
                        link.classList.add('active');
                    }
                });
                
                // Show selected section
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === sectionName) {
                        section.classList.add('active');
                    }
                });
                
                currentSection = sectionName;
                
                // Refresh data when navigating to certain sections
                if (sectionName === 'uncommitted') {
                    refreshUncommittedList();
                } else if (sectionName === 'cashbill-list') {
                    loadCashbillList();
                } else if (sectionName === 'logbook-list') {
                    loadLogbookList();
                } else if (sectionName === 'products') {
                    loadProducts();
                } else if (sectionName === 'staff') {
                    loadStaff();
                }
            }
            
            // Quick action buttons
            document.getElementById('newCashbillBtn').addEventListener('click', function() {
                showSection('cashbill');
                generateNewCashbillId();
            });
            
            document.getElementById('newLogbookBtn').addEventListener('click', function() {
                showSection('logbook');
                generateNewLogbookId();
            });
            
            document.getElementById('newCashbillFromListBtn').addEventListener('click', function() {
                showSection('cashbill');
                generateNewCashbillId();
            });
            
            document.getElementById('newLogbookFromListBtn').addEventListener('click', function() {
                showSection('logbook');
                generateNewLogbookId();
            });
            
            // Cashbill form handling
            const cashbillForm = document.getElementById('cashbillForm');
            const addItemBtn = document.getElementById('addItemBtn');
            const productSelect = document.getElementById('productSelect');
            const quantityInput = document.getElementById('quantity');
            const priceInput = document.getElementById('price');
            const orderItemsContainer = document.getElementById('orderItems');
            const totalAmountSpan = document.getElementById('totalAmount');
            
            // Load products into select dropdown
            function loadProductsIntoSelect() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                productSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.icon} ${product.name} - RM ${product.regularPrice}`;
                    productSelect.appendChild(option);
                });
            }
            
            // Set price when product is selected
            productSelect.addEventListener('change', function() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = this.value;
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        priceInput.value = product.regularPrice;
                        
                        // Disable price editing for staff users
                        if (currentUser && currentUser.role === 'staff') {
                            priceInput.disabled = true;
                        } else {
                            priceInput.disabled = false;
                        }
                    }
                } else {
                    priceInput.value = '';
                    priceInput.disabled = false;
                }
            });
            
            // Add item to order
            addItemBtn.addEventListener('click', function() {
                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                const price = parseFloat(priceInput.value) || 0;
                
                if (!productId) {
                    showToast('Please select a product', 'warning');
                    return;
                }
                
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showToast('Product not found', 'danger');
                    return;
                }
                
                // Clear placeholder if it exists
                const placeholder = orderItemsContainer.querySelector('.text-center');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // Create new item element
                const itemElement = document.createElement('div');
                itemElement.className = 'cashbill-item';
                itemElement.innerHTML = `
                    <div>
                        <div class="fw-bold">${product.icon} ${product.name}</div>
                        <div>${quantity} x RM ${price.toFixed(2)}</div>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add remove functionality
                itemElement.querySelector('.remove-item').addEventListener('click', function() {
                    itemElement.remove();
                    updateTotalAmount();
                    
                    // Add placeholder back if no items
                    if (orderItemsContainer.children.length === 0) {
                        orderItemsContainer.innerHTML = '<div class="text-center text-muted py-3">No items added yet</div>';
                    }
                });
                
                // Add to order items
                orderItemsContainer.appendChild(itemElement);
                
                // Update total
                updateTotalAmount();
                
                // Reset form
                productSelect.value = '';
                quantityInput.value = '1';
                priceInput.value = '';
                priceInput.disabled = false;
            });
            
            // Update total amount
            function updateTotalAmount() {
                let total = 0;
                
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        total += quantity * price;
                    }
                });
                
                totalAmountSpan.textContent = total.toFixed(2);
            }
            
            // Cashbill form submission
            cashbillForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Check if there are items in the order
                if (orderItemsContainer.children.length === 0 || orderItemsContainer.querySelector('.text-center')) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get form data
                const cashbillId = document.getElementById('cashbillId').value;
                const cashbillDate = document.getElementById('cashbillDate').value;
                const customerFirstName = document.getElementById('customerFirstName').value;
                const customerLastName = document.getElementById('customerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                const notes = document.getElementById('notes').value;
                
                // Get order items
                const items = [];
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(totalAmountSpan.textContent);
                
                // Create cashbill object
                const cashbill = {
                    id: cashbillId,
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: 'committed',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save cashbill
                saveCashbill(cashbill);
                
                // Show success message
                showToast(`Cashbill ${cashbillId} committed successfully!`, 'success');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetCashbillForm();
                    generateNewCashbillId();
                }, 1500);
            });
            
            // Save cashbill function
            function saveCashbill(cashbill) {
                let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                
                // Check if cashbill already exists (for editing)
                const existingIndex = cashbills.findIndex(cb => cb.id === cashbill.id);
                if (existingIndex !== -1) {
                    cashbills[existingIndex] = cashbill;
                } else {
                    cashbills.push(cashbill);
                }
                
                localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                
                // Update counters
                updateCounters();
            }
            
            // Reset cashbill form
            function resetCashbillForm() {
                cashbillForm.reset();
                orderItemsContainer.innerHTML = '<div class="text-center text-muted py-3">No items added yet</div>';
                totalAmountSpan.textContent = '0.00';
                document.getElementById('cashbillDate').value = today;
            }
            
            document.getElementById('resetCashbillBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    resetCashbillForm();
                    generateNewCashbillId();
                }
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                // Check if there are items in the order
                if (orderItemsContainer.children.length === 0 || orderItemsContainer.querySelector('.text-center')) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get form data
                const cashbillId = document.getElementById('cashbillId').value;
                const cashbillDate = document.getElementById('cashbillDate').value;
                const customerFirstName = document.getElementById('customerFirstName').value;
                const customerLastName = document.getElementById('customerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                const notes = document.getElementById('notes').value;
                
                // Get order items
                const items = [];
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(totalAmountSpan.textContent);
                
                // Create cashbill object
                const cashbill = {
                    id: cashbillId,
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: 'draft',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save cashbill
                saveCashbill(cashbill);
                
                showToast(`Cashbill ${cashbillId} saved as draft!`, 'info');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetCashbillForm();
                    generateNewCashbillId();
                }, 1500);
            });
            
            // Edit Cashbill Modal Setup
            const editCashbillModal = new bootstrap.Modal(document.getElementById('editCashbillModal'));
            const editCashbillForm = document.getElementById('editCashbillForm');
            const editProductSelect = document.getElementById('editProductSelect');
            const editQuantityInput = document.getElementById('editQuantity');
            const editPriceInput = document.getElementById('editPrice');
            const editOrderItemsContainer = document.getElementById('editOrderItems');
            const editTotalAmountSpan = document.getElementById('editTotalAmount');
            
            // Load products into edit select
            function loadProductsIntoEditSelect() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                editProductSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.icon} ${product.name} - RM ${product.regularPrice}`;
                    editProductSelect.appendChild(option);
                });
            }
            
            // Set price when product is selected in edit mode
            editProductSelect.addEventListener('change', function() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = this.value;
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        editPriceInput.value = product.regularPrice;
                    }
                } else {
                    editPriceInput.value = '';
                }
            });
            
            // Add item to edit order
            document.getElementById('addEditItemBtn').addEventListener('click', function() {
                const productId = editProductSelect.value;
                const quantity = parseInt(editQuantityInput.value) || 1;
                const price = parseFloat(editPriceInput.value) || 0;
                
                if (!productId) {
                    showToast('Please select a product', 'warning');
                    return;
                }
                
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showToast('Product not found', 'danger');
                    return;
                }
                
                // Create new item element
                const itemElement = document.createElement('div');
                itemElement.className = 'cashbill-item';
                itemElement.innerHTML = `
                    <div>
                        <div class="fw-bold">${product.icon} ${product.name}</div>
                        <div>${quantity} x RM ${price.toFixed(2)}</div>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-edit-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add remove functionality
                itemElement.querySelector('.remove-edit-item').addEventListener('click', function() {
                    itemElement.remove();
                    updateEditTotalAmount();
                });
                
                // Add to order items
                editOrderItemsContainer.appendChild(itemElement);
                
                // Update total
                updateEditTotalAmount();
                
                // Reset form
                editProductSelect.value = '';
                editQuantityInput.value = '1';
                editPriceInput.value = '';
            });
            
            // Update edit total amount
            function updateEditTotalAmount() {
                let total = 0;
                
                editOrderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        total += quantity * price;
                    }
                });
                
                editTotalAmountSpan.textContent = total.toFixed(2);
            }
            
            // Update draft button
            document.getElementById('updateDraftBtn').addEventListener('click', function() {
                updateCashbill('draft');
            });
            
            // Update and commit button
            document.getElementById('updateAndCommitBtn').addEventListener('click', function() {
                updateCashbill('committed');
            });
            
            // Update cashbill function
            function updateCashbill(newStatus) {
                // Get form data
                const cashbillId = document.getElementById('editCashbillId').value;
                const cashbillDate = document.getElementById('editCashbillDate').value;
                const customerFirstName = document.getElementById('editCustomerFirstName').value;
                const customerLastName = document.getElementById('editCustomerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('editCustomerPhone').value;
                const customerEmail = document.getElementById('editCustomerEmail').value;
                const customerAddress = document.getElementById('editCustomerAddress').value;
                const paymentType = document.getElementById('editPaymentType').value;
                const paymentStatus = document.getElementById('editPaymentStatus').value;
                const notes = document.getElementById('editNotes').value;
                
                // Check if there are items in the order
                if (editOrderItemsContainer.children.length === 0) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get order items
                const items = [];
                editOrderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(editTotalAmountSpan.textContent);
                
                // Get existing cashbill
                let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbillIndex = cashbills.findIndex(cb => cb.id === cashbillId);
                
                if (cashbillIndex === -1) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Update cashbill
                cashbills[cashbillIndex] = {
                    ...cashbills[cashbillIndex],
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                };
                
                // Save cashbill
                localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                
                // Show success message
                const statusText = newStatus === 'draft' ? 'draft updated' : 'updated and committed';
                showToast(`Cashbill ${cashbillId} ${statusText} successfully!`, 'success');
                
                // Close modal
                editCashbillModal.hide();
                
                // Refresh data
                loadDashboardData();
                loadCashbillList();
                refreshUncommittedList();
                updateCounters();
            }
            
            // Edit cashbill function
            function editCashbill(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Only allow editing draft cashbills
                if (cashbill.status !== 'draft' && currentUser.role !== 'admin') {
                    showToast('Only draft cashbills can be edited', 'warning');
                    return;
                }
                
                // Set editing cashbill ID
                editingCashbillId = cashbillId;
                
                // Populate form with cashbill data
                document.getElementById('editCashbillId').value = cashbill.id;
                document.getElementById('editCashbillDate').value = cashbill.date;
                document.getElementById('editCustomerFirstName').value = cashbill.customer.firstName;
                document.getElementById('editCustomerLastName').value = cashbill.customer.lastName;
                document.getElementById('editCustomerPhone').value = cashbill.customer.phone;
                document.getElementById('editCustomerEmail').value = cashbill.customer.email || '';
                document.getElementById('editCustomerAddress').value = cashbill.customer.address;
                document.getElementById('editPaymentType').value = cashbill.payment.type;
                document.getElementById('editPaymentStatus').value = cashbill.payment.status;
                document.getElementById('editNotes').value = cashbill.notes || '';
                
                // Populate order items
                editOrderItemsContainer.innerHTML = '';
                cashbill.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cashbill-item';
                    itemElement.innerHTML = `
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            <div>${item.quantity} x RM ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-edit-item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add remove functionality
                    itemElement.querySelector('.remove-edit-item').addEventListener('click', function() {
                        itemElement.remove();
                        updateEditTotalAmount();
                    });
                    
                    editOrderItemsContainer.appendChild(itemElement);
                });
                
                // Update total
                updateEditTotalAmount();
                
                // Load products into select
                loadProductsIntoEditSelect();
                
                // Show modal
                editCashbillModal.show();
            }
            
            // Delete cashbill function
            function deleteCashbill(cashbillId) {
                if (confirm(`Are you sure you want to delete cashbill ${cashbillId}? This action cannot be undone.`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    cashbills = cashbills.filter(cb => cb.id !== cashbillId);
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    showToast(`Cashbill ${cashbillId} deleted successfully!`, 'success');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            }
            
            // Logbook form handling
            const logbookForm = document.getElementById('logbookForm');
            
            logbookForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const logbookId = document.getElementById('logbookId').value;
                const logbookDate = document.getElementById('logbookDate').value;
                const cashbillRef = document.getElementById('cashbillRef').value;
                const trackingNumber = document.getElementById('trackingNumber').value;
                const courierName = document.getElementById('courierName').value;
                const deliveryStatus = document.getElementById('deliveryStatus').value;
                const deliveryAddress = document.getElementById('deliveryAddress').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                const deliveryTime = document.getElementById('deliveryTime').value;
                const logbookNotes = document.getElementById('logbookNotes').value;
                
                // Create logbook object
                const logbook = {
                    id: logbookId,
                    date: logbookDate,
                    cashbillRef: cashbillRef,
                    trackingNumber: trackingNumber,
                    courierName: courierName,
                    deliveryStatus: deliveryStatus,
                    deliveryAddress: deliveryAddress,
                    expectedDelivery: {
                        date: deliveryDate,
                        time: deliveryTime
                    },
                    notes: logbookNotes,
                    status: 'saved',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save logbook
                saveLogbook(logbook);
                
                showToast(`Logbook ${logbookId} saved successfully!`, 'success');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetLogbookForm();
                    generateNewLogbookId();
                }, 1500);
            });
            
            // Save logbook function
            function saveLogbook(logbook) {
                let logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                
                // Check if logbook already exists (for editing)
                const existingIndex = logbooks.findIndex(lb => lb.id === logbook.id);
                if (existingIndex !== -1) {
                    logbooks[existingIndex] = logbook;
                } else {
                    logbooks.push(logbook);
                }
                
                localStorage.setItem('pne_logbooks', JSON.stringify(logbooks));
            }
            
            // Reset logbook form
            function resetLogbookForm() {
                logbookForm.reset();
                document.getElementById('logbookDate').value = today;
            }
            
            document.getElementById('resetLogbookBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    resetLogbookForm();
                    generateNewLogbookId();
                }
            });
            
            // Save logbook draft
            document.getElementById('saveLogbookDraftBtn').addEventListener('click', function() {
                const logbookId = document.getElementById('logbookId').value;
                showToast(`Logbook ${logbookId} saved as draft!`, 'info');
            });
            
            // Product management
            const addProductBtn = document.getElementById('addProductBtn');
            const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            const saveProductBtn = document.getElementById('saveProductBtn');
            
            addProductBtn.addEventListener('click', function() {
                // Only allow admin to add products
                if (currentUser && currentUser.role === 'admin') {
                    addProductModal.show();
                } else {
                    showToast('You do not have permission to add products', 'danger');
                }
            });
            
            saveProductBtn.addEventListener('click', function() {
                // Get form data
                const productName = document.getElementById('productName').value;
                const productIcon = document.getElementById('productIcon').value;
                const regularPrice = parseFloat(document.getElementById('regularPrice').value);
                const memberPrice = parseFloat(document.getElementById('memberPrice').value);
                const productUnit = document.getElementById('productUnit').value;
                const minOrder = parseInt(document.getElementById('minOrder').value) || 0;
                const productDescription = document.getElementById('productDescription').value;
                const productFeatures = document.getElementById('productFeatures').value;
                
                // Generate product ID
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = `PROD-${String(products.length + 1).padStart(3, '0')}`;
                
                // Create product object
                const product = {
                    id: productId,
                    name: productName,
                    icon: productIcon,
                    regularPrice: regularPrice,
                    memberPrice: memberPrice,
                    unit: productUnit,
                    minOrder: minOrder,
                    description: productDescription,
                    features: productFeatures.split('\n').filter(f => f.trim() !== ''),
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save product
                products.push(product);
                localStorage.setItem('pne_products', JSON.stringify(products));
                
                showToast(`Product "${productName}" added successfully!`, 'success');
                addProductModal.hide();
                document.getElementById('addProductForm').reset();
                
                // Reload products
                loadProducts();
                loadProductsIntoSelect();
                loadProductsIntoEditSelect();
            });
            
            // Load products function
            function loadProducts() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productsList = document.getElementById('productsList');
                
                productsList.innerHTML = '';
                
                if (products.length === 0) {
                    productsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No products found</p></div>';
                    return;
                }
                
                products.forEach(product => {
                    const featuresHtml = product.features.map(f => `<div>${f}</div>`).join('');
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'col-md-4 mb-4';
                    productElement.innerHTML = `
                        <div class="product-item">
                            <div class="product-name">${product.icon} ${product.name}</div>
                            <div class="price-tag">Price: RM ${product.regularPrice} ${product.unit}</div>
                            <div class="member-price">Member Price: RM ${product.memberPrice} ${product.unit}</div>
                            ${product.description ? `<div>${product.description}</div>` : ''}
                            ${featuresHtml}
                            ${product.minOrder > 0 ? `<div class="min-order">Minimum Order: ${product.minOrder} ${product.unit}</div>` : ''}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary me-1 admin-only edit-product" data-id="${product.id}">Edit</button>
                                <button class="btn btn-sm btn-outline-danger admin-only delete-product" data-id="${product.id}">Delete</button>
                            </div>
                        </div>
                    `;
                    
                    productsList.appendChild(productElement);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            showToast('Edit product functionality would open here', 'info');
                        } else {
                            showToast('You do not have permission to edit products', 'danger');
                        }
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            const productId = this.getAttribute('data-id');
                            deleteProduct(productId);
                        } else {
                            showToast('You do not have permission to delete products', 'danger');
                        }
                    });
                });
            }
            
            // Delete product function
            function deleteProduct(productId) {
                if (confirm('Are you sure you want to delete this product?')) {
                    let products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                    products = products.filter(p => p.id !== productId);
                    localStorage.setItem('pne_products', JSON.stringify(products));
                    
                    showToast('Product deleted successfully', 'success');
                    loadProducts();
                    loadProductsIntoSelect();
                    loadProductsIntoEditSelect();
                }
            }
            
            // Staff management
            const addStaffBtn = document.getElementById('addStaffBtn');
            const addStaffModal = new bootstrap.Modal(document.getElementById('addStaffModal'));
            const saveStaffBtn = document.getElementById('saveStaffBtn');
            
            addStaffBtn.addEventListener('click', function() {
                // Only allow admin to add staff
                if (currentUser && currentUser.role === 'admin') {
                    addStaffModal.show();
                } else {
                    showToast('You do not have permission to add staff', 'danger');
                }
            });
            
            saveStaffBtn.addEventListener('click', function() {
                // Get form data
                const staffFirstName = document.getElementById('staffFirstName').value;
                const staffLastName = document.getElementById('staffLastName').value;
                const staffName = `${staffFirstName} ${staffLastName}`;
                const staffUsername = document.getElementById('staffUsername').value;
                const staffPassword = document.getElementById('staffPassword').value;
                const staffRole = document.getElementById('staffRole').value;
                
                // Check if username already exists
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                if (users.find(u => u.username === staffUsername)) {
                    showToast('Staff ID already exists', 'danger');
                    return;
                }
                
                // Create user object
                const user = {
                    username: staffUsername,
                    password: staffPassword,
                    name: staffName,
                    role: staffRole,
                    status: 'active',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save user
                users.push(user);
                localStorage.setItem('pne_users', JSON.stringify(users));
                
                showToast(`Staff "${staffName}" added successfully!`, 'success');
                addStaffModal.hide();
                document.getElementById('addStaffForm').reset();
                
                // Reload staff
                loadStaff();
            });
            
            // Load staff function
            function loadStaff() {
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                const staffTable = document.getElementById('staffTable');
                
                staffTable.innerHTML = '';
                
                if (users.length === 0) {
                    staffTable.innerHTML = '<tr><td colspan="6" class="text-center">No staff found</td></tr>';
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.username}</td>
                        <td><span class="user-role ${user.role === 'admin' ? 'role-admin' : 'role-staff'}">${user.role === 'admin' ? 'Admin' : 'Crew'}</span></td>
                        <td><span class="badge bg-${user.status === 'active' ? 'success' : 'danger'}">${user.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1 admin-only edit-staff" data-username="${user.username}">Edit</button>
                            <button class="btn btn-sm btn-outline-danger admin-only delete-staff" data-username="${user.username}">Delete</button>
                        </td>
                    `;
                    
                    staffTable.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-staff').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            showToast('Edit staff functionality would open here', 'info');
                        } else {
                            showToast('You do not have permission to edit staff', 'danger');
                        }
                    });
                });
                
                document.querySelectorAll('.delete-staff').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            const username = this.getAttribute('data-username');
                            deleteStaff(username);
                        } else {
                            showToast('You do not have permission to delete staff', 'danger');
                        }
                    });
                });
            }
            
            // Delete staff function
            function deleteStaff(username) {
                if (confirm('Are you sure you want to delete this staff member?')) {
                    let users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                    users = users.filter(u => u.username !== username);
                    localStorage.setItem('pne_users', JSON.stringify(users));
                    
                    showToast('Staff member deleted successfully', 'success');
                    loadStaff();
                }
            }
            
            // Load dashboard data
            function loadDashboardData() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                
                // Update counters
                document.getElementById('totalCashbills').textContent = cashbills.length;
                document.getElementById('completedCashbills').textContent = cashbills.filter(cb => cb.status === 'committed').length;
                document.getElementById('pendingCashbills').textContent = cashbills.filter(cb => cb.status === 'draft').length;
                
                // Calculate total revenue
                const totalRevenue = cashbills
                    .filter(cb => cb.status === 'committed')
                    .reduce((sum, cb) => sum + cb.totalAmount, 0);
                document.getElementById('totalRevenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
                
                // Load recent cashbills
                const recentCashbillsTable = document.getElementById('recentCashbillsTable');
                recentCashbillsTable.innerHTML = '';
                
                if (cashbills.length === 0) {
                    recentCashbillsTable.innerHTML = '<tr><td colspan="6" class="text-center">No cashbills found</td></tr>';
                    return;
                }
                
                // Sort by date (newest first) and take first 5
                const sortedCashbills = [...cashbills]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5);
                
                sortedCashbills.forEach(cashbill => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cashbill.id}</td>
                        <td>${cashbill.customer.name}</td>
                        <td>${cashbill.date}</td>
                        <td>RM ${cashbill.totalAmount.toFixed(2)}</td>
                        <td><span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary view-cashbill" data-id="${cashbill.id}">View</button>
                        </td>
                    `;
                    
                    recentCashbillsTable.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        viewCashbillDetails(cashbillId);
                    });
                });
            }
            
            // Load cashbill list
            function loadCashbillList() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const allCashbillsTable = document.getElementById('allCashbillsTable');
                
                allCashbillsTable.innerHTML = '';
                
                if (cashbills.length === 0) {
                    allCashbillsTable.innerHTML = '<tr><td colspan="7" class="text-center">No cashbills found</td></tr>';
                    return;
                }
                
                // Sort by date (newest first)
                const sortedCashbills = [...cashbills]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                sortedCashbills.forEach(cashbill => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cashbill.id}</td>
                        <td>${cashbill.customer.name}</td>
                        <td>${cashbill.date}</td>
                        <td>RM ${cashbill.totalAmount.toFixed(2)}</td>
                        <td><span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span></td>
                        <td>${cashbill.createdBy}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-cashbill" data-id="${cashbill.id}">View</button>
                            ${cashbill.status === 'draft' ? `
                                <button class="btn btn-sm btn-warning edit-cashbill" data-id="${cashbill.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-cashbill" data-id="${cashbill.id}">Delete</button>
                            ` : ''}
                            ${cashbill.status === 'draft' && currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-success approve-cashbill" data-id="${cashbill.id}">Approve</button>
                                <button class="btn btn-sm btn-danger reject-cashbill" data-id="${cashbill.id}">Reject</button>
                            ` : ''}
                        </td>
                    `;
                    
                    allCashbillsTable.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        viewCashbillDetails(cashbillId);
                    });
                });
                
                document.querySelectorAll('.edit-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        editCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.delete-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        deleteCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.approve-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        approveCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.reject-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        rejectCashbill(cashbillId);
                    });
                });
                
                // Add filter functionality
                setupCashbillFilters();
            }
            
            // Setup cashbill filters
            function setupCashbillFilters() {
                const searchInput = document.getElementById('searchCashbill');
                const statusFilter = document.getElementById('filterStatus');
                const dateFilter = document.getElementById('filterDate');
                const clearBtn = document.getElementById('clearFiltersBtn');
                
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusValue = statusFilter.value;
                    const dateValue = dateFilter.value;
                    
                    const rows = document.querySelectorAll('#allCashbillsTable tr');
                    
                    rows.forEach(row => {
                        let show = true;
                        
                        // Search filter
                        if (searchTerm && !row.textContent.toLowerCase().includes(searchTerm)) {
                            show = false;
                        }
                        
                        // Status filter
                        if (statusValue) {
                            const statusBadge = row.querySelector('.status-badge');
                            if (statusBadge && !statusBadge.textContent.toLowerCase().includes(statusValue)) {
                                show = false;
                            }
                        }
                        
                        // Date filter
                        if (dateValue) {
                            const dateCell = row.cells[2];
                            if (dateCell && dateCell.textContent !== dateValue) {
                                show = false;
                            }
                        }
                        
                        row.style.display = show ? '' : 'none';
                    });
                }
                
                searchInput.addEventListener('input', applyFilters);
                statusFilter.addEventListener('change', applyFilters);
                dateFilter.addEventListener('change', applyFilters);
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    statusFilter.value = '';
                    dateFilter.value = '';
                    applyFilters();
                });
            }
            
            // Load logbook list
            function loadLogbookList() {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const allLogbooksTable = document.getElementById('allLogbooksTable');
                
                allLogbooksTable.innerHTML = '';
                
                if (logbooks.length === 0) {
                    allLogbooksTable.innerHTML = '<tr><td colspan="7" class="text-center">No logbooks found</td></tr>';
                    return;
                }
                
                // Sort by date (newest first)
                const sortedLogbooks = [...logbooks]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                sortedLogbooks.forEach(logbook => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${logbook.id}</td>
                        <td>${logbook.cashbillRef}</td>
                        <td>${logbook.courierName}</td>
                        <td>${logbook.date}</td>
                        <td><span class="status-badge status-${logbook.deliveryStatus}">${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</span></td>
                        <td>${logbook.trackingNumber || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-logbook" data-id="${logbook.id}">View</button>
                        </td>
                    `;
                    
                    allLogbooksTable.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-logbook').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const logbookId = this.getAttribute('data-id');
                        viewLogbookDetails(logbookId);
                    });
                });
                
                // Add filter functionality
                setupLogbookFilters();
            }
            
            // Setup logbook filters
            function setupLogbookFilters() {
                const searchInput = document.getElementById('searchLogbook');
                const statusFilter = document.getElementById('filterDeliveryStatus');
                const dateFilter = document.getElementById('filterLogbookDate');
                const clearBtn = document.getElementById('clearLogbookFiltersBtn');
                
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusValue = statusFilter.value;
                    const dateValue = dateFilter.value;
                    
                    const rows = document.querySelectorAll('#allLogbooksTable tr');
                    
                    rows.forEach(row => {
                        let show = true;
                        
                        // Search filter
                        if (searchTerm && !row.textContent.toLowerCase().includes(searchTerm)) {
                            show = false;
                        }
                        
                        // Status filter
                        if (statusValue) {
                            const statusBadge = row.querySelector('.status-badge');
                            if (statusBadge && !statusBadge.textContent.toLowerCase().includes(statusValue.replace('-', ' '))) {
                                show = false;
                            }
                        }
                        
                        // Date filter
                        if (dateValue) {
                            const dateCell = row.cells[3];
                            if (dateCell && dateCell.textContent !== dateValue) {
                                show = false;
                            }
                        }
                        
                        row.style.display = show ? '' : 'none';
                    });
                }
                
                searchInput.addEventListener('input', applyFilters);
                statusFilter.addEventListener('change', applyFilters);
                dateFilter.addEventListener('change', applyFilters);
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    statusFilter.value = '';
                    dateFilter.value = '';
                    applyFilters();
                });
            }
            
            // Update cashbill reference dropdown
            function updateCashbillRef() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbillRef = document.getElementById('cashbillRef');
                
                cashbillRef.innerHTML = '<option value="">-- Select Cashbill --</option>';
                
                cashbills.forEach(cashbill => {
                    const option = document.createElement('option');
                    option.value = cashbill.id;
                    option.textContent = `${cashbill.id} - ${cashbill.customer.name}`;
                    cashbillRef.appendChild(option);
                });
            }
            
            // View cashbill details function
            function viewCashbillDetails(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Set modal title
                document.getElementById('viewCashbillModalLabel').textContent = `Cashbill Details - ${cashbillId}`;
                
                // Populate modal with cashbill details
                const cashbillDetails = document.getElementById('cashbillDetails');
                cashbillDetails.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Cashbill ID:</strong> ${cashbill.id}</p>
                            <p><strong>Customer:</strong> ${cashbill.customer.name}</p>
                            <p><strong>Date:</strong> ${cashbill.date}</p>
                            <p><strong>Phone:</strong> ${cashbill.customer.phone}</p>
                            <p><strong>Email:</strong> ${cashbill.customer.email || '-'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span></p>
                            <p><strong>Created By:</strong> ${cashbill.createdBy}</p>
                            <p><strong>Payment Type:</strong> ${cashbill.payment.type}</p>
                            <p><strong>Payment Status:</strong> ${cashbill.payment.status}</p>
                            <p><strong>Total Amount:</strong> RM ${cashbill.totalAmount.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Address:</strong> ${cashbill.customer.address}</p>
                    </div>
                    
                    ${cashbill.notes ? `<div class="mb-3"><p><strong>Notes:</strong> ${cashbill.notes}</p></div>` : ''}
                    
                    <h5 class="mt-4 mb-3">Order Items</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cashbill.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>RM ${item.price.toFixed(2)}</td>
                                        <td>RM ${(item.quantity * item.price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td><strong>RM ${cashbill.totalAmount.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Show modal
                const viewCashbillModal = new bootstrap.Modal(document.getElementById('viewCashbillModal'));
                viewCashbillModal.show();
            }
            
            // View logbook details function
            function viewLogbookDetails(logbookId) {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const logbook = logbooks.find(lb => lb.id === logbookId);
                
                if (!logbook) {
                    showToast('Logbook not found', 'danger');
                    return;
                }
                
                // Set modal title
                document.getElementById('viewLogbookModalLabel').textContent = `Logbook Details - ${logbookId}`;
                
                // Populate modal with logbook details
                const logbookDetails = document.getElementById('logbookDetails');
                logbookDetails.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Logbook ID:</strong> ${logbook.id}</p>
                            <p><strong>Cashbill Ref:</strong> ${logbook.cashbillRef}</p>
                            <p><strong>Date:</strong> ${logbook.date}</p>
                            <p><strong>Courier Name:</strong> ${logbook.courierName}</p>
                            <p><strong>Tracking Number:</strong> ${logbook.trackingNumber || '-'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Delivery Status:</strong> <span class="status-badge status-${logbook.deliveryStatus}">${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</span></p>
                            <p><strong>Expected Delivery Date:</strong> ${logbook.expectedDelivery.date || '-'}</p>
                            <p><strong>Expected Delivery Time:</strong> ${logbook.expectedDelivery.time || '-'}</p>
                            <p><strong>Created By:</strong> ${logbook.createdBy}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Delivery Address:</strong> ${logbook.deliveryAddress}</p>
                    </div>
                    
                    ${logbook.notes ? `<div class="mb-3"><p><strong>Notes:</strong> ${logbook.notes}</p></div>` : ''}
                `;
                
                // Show modal
                const viewLogbookModal = new bootstrap.Modal(document.getElementById('viewLogbookModal'));
                viewLogbookModal.show();
            }
            
            // Print cashbill button
            document.getElementById('printCashbillBtn').addEventListener('click', function() {
                const cashbillId = document.querySelector('#viewCashbillModal .modal-title').textContent.split(' - ')[1];
                printCashbill(cashbillId);
            });
            
            // Print logbook button
            document.getElementById('printLogbookBtn').addEventListener('click', function() {
                const logbookId = document.querySelector('#viewLogbookModal .modal-title').textContent.split(' - ')[1];
                printLogbook(logbookId);
            });
            
            // Print cashbill function
            function printCashbill(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Populate print template
                document.getElementById('printCashbillInfo').innerHTML = `
                    <p><strong>Cashbill ID:</strong> ${cashbill.id}</p>
                    <p><strong>Date:</strong> ${cashbill.date}</p>
                    <p><strong>Status:</strong> ${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</p>
                `;
                
                document.getElementById('printCustomerInfo').innerHTML = `
                    <p><strong>Name:</strong> ${cashbill.customer.name}</p>
                    <p><strong>Phone:</strong> ${cashbill.customer.phone}</p>
                    <p><strong>Email:</strong> ${cashbill.customer.email || '-'}</p>
                    <p><strong>Address:</strong> ${cashbill.customer.address}</p>
                `;
                
                const itemsHtml = cashbill.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>RM ${item.price.toFixed(2)}</td>
                        <td>RM ${(item.quantity * item.price).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                document.getElementById('printOrderItems').innerHTML = `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td><strong>RM ${cashbill.totalAmount.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                
                document.getElementById('printPaymentInfo').innerHTML = `
                    <p><strong>Payment Type:</strong> ${cashbill.payment.type}</p>
                    <p><strong>Payment Status:</strong> ${cashbill.payment.status}</p>
                `;
                
                // Print the document
                window.print();
            }
            
            // Print logbook function
            function printLogbook(logbookId) {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const logbook = logbooks.find(lb => lb.id === logbookId);
                
                if (!logbook) {
                    showToast('Logbook not found', 'danger');
                    return;
                }
                
                // Create a simple print window
                const printContent = `
                    <html>
                    <head>
                        <title>Logbook - ${logbook.id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2c3e50; }
                            .section { margin-bottom: 20px; }
                            .label { font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <h1>Logbook Details</h1>
                        <div class="section">
                            <p><span class="label">Logbook ID:</span> ${logbook.id}</p>
                            <p><span class="label">Cashbill Ref:</span> ${logbook.cashbillRef}</p>
                            <p><span class="label">Date:</span> ${logbook.date}</p>
                            <p><span class="label">Courier Name:</span> ${logbook.courierName}</p>
                            <p><span class="label">Tracking Number:</span> ${logbook.trackingNumber || '-'}</p>
                            <p><span class="label">Delivery Status:</span> ${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</p>
                            <p><span class="label">Expected Delivery Date:</span> ${logbook.expectedDelivery.date || '-'}</p>
                            <p><span class="label">Expected Delivery Time:</span> ${logbook.expectedDelivery.time || '-'}</p>
                        </div>
                        <div class="section">
                            <p><span class="label">Delivery Address:</span></p>
                            <p>${logbook.deliveryAddress}</p>
                        </div>
                        ${logbook.notes ? `
                        <div class="section">
                            <p><span class="label">Notes:</span></p>
                            <p>${logbook.notes}</p>
                        </div>
                        ` : ''}
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }
            
            // Uncommitted requests functionality
            function refreshUncommittedList() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const uncommittedList = document.getElementById('uncommittedList');
                
                // Get draft cashbills
                const draftCashbills = cashbills.filter(cb => cb.status === 'draft');
                
                if (draftCashbills.length === 0) {
                    uncommittedList.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No uncommitted requests found</p>
                        </div>
                    `;
                    return;
                }
                
                uncommittedList.innerHTML = '';
                
                draftCashbills.forEach(cashbill => {
                    const itemsText = cashbill.items.map(item => 
                        `${item.name} (${item.quantity}x)`
                    ).join(', ');
                    
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card uncommitted-card mb-3';
                    cardElement.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${cashbill.id} - ${cashbill.customer.name}</span>
                            <span class="status-badge status-draft">Draft</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${cashbill.date}</p>
                                    <p><strong>Created by:</strong> ${cashbill.createdBy}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Amount:</strong> RM ${cashbill.totalAmount.toFixed(2)}</p>
                                    <p><strong>Items:</strong> ${itemsText}</p>
                                </div>
                            </div>
                            <div class="action-buttons mt-3">
                                <button class="btn btn-sm btn-primary view-uncommitted" data-id="${cashbill.id}">View Details</button>
                                <button class="btn btn-sm btn-warning edit-uncommitted" data-id="${cashbill.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-uncommitted" data-id="${cashbill.id}">Delete</button>
                                <button class="btn btn-sm btn-success approve-uncommitted" data-id="${cashbill.id}">Approve</button>
                                <button class="btn btn-sm btn-danger reject-uncommitted" data-id="${cashbill.id}">Reject</button>
                            </div>
                        </div>
                    `;
                    
                    uncommittedList.appendChild(cardElement);
                });
                
                // Add event listeners to the buttons
                document.querySelectorAll('.view-uncommitted').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        viewCashbillDetails(cashbillId);
                    });
                });
                
                document.querySelectorAll('.edit-uncommitted').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        editCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.delete-uncommitted').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        deleteCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.approve-uncommitted').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        approveCashbill(cashbillId);
                    });
                });
                
                document.querySelectorAll('.reject-uncommitted').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        rejectCashbill(cashbillId);
                    });
                });
            }
            
            // Approve cashbill function
            function approveCashbill(cashbillId) {
                if (confirm(`Are you sure you want to approve cashbill ${cashbillId}?`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    const cashbill = cashbills.find(cb => cb.id === cashbillId);
                    
                    if (cashbill) {
                        cashbill.status = 'committed';
                        cashbill.updatedAt = new Date().toISOString();
                        localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                        
                        showToast(`Cashbill ${cashbillId} approved successfully!`, 'success');
                        
                        // Refresh data
                        loadDashboardData();
                        loadCashbillList();
                        refreshUncommittedList();
                        updateCounters();
                    }
                }
            }
            
            // Reject cashbill function
            function rejectCashbill(cashbillId) {
                if (confirm(`Are you sure you want to reject cashbill ${cashbillId}?`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    cashbills = cashbills.filter(cb => cb.id !== cashbillId);
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    showToast(`Cashbill ${cashbillId} rejected!`, 'warning');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            }
            
            // Update counters function
            function updateCounters() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                
                document.getElementById('totalCashbills').textContent = cashbills.length;
                document.getElementById('completedCashbills').textContent = cashbills.filter(cb => cb.status === 'committed').length;
                document.getElementById('pendingCashbills').textContent = cashbills.filter(cb => cb.status === 'draft').length;
                
                const totalRevenue = cashbills
                    .filter(cb => cb.status === 'committed')
                    .reduce((sum, cb) => sum + cb.totalAmount, 0);
                document.getElementById('totalRevenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
            }
            
            // Generate new cashbill ID
            function generateNewCashbillId() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const counter = cashbills.length + 1;
                document.getElementById('cashbillId').value = `#PA${String(counter).padStart(4, '0')}`;
            }
            
            // Generate new logbook ID
            function generateNewLogbookId() {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const counter = logbooks.length + 1;
                document.getElementById('logbookId').value = `LOG-${String(counter).padStart(4, '0')}`;
            }
            
            // Generate report buttons
            document.querySelectorAll('.generate-report').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-type');
                    showToast(`Generating ${reportType} report...`, 'info');
                    
                    // In a real app, this would generate and download a report
                    setTimeout(() => {
                        showToast(`${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report generated successfully!`, 'success');
                    }, 1500);
                });
            });
            
            // Initialize data storage
            function initializeDataStorage() {
                // Check if users exist, if not create default users
                if (!localStorage.getItem('pne_users')) {
                    const defaultUsers = [
                        {
                            username: '0000',
                            password: 'Dd123',
                            name: 'Admin User',
                            role: 'admin',
                            status: 'active',
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            username: '0001',
                            password: '1234',
                            name: 'Crew One',
                            role: 'staff',
                            status: 'active',
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('pne_users', JSON.stringify(defaultUsers));
                }
                
                // Check if products exist, if not create default products
                if (!localStorage.getItem('pne_products')) {
                    const defaultProducts = [
                        {
                            id: 'PROD-001',
                            name: 'Adult Jubah',
                            icon: '',
                            regularPrice: 250,
                            memberPrice: 220,
                            unit: 'per set',
                            minOrder: 0,
                            description: 'High-quality adult jubah for special occasions',
                            features: ['Free: Cap included', 'Available in multiple sizes', 'Premium fabric'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-002',
                            name: 'Year 6 Jubah',
                            icon: '',
                            regularPrice: 170,
                            memberPrice: 150,
                            unit: 'per set',
                            minOrder: 10,
                            description: 'Comfortable jubah for Year 6 students',
                            features: ['Free: Cap included', 'School colors available', 'Durable material'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-003',
                            name: 'Kindergarten Jubah',
                            icon: '',
                            regularPrice: 110,
                            memberPrice: 99,
                            unit: 'per set',
                            minOrder: 10,
                            description: 'Cute jubah for kindergarten children',
                            features: ['Free: Cap included', 'Child-friendly design', 'Easy to wear'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-004',
                            name: 'Plaque Arkalic',
                            icon: '',
                            regularPrice: 19.90,
                            memberPrice: 17.50,
                            unit: 'each',
                            minOrder: 0,
                            description: 'Customizable plaque for achievements',
                            features: ['Includes: Name printing', 'Size: 145mm x 100mm', 'High-quality finish'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-005',
                            name: 'Cute Medal',
                            icon: '',
                            regularPrice: 12.90,
                            memberPrice: 10.90,
                            unit: 'each',
                            minOrder: 10,
                            description: 'Adorable medals for events',
                            features: ['Material: Arkalic', 'Custom design available', 'Ribbon included'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-006',
                            name: 'Cute Keychain',
                            icon: '',
                            regularPrice: 5.90,
                            memberPrice: 3.90,
                            unit: 'each',
                            minOrder: 10,
                            description: 'Fun keychains for everyone',
                            features: ['Material: Arkalic (Sublimation)', 'Size: 9cm x 3cm', 'Waterproof'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-007',
                            name: 'Attendance Keychain',
                            icon: '',
                            regularPrice: 4.90,
                            memberPrice: 3.50,
                            unit: 'each',
                            minOrder: 10,
                            description: 'Practical keychain for attendance tracking',
                            features: ['Material: Acrylic', 'Thickness: 2mm', 'Size: 4.4cm x 5.5cm'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-008',
                            name: 'Kindergarten T-Shirt',
                            icon: '',
                            regularPrice: 29.90,
                            memberPrice: 25.00,
                            unit: 'per piece',
                            minOrder: 20,
                            description: 'Comfortable t-shirt for kindergarten',
                            features: ['Material: Microfiber', 'Free: School name & logo printing', 'Breathable fabric'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-009',
                            name: 'Kindergarten T-Shirt + Pants Set',
                            icon: '',
                            regularPrice: 45.00,
                            memberPrice: 39.90,
                            unit: 'per set',
                            minOrder: 20,
                            description: 'Complete set for kindergarten students',
                            features: ['Material: Microfiber + Tracksuit', 'Matching set', 'Comfortable fit'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('pne_products', JSON.stringify(defaultProducts));
                }
                
                // Initialize empty arrays for cashbills and logbooks if they don't exist
                if (!localStorage.getItem('pne_cashbills')) {
                    localStorage.setItem('pne_cashbills', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('pne_logbooks')) {
                    localStorage.setItem('pne_logbooks', JSON.stringify([]));
                }
            }
            
            // Toast notification function
            function showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast, {
                    autohide: true,
                    delay: 3000
                });
                
                bsToast.show();
                
                // Remove toast element after it's hidden
                toast.addEventListener('hidden.bs.toast', function() {
                    toast.remove();
                });
            }
            
            // Initialize the application
            loadProductsIntoSelect();
            loadProductsIntoEditSelect();
        });
    </script>
</body>
</html>
