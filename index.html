<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNE Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-grey: #f5f5f5;
            --secondary-grey: #e0e0e0;
            --dark-grey: #757575;
            --soft-black: #333333;
            --light-black: #424242;
            --accent-color: #6200ea;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-grey);
            color: var(--soft-black);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Login Screen Styles */
        .login-screen {
            padding: 40px;
            text-align: center;
        }

        .login-screen h1 {
            color: var(--soft-black);
            margin-bottom: 30px;
            font-size: 2.2rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 350px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .form-group label {
            margin-bottom: 5px;
            color: var(--dark-grey);
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 1px solid var(--secondary-grey);
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #5a0bcc;
        }

        .btn-secondary {
            background-color: var(--dark-grey);
        }

        .btn-secondary:hover {
            background-color: #616161;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* Portal Styles */
        .portal {
            display: none;
        }

        .portal-header {
            background-color: var(--soft-black);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .portal-title {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-weight: 500;
        }

        .portal-nav {
            display: flex;
            background-color: var(--light-black);
            color: white;
        }

        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item:last-child {
            border-right: none;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: var(--accent-color);
        }

        .portal-content {
            padding: 30px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--secondary-grey);
            padding-bottom: 15px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--soft-black);
        }

        /* Cashbill Form Styles */
        .cashbill-form {
            background-color: var(--primary-grey);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: var(--soft-black);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Items Table Styles */
        .items-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .items-table th {
            background-color: var(--light-black);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
        }

        .items-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .item-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--secondary-grey);
            border-radius: 4px;
        }

        .quantity-input {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--secondary-grey);
            border-radius: 4px;
            text-align: center;
        }

        .tax-input {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--secondary-grey);
            border-radius: 4px;
            text-align: center;
        }

        .price-input {
            width: 100px;
            padding: 8px;
            border: 1px solid var(--secondary-grey);
            border-radius: 4px;
            text-align: right;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        .add-item-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        /* Payment Section */
        .payment-types {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .payment-type {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--secondary-grey);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-type:hover {
            border-color: var(--accent-color);
        }

        .payment-type.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .payment-type i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        /* Summary Section */
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 1px solid var(--secondary-grey);
            padding-top: 10px;
            margin-top: 10px;
        }

        /* Cashbill List Styles */
        .cashbill-list {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--secondary-grey);
        }

        .cashbill-item {
            padding: 20px;
            border-bottom: 1px solid var(--secondary-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cashbill-item:last-child {
            border-bottom: none;
        }

        .cashbill-info {
            flex: 1;
        }

        .cashbill-id {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cashbill-details {
            color: var(--dark-grey);
            font-size: 0.9rem;
        }

        .cashbill-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 15px;
        }

        .status-committed {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .status-pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }

        .status-reversed {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .status-amendment {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }

        .cashbill-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--dark-grey);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background-color: var(--primary-grey);
            color: var(--accent-color);
        }

        /* Crew Profile Styles */
        .crew-profile {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid var(--secondary-grey);
            margin-bottom: 25px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-info p {
            color: var(--dark-grey);
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark-grey);
        }

        .detail-value {
            padding: 10px;
            background-color: var(--primary-grey);
            border-radius: 5px;
        }

        /* Courier Logbook Styles */
        .logbook-form {
            background-color: var(--primary-grey);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .logbook-list {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--secondary-grey);
        }

        .logbook-item {
            padding: 20px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .logbook-item:last-child {
            border-bottom: none;
        }

        .logbook-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .logbook-id {
            font-weight: 600;
        }

        .logbook-date {
            color: var(--dark-grey);
            font-size: 0.9rem;
        }

        .logbook-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .logbook-detail {
            display: flex;
            flex-direction: column;
        }

        .logbook-label {
            font-size: 0.8rem;
            color: var(--dark-grey);
            margin-bottom: 3px;
        }

        .logbook-value {
            font-weight: 500;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transform: translateX(200%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--soft-black);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-grey);
        }

        .close-btn:hover {
            color: var(--soft-black);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Cashbill Detail Styles */
        .cashbill-detail {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid var(--secondary-grey);
        }

        .cashbill-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .cashbill-detail-title {
            font-size: 1.5rem;
            color: var(--soft-black);
        }

        .cashbill-detail-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section-title {
            font-size: 1.2rem;
            color: var(--soft-black);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--dark-grey);
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .detail-table th {
            background-color: var(--light-black);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 500;
        }

        .detail-table td {
            padding: 10px;
            border-bottom: 1px solid var(--secondary-grey);
        }

        .detail-table tr:last-child td {
            border-bottom: none;
        }

        .detail-summary {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .detail-summary-table {
            width: 300px;
        }

        .detail-summary-table td {
            padding: 8px;
        }

        .detail-summary-table td:first-child {
            text-align: left;
        }

        .detail-summary-table td:last-child {
            text-align: right;
            font-weight: 500;
        }

        .detail-summary-table tr.total td {
            font-weight: 700;
            font-size: 1.1rem;
            border-top: 1px solid var(--secondary-grey);
            padding-top: 10px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .payment-types {
                flex-direction: column;
            }
            
            .items-table-container {
                overflow-x: scroll;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .cashbill-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cashbill-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-summary {
                justify-content: flex-start;
            }
            
            .detail-summary-table {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <h1><i class="fas fa-cash-register"></i> Portal A</h1>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="userId">User ID</label>
                    <input type="text" id="userId" placeholder="Enter your ID" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>

        <!-- Portal -->
        <div class="portal" id="portal">
            <div class="portal-header">
                <div class="portal-title">Portal A</div>
                <div class="user-info">
                    <span id="userName">User</span>
                    <span id="userRole">Role</span>
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                </div>
            </div>
            
            <div class="portal-nav">
                <div class="nav-item active" data-section="cashbill">
                    <i class="fas fa-file-invoice-dollar"></i> Cashbill
                </div>
                <div class="nav-item" data-section="crewProfile">
                    <i class="fas fa-user-tie"></i> Crew Profile
                </div>
                <div class="nav-item" data-section="courierLogbook">
                    <i class="fas fa-clipboard-list"></i> Courier Logbook
                </div>
            </div>
            
            <div class="portal-content">
                <!-- Cashbill Section -->
                <div class="content-section active" id="cashbillSection">
                    <div class="section-header">
                        <h2 class="section-title">Cashbill Management</h2>
                        <button class="btn" id="newCashbillBtn">New Cashbill</button>
                    </div>
                    
                    <div class="cashbill-list" id="cashbillList">
                        <!-- Cashbill items will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Crew Profile Section -->
                <div class="content-section" id="crewProfileSection">
                    <div class="section-header">
                        <h2 class="section-title">Crew Profile</h2>
                        <button class="btn" id="editProfileBtn">Edit Profile</button>
                    </div>
                    
                    <div class="crew-profile" id="crewProfile">
                        <!-- Crew profile will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Courier Logbook Section -->
                <div class="content-section" id="courierLogbookSection">
                    <div class="section-header">
                        <h2 class="section-title">Courier Logbook</h2>
                        <button class="btn" id="newLogbookBtn">New Logbook Entry</button>
                    </div>
                    
                    <div class="logbook-list" id="logbookList">
                        <!-- Logbook entries will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Cashbill Modal -->
    <div class="modal" id="newCashbillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Cashbill</h3>
                <button class="close-btn" id="closeCashbillModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cashbillForm">
                    <!-- Customer Information Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-user"></i> Customer Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerFirstName">First Name</label>
                                <input type="text" id="customerFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerLastName">Last Name</label>
                                <input type="text" id="customerLastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerPhone">Phone Number</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="customerEmail">Email</label>
                                <input type="email" id="customerEmail" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <textarea id="customerAddress" rows="2" placeholder="Enter customer address"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-box"></i> Items
                        </h3>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>SNO</th>
                                        <th>Qty</th>
                                        <th>Desc / Serial No / IMEI</th>
                                        <th>Tax %</th>
                                        <th>Unit Price (MYR)</th>
                                        <th>Total Excl Tax (MYR)</th>
                                        <th>Total Tax (MYR)</th>
                                        <th>Adj Total (MYR)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <!-- Payment Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-credit-card"></i> Payment Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Type</label>
                                <div class="payment-types">
                                    <div class="payment-type" data-payment="cash">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>Cash</div>
                                    </div>
                                    <div class="payment-type" data-payment="card">
                                        <i class="fas fa-credit-card"></i>
                                        <div>Card</div>
                                    </div>
                                    <div class="payment-type" data-payment="ewallet">
                                        <i class="fas fa-mobile-alt"></i>
                                        <div>E-Wallet</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Total Amount (MYR)</label>
                                <input type="text" id="totalAmount" readonly value="0.00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-calculator"></i> Summary
                        </h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span id="tax">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span id="discount">MYR 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="total">MYR 0.00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCashbillBtn">Cancel</button>
                <button class="btn" id="saveCashbillBtn">Save Draft</button>
                <button class="btn btn-success" id="commitCashbillBtn">Commit</button>
            </div>
        </div>
    </div>

    <!-- Cashbill Detail Modal -->
    <div class="modal" id="cashbillDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cashbill Details</h3>
                <button class="close-btn" id="closeCashbillDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cashbill-detail" id="cashbillDetail">
                    <!-- Cashbill details will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="action-buttons" id="cashbillActionButtons">
                    <!-- Action buttons will be populated by JavaScript -->
                </div>
                <button class="btn btn-secondary" id="closeDetailBtn">Close</button>
                <button class="btn" id="printDetailBtn">Print Invoice</button>
            </div>
        </div>
    </div>

    <!-- Edit Cashbill Modal -->
    <div class="modal" id="editCashbillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Cashbill</h3>
                <button class="close-btn" id="closeEditCashbillModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCashbillForm">
                    <!-- Customer Information Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-user"></i> Customer Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCustomerFirstName">First Name</label>
                                <input type="text" id="editCustomerFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomerLastName">Last Name</label>
                                <input type="text" id="editCustomerLastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCustomerPhone">Phone Number</label>
                                <input type="tel" id="editCustomerPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomerEmail">Email</label>
                                <input type="email" id="editCustomerEmail" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editCustomerAddress">Address</label>
                            <textarea id="editCustomerAddress" rows="2" placeholder="Enter customer address"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-box"></i> Items
                        </h3>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>SNO</th>
                                        <th>Qty</th>
                                        <th>Desc / Serial No / IMEI</th>
                                        <th>Tax %</th>
                                        <th>Unit Price (MYR)</th>
                                        <th>Total Excl Tax (MYR)</th>
                                        <th>Total Tax (MYR)</th>
                                        <th>Adj Total (MYR)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="editItemsTableBody">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="editAddItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <!-- Payment Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-credit-card"></i> Payment Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Type</label>
                                <div class="payment-types" id="editPaymentTypes">
                                    <div class="payment-type" data-payment="cash">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>Cash</div>
                                    </div>
                                    <div class="payment-type" data-payment="card">
                                        <i class="fas fa-credit-card"></i>
                                        <div>Card</div>
                                    </div>
                                    <div class="payment-type" data-payment="ewallet">
                                        <i class="fas fa-mobile-alt"></i>
                                        <div>E-Wallet</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Total Amount (MYR)</label>
                                <input type="text" id="editTotalAmount" readonly value="0.00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-calculator"></i> Summary
                        </h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="editSubtotal">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span id="editTax">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span id="editDiscount">MYR 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="editTotal">MYR 0.00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCashbillBtn">Cancel</button>
                <button class="btn btn-success" id="saveEditCashbillBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="close-btn" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileFirstName">First Name</label>
                            <input type="text" id="profileFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="profileLastName">Last Name</label>
                            <input type="text" id="profileLastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileEmail">Email</label>
                            <input type="email" id="profileEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Phone</label>
                            <input type="tel" id="profilePhone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profileOutlet">Outlet Location</label>
                        <input type="text" id="profileOutlet" required>
                    </div>
                    <div class="form-group">
                        <label for="profilePassword">New Password (leave blank to keep current)</label>
                        <input type="password" id="profilePassword">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                <button class="btn" id="saveProfileBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- New Logbook Modal -->
    <div class="modal" id="newLogbookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Courier Logbook Entry</h3>
                <button class="close-btn" id="closeLogbookModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="logbookForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookFirstName">First Name</label>
                            <input type="text" id="logbookFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookLastName">Last Name</label>
                            <input type="text" id="logbookLastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookPhone">Phone Number</label>
                            <input type="tel" id="logbookPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookEmail">Email</label>
                            <input type="email" id="logbookEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookAddress">Address</label>
                            <input type="text" id="logbookAddress" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookCity">City</label>
                            <input type="text" id="logbookCity" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="logbookNotes">Notes</label>
                        <textarea id="logbookNotes" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--secondary-grey); border-radius: 5px; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLogbookBtn">Cancel</button>
                <button class="btn" id="saveLogbookBtn">Save Entry</button>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal" id="approvalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approval Required</h3>
                <button class="close-btn" id="closeApprovalModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="approvalMessage">Action requires admin approval.</p>
                <div class="form-group">
                    <label for="crewId">Crew ID</label>
                    <input type="text" id="crewId" placeholder="Enter your crew ID">
                </div>
                <div class="form-group">
                    <label for="crewPassword">Crew Password</label>
                    <input type="password" id="crewPassword" placeholder="Enter your password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelApprovalBtn">Cancel</button>
                <button class="btn btn-warning" id="requestApprovalBtn">Request Approval</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Data
        const users = [
            { id: '0000', password: 'Dd123', firstName: 'Danial', lastName: 'Danish', role: 'admin', email: 'danial@example.com', phone: '0123456789', outlet: 'Head Office' },
            { id: '1001', password: '0000', firstName: 'John', lastName: 'Doe', role: 'crew', email: 'john@example.com', phone: '0123456788', outlet: 'Outlet A' },
            { id: '1002', password: '0000', firstName: 'Jane', lastName: 'Smith', role: 'crew', email: 'jane@example.com', phone: '0123456787', outlet: 'Outlet B' }
        ];

        const itemTypes = [
            {
                id: 'adult-robes',
                name: 'Adult Robes',
                regularPrice: 250,
                memberPrice: 220,
                description: 'Free cap included',
                taxRate: 10
            },
            {
                id: 'year6-robes',
                name: 'Year 6 Robes',
                regularPrice: 170,
                memberPrice: 150,
                description: 'Minimum order: 10 sets, Free cap included',
                taxRate: 10,
                minOrder: 10
            },
            {
                id: 'kindergarten-robes',
                name: 'Kindergarten Robes',
                regularPrice: 110,
                memberPrice: 99,
                description: 'Minimum order: 10 sets, Free cap included',
                taxRate: 10,
                minOrder: 10
            }
        ];

        const promoCodes = {
            "SAVE10": 0.1,
            "WELCOME": 0.15,
            "STUDENT": 0.2
        };

        // State
        let currentUser = null;
        let cashbills = [];
        let logbookEntries = [];
        let selectedItems = [];
        let selectedPayment = null;
        let appliedPromo = null;
        let discount = 0;
        let pendingAction = null;
        let itemCounter = 1;
        let currentEditingCashbill = null;

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const portal = document.getElementById('portal');
        const loginForm = document.getElementById('loginForm');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');
        const cashbillList = document.getElementById('cashbillList');
        const crewProfile = document.getElementById('crewProfile');
        const logbookList = document.getElementById('logbookList');
        const notification = document.getElementById('notification');

        // Modals
        const newCashbillModal = document.getElementById('newCashbillModal');
        const cashbillDetailModal = document.getElementById('cashbillDetailModal');
        const editCashbillModal = document.getElementById('editCashbillModal');
        const editProfileModal = document.getElementById('editProfileModal');
        const newLogbookModal = document.getElementById('newLogbookModal');
        const approvalModal = document.getElementById('approvalModal');

        // Buttons
        const newCashbillBtn = document.getElementById('newCashbillBtn');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const newLogbookBtn = document.getElementById('newLogbookBtn');
        const addItemBtn = document.getElementById('addItemBtn');
        const editAddItemBtn = document.getElementById('editAddItemBtn');

        // Initialize
        function init() {
            // Load data from localStorage
            const savedCashbills = localStorage.getItem('cashbills');
            if (savedCashbills) {
                cashbills = JSON.parse(savedCashbills);
            } else {
                // Initialize with some sample data
                cashbills = [
                    {
                        id: '#PNE0001',
                        customer: { 
                            firstName: 'John', 
                            lastName: 'Doe', 
                            phone: '0123456789', 
                            email: 'john@example.com',
                            address: '123 Main Street, Kuala Lumpur, 50000'
                        },
                        paymentType: 'cash',
                        items: [
                            { 
                                sno: 1, 
                                qty: 2, 
                                description: 'Adult Robes', 
                                taxRate: 10, 
                                unitPrice: 250, 
                                totalExclTax: 500, 
                                totalTax: 50, 
                                adjTotal: 550 
                            }
                        ],
                        subtotal: 500,
                        tax: 50,
                        discount: 0,
                        total: 550,
                        promoCode: null,
                        status: 'committed',
                        createdBy: '1001',
                        createdAt: new Date('2023-05-15').toISOString()
                    },
                    {
                        id: '#PNE0002',
                        customer: { 
                            firstName: 'Jane', 
                            lastName: 'Smith', 
                            phone: '0123456788', 
                            email: 'jane@example.com',
                            address: '456 Jalan Sultan, Petaling Jaya, 46000'
                        },
                        paymentType: 'card',
                        items: [
                            { 
                                sno: 1, 
                                qty: 10, 
                                description: 'Year 6 Robes', 
                                taxRate: 10, 
                                unitPrice: 170, 
                                totalExclTax: 1700, 
                                totalTax: 170, 
                                adjTotal: 1870 
                            }
                        ],
                        subtotal: 1700,
                        tax: 170,
                        discount: 0,
                        total: 1870,
                        promoCode: null,
                        status: 'committed',
                        createdBy: '1002',
                        createdAt: new Date('2023-05-16').toISOString()
                    }
                ];
                saveCashbills();
            }

            const savedLogbook = localStorage.getItem('logbookEntries');
            if (savedLogbook) {
                logbookEntries = JSON.parse(savedLogbook);
            } else {
                logbookEntries = [];
                saveLogbook();
            }

            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            navItems.forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });
            
            newCashbillBtn.addEventListener('click', openNewCashbillModal);
            editProfileBtn.addEventListener('click', openEditProfileModal);
            newLogbookBtn.addEventListener('click', openNewLogbookModal);
            addItemBtn.addEventListener('click', addNewItem);
            editAddItemBtn.addEventListener('click', addEditItem);
            
            // Modal close buttons
            document.getElementById('closeCashbillModal').addEventListener('click', closeNewCashbillModal);
            document.getElementById('closeCashbillDetailModal').addEventListener('click', closeCashbillDetailModal);
            document.getElementById('closeEditCashbillModal').addEventListener('click', closeEditCashbillModal);
            document.getElementById('closeProfileModal').addEventListener('click', closeEditProfileModal);
            document.getElementById('closeLogbookModal').addEventListener('click', closeNewLogbookModal);
            document.getElementById('closeApprovalModal').addEventListener('click', closeApprovalModal);
            
            // Modal cancel buttons
            document.getElementById('cancelCashbillBtn').addEventListener('click', closeNewCashbillModal);
            document.getElementById('closeDetailBtn').addEventListener('click', closeCashbillDetailModal);
            document.getElementById('cancelEditCashbillBtn').addEventListener('click', closeEditCashbillModal);
            document.getElementById('cancelProfileBtn').addEventListener('click', closeEditProfileModal);
            document.getElementById('cancelLogbookBtn').addEventListener('click', closeNewLogbookModal);
            document.getElementById('cancelApprovalBtn').addEventListener('click', closeApprovalModal);
            
            // Modal action buttons
            document.getElementById('saveCashbillBtn').addEventListener('click', saveCashbill);
            document.getElementById('commitCashbillBtn').addEventListener('click', commitCashbill);
            document.getElementById('saveEditCashbillBtn').addEventListener('click', saveEditCashbill);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('saveLogbookBtn').addEventListener('click', saveLogbook);
            document.getElementById('requestApprovalBtn').addEventListener('click', requestApproval);
            document.getElementById('printDetailBtn').addEventListener('click', printCashbillDetail);
            
            // Payment type selection
            document.querySelectorAll('.payment-type').forEach(type => {
                type.addEventListener('click', () => selectPayment(type.dataset.payment));
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const userId = userIdInput.value;
            const password = passwordInput.value;
            
            const user = users.find(u => u.id === userId && u.password === password);
            
            if (user) {
                currentUser = user;
                loginScreen.style.display = 'none';
                portal.style.display = 'block';
                userName.textContent = `${user.firstName} ${user.lastName}`;
                userRole.textContent = user.role === 'admin' ? 'Administrator' : 'Crew';
                
                renderPortal();
                showNotification('Login successful!');
            } else {
                showNotification('Invalid ID or password!', true);
            }
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            loginScreen.style.display = 'block';
            portal.style.display = 'none';
            userIdInput.value = '';
            passwordInput.value = '';
            showNotification('Logged out successfully!');
        }

        // Switch portal section
        function switchSection(section) {
            navItems.forEach(item => item.classList.remove('active'));
            contentSections.forEach(sec => sec.classList.remove('active'));
            
            document.querySelector(`.nav-item[data-section="${section}"]`).classList.add('active');
            document.getElementById(`${section}Section`).classList.add('active');
            
            if (section === 'cashbill') {
                renderCashbills();
            } else if (section === 'crewProfile') {
                renderCrewProfile();
            } else if (section === 'courierLogbook') {
                renderLogbook();
            }
        }

        // Render portal content
        function renderPortal() {
            renderCashbills();
            renderCrewProfile();
            renderLogbook();
        }

        // Render cashbills
        function renderCashbills() {
            cashbillList.innerHTML = '';
            
            if (cashbills.length === 0) {
                cashbillList.innerHTML = '<div class="cashbill-item">No cashbills found</div>';
                return;
            }
            
            cashbills.forEach(bill => {
                const billItem = document.createElement('div');
                billItem.className = 'cashbill-item';
                
                const statusClass = bill.status === 'committed' ? 'status-committed' : 
                                   bill.status === 'pending' ? 'status-pending' : 
                                   bill.status === 'reversed' ? 'status-reversed' : 'status-amendment';
                
                billItem.innerHTML = `
                    <div class="cashbill-info">
                        <div class="cashbill-id">${bill.id}</div>
                        <div class="cashbill-details">
                            ${bill.customer.firstName} ${bill.customer.lastName} • 
                            ${bill.customer.address ? bill.customer.address.split(',')[0] + ', ' + (bill.customer.address.split(',')[1] || '') : ''} • 
                            ${bill.items.length} items • 
                            MYR ${bill.total.toFixed(2)} • 
                            ${new Date(bill.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="cashbill-status ${statusClass}">${bill.status}</div>
                    <div class="cashbill-actions">
                        <button class="icon-btn" onclick="viewCashbill('${bill.id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn" onclick="generatePDF('${bill.id}')" title="Generate PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        ${currentUser.role === 'admin' || bill.createdBy === currentUser.id ? `
                            ${bill.status === 'committed' ? `
                                <button class="icon-btn" onclick="requestAmendment('${bill.id}')" title="Request Amendment">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn" onclick="reverseCashbill('${bill.id}')" title="Reverse">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : ''}
                            ${bill.status === 'amendment' && currentUser.role === 'admin' ? `
                                <button class="icon-btn" onclick="editCashbill('${bill.id}')" title="Edit Cashbill">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            ${bill.status === 'pending' && currentUser.role === 'admin' ? `
                                <button class="icon-btn" onclick="approveReverse('${bill.id}')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        ` : ''}
                    </div>
                `;
                
                cashbillList.appendChild(billItem);
            });
        }

        // Render crew profile
        function renderCrewProfile() {
            crewProfile.innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">
                        ${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}
                    </div>
                    <div class="profile-info">
                        <h2>${currentUser.firstName} ${currentUser.lastName}</h2>
                        <p>${currentUser.role === 'admin' ? 'Administrator' : 'Crew Member'}</p>
                    </div>
                </div>
                <div class="profile-details">
                    <div class="detail-item">
                        <div class="detail-label">User ID</div>
                        <div class="detail-value">${currentUser.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${currentUser.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${currentUser.phone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Outlet Location</div>
                        <div class="detail-value">${currentUser.outlet}</div>
                    </div>
                </div>
            `;
        }

        // Render logbook
        function renderLogbook() {
            logbookList.innerHTML = '';
            
            if (logbookEntries.length === 0) {
                logbookList.innerHTML = '<div class="logbook-item">No logbook entries found</div>';
                return;
            }
            
            logbookEntries.forEach(entry => {
                const logbookItem = document.createElement('div');
                logbookItem.className = 'logbook-item';
                
                logbookItem.innerHTML = `
                    <div class="logbook-header">
                        <div class="logbook-id">${entry.id}</div>
                        <div class="logbook-date">${new Date(entry.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="logbook-details">
                        <div class="logbook-detail">
                            <div class="logbook-label">Name</div>
                            <div class="logbook-value">${entry.firstName} ${entry.lastName}</div>
                        </div>
                        <div class="logbook-detail">
                            <div class="logbook-label">Phone</div>
                            <div class="logbook-value">${entry.phone}</div>
                        </div>
                        <div class="logbook-detail">
                            <div class="logbook-label">Email</div>
                            <div class="logbook-value">${entry.email}</div>
                        </div>
                        <div class="logbook-detail">
                            <div class="logbook-label">Address</div>
                            <div class="logbook-value">${entry.address}, ${entry.city}</div>
                        </div>
                        ${entry.notes ? `
                            <div class="logbook-detail" style="grid-column: 1 / -1;">
                                <div class="logbook-label">Notes</div>
                                <div class="logbook-value">${entry.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                logbookList.appendChild(logbookItem);
            });
        }

        // Open new cashbill modal
        function openNewCashbillModal() {
            // Reset form
            document.getElementById('cashbillForm').reset();
            selectedItems = [];
            selectedPayment = null;
            appliedPromo = null;
            discount = 0;
            itemCounter = 1;
            
            // Clear items table
            document.getElementById('itemsTableBody').innerHTML = '';
            
            // Update totals
            updateTotals();
            
            newCashbillModal.style.display = 'flex';
        }

        // Close new cashbill modal
        function closeNewCashbillModal() {
            newCashbillModal.style.display = 'none';
        }

        // Open cashbill detail modal
        function openCashbillDetailModal(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            const cashbillDetail = document.getElementById('cashbillDetail');
            const cashbillActionButtons = document.getElementById('cashbillActionButtons');
            
            // Get creator info
            const creator = users.find(u => u.id === bill.createdBy) || {};
            
            cashbillDetail.innerHTML = `
                <div class="cashbill-detail-header">
                    <div>
                        <div class="cashbill-detail-title">${bill.id}</div>
                        <div style="color: var(--dark-grey); margin-top: 5px;">
                            Created on ${new Date(bill.createdAt).toLocaleDateString()} at ${new Date(bill.createdAt).toLocaleTimeString()}
                        </div>
                    </div>
                    <div class="cashbill-detail-status status-${bill.status}">${bill.status}</div>
                </div>
                
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fas fa-user"></i> Customer Information
                    </h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">First Name</div>
                            <div class="detail-value">${bill.customer.firstName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Name</div>
                            <div class="detail-value">${bill.customer.lastName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone Number</div>
                            <div class="detail-value">${bill.customer.phone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${bill.customer.email}</div>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${bill.customer.address || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fas fa-box"></i> Items
                    </h3>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>SNO</th>
                                <th>Qty</th>
                                <th>Description</th>
                                <th>Tax %</th>
                                <th>Unit Price (MYR)</th>
                                <th>Total Excl Tax (MYR)</th>
                                <th>Total Tax (MYR)</th>
                                <th>Adj Total (MYR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bill.items.map(item => `
                                <tr>
                                    <td>${item.sno}</td>
                                    <td>${item.qty}</td>
                                    <td>${item.description}</td>
                                    <td>${item.taxRate}%</td>
                                    <td>${item.unitPrice.toFixed(2)}</td>
                                    <td>${item.totalExclTax.toFixed(2)}</td>
                                    <td>${item.totalTax.toFixed(2)}</td>
                                    <td>${item.adjTotal.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fas fa-info-circle"></i> Additional Information
                    </h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Payment Type</div>
                            <div class="detail-value">${bill.paymentType.charAt(0).toUpperCase() + bill.paymentType.slice(1)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created By</div>
                            <div class="detail-value">${creator.firstName || 'Unknown'} ${creator.lastName || ''} (${bill.createdBy})</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Outlet</div>
                            <div class="detail-value">${creator.outlet || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Promo Code</div>
                            <div class="detail-value">${bill.promoCode || 'None'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fas fa-calculator"></i> Payment Summary
                    </h3>
                    <div class="detail-summary">
                        <table class="detail-summary-table">
                            <tr>
                                <td>Subtotal:</td>
                                <td>MYR ${bill.subtotal.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Tax:</td>
                                <td>MYR ${bill.tax.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Discount:</td>
                                <td>MYR ${bill.discount.toFixed(2)}</td>
                            </tr>
                            <tr class="total">
                                <td>Total:</td>
                                <td>MYR ${bill.total.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            // Set action buttons based on user role and bill status
            cashbillActionButtons.innerHTML = '';
            
            if (currentUser.role === 'admin' || bill.createdBy === currentUser.id) {
                if (bill.status === 'committed') {
                    cashbillActionButtons.innerHTML += `
                        <button class="btn btn-warning" onclick="requestAmendment('${bill.id}')">
                            <i class="fas fa-edit"></i> Request Amendment
                        </button>
                        <button class="btn btn-danger" onclick="reverseCashbill('${bill.id}')">
                            <i class="fas fa-undo"></i> Reverse
                        </button>
                    `;
                } else if (bill.status === 'amendment' && currentUser.role === 'admin') {
                    cashbillActionButtons.innerHTML += `
                        <button class="btn" onclick="editCashbill('${bill.id}')">
                            <i class="fas fa-edit"></i> Edit Cashbill
                        </button>
                    `;
                } else if (bill.status === 'pending' && currentUser.role === 'admin') {
                    cashbillActionButtons.innerHTML += `
                        <button class="btn btn-success" onclick="approveReverse('${bill.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                    `;
                }
            }
            
            cashbillDetailModal.style.display = 'flex';
        }

        // Close cashbill detail modal
        function closeCashbillDetailModal() {
            cashbillDetailModal.style.display = 'none';
        }

        // Open edit cashbill modal
        function openEditCashbillModal(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            currentEditingCashbill = bill;
            
            // Populate form with bill data
            document.getElementById('editCustomerFirstName').value = bill.customer.firstName;
            document.getElementById('editCustomerLastName').value = bill.customer.lastName;
            document.getElementById('editCustomerPhone').value = bill.customer.phone;
            document.getElementById('editCustomerEmail').value = bill.customer.email;
            document.getElementById('editCustomerAddress').value = bill.customer.address || '';
            
            // Set payment type
            document.querySelectorAll('#editPaymentTypes .payment-type').forEach(type => {
                type.classList.remove('active');
                if (type.dataset.payment === bill.paymentType) {
                    type.classList.add('active');
                }
            });
            selectedPayment = bill.paymentType;
            
            // Clear and populate items table
            const itemsTableBody = document.getElementById('editItemsTableBody');
            itemsTableBody.innerHTML = '';
            
            bill.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sno}</td>
                    <td>
                        <input type="number" class="quantity-input" min="1" value="${item.qty}" onchange="updateEditItemRow(this)">
                    </td>
                    <td>
                        <select class="item-select" onchange="updateEditItemRow(this)">
                            <option value="">Select an item</option>
                            ${itemTypes.map(type => `
                                <option value="${type.id}" data-regular="${type.regularPrice}" data-member="${type.memberPrice}" data-tax="${type.taxRate}" data-min="${type.minOrder || 0}" ${type.name === item.description ? 'selected' : ''}>
                                    ${type.name} - MYR ${type.regularPrice} (Member: MYR ${type.memberPrice})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="tax-input" min="0" max="100" value="${item.taxRate}" onchange="updateEditItemRow(this)">
                    </td>
                    <td>
                        <input type="number" class="price-input" min="0" step="0.01" value="${item.unitPrice}" onchange="updateEditItemRow(this)">
                    </td>
                    <td class="total-excl-tax">MYR ${item.totalExclTax.toFixed(2)}</td>
                    <td class="total-tax">MYR ${item.totalTax.toFixed(2)}</td>
                    <td class="adj-total">MYR ${item.adjTotal.toFixed(2)}</td>
                    <td>
                        <button class="action-btn" onclick="removeEditItemRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                itemsTableBody.appendChild(row);
            });
            
            // Update totals
            updateEditTotals();
            
            editCashbillModal.style.display = 'flex';
        }

        // Close edit cashbill modal
        function closeEditCashbillModal() {
            editCashbillModal.style.display = 'none';
            currentEditingCashbill = null;
        }

        // Open edit profile modal
        function openEditProfileModal() {
            // Populate form with current user data
            document.getElementById('profileFirstName').value = currentUser.firstName;
            document.getElementById('profileLastName').value = currentUser.lastName;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone;
            document.getElementById('profileOutlet').value = currentUser.outlet;
            document.getElementById('profilePassword').value = '';
            
            editProfileModal.style.display = 'flex';
        }

        // Close edit profile modal
        function closeEditProfileModal() {
            editProfileModal.style.display = 'none';
        }

        // Open new logbook modal
        function openNewLogbookModal() {
            // Reset form
            document.getElementById('logbookForm').reset();
            
            newLogbookModal.style.display = 'flex';
        }

        // Close new logbook modal
        function closeNewLogbookModal() {
            newLogbookModal.style.display = 'none';
        }

        // Open approval modal
        function openApprovalModal(message, action) {
            document.getElementById('approvalMessage').textContent = message;
            document.getElementById('crewId').value = '';
            document.getElementById('crewPassword').value = '';
            pendingAction = action;
            approvalModal.style.display = 'flex';
        }

        // Close approval modal
        function closeApprovalModal() {
            approvalModal.style.display = 'none';
            pendingAction = null;
        }

        // Add new item to table
        function addNewItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${itemCounter}</td>
                <td>
                    <input type="number" class="quantity-input" min="1" value="1" onchange="updateItemRow(this)">
                </td>
                <td>
                    <select class="item-select" onchange="updateItemRow(this)">
                        <option value="">Select an item</option>
                        ${itemTypes.map(item => `
                            <option value="${item.id}" data-regular="${item.regularPrice}" data-member="${item.memberPrice}" data-tax="${item.taxRate}" data-min="${item.minOrder || 0}">
                                ${item.name} - MYR ${item.regularPrice} (Member: MYR ${item.memberPrice})
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="tax-input" min="0" max="100" value="10" onchange="updateItemRow(this)">
                </td>
                <td>
                    <input type="number" class="price-input" min="0" step="0.01" value="0" onchange="updateItemRow(this)">
                </td>
                <td class="total-excl-tax">MYR 0.00</td>
                <td class="total-tax">MYR 0.00</td>
                <td class="adj-total">MYR 0.00</td>
                <td>
                    <button class="action-btn" onclick="removeItemRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            itemCounter++;
        }

        // Add new item to edit table
        function addEditItem() {
            const tableBody = document.getElementById('editItemsTableBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${itemCounter}</td>
                <td>
                    <input type="number" class="quantity-input" min="1" value="1" onchange="updateEditItemRow(this)">
                </td>
                <td>
                    <select class="item-select" onchange="updateEditItemRow(this)">
                        <option value="">Select an item</option>
                        ${itemTypes.map(item => `
                            <option value="${item.id}" data-regular="${item.regularPrice}" data-member="${item.memberPrice}" data-tax="${item.taxRate}" data-min="${item.minOrder || 0}">
                                ${item.name} - MYR ${item.regularPrice} (Member: MYR ${item.memberPrice})
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="tax-input" min="0" max="100" value="10" onchange="updateEditItemRow(this)">
                </td>
                <td>
                    <input type="number" class="price-input" min="0" step="0.01" value="0" onchange="updateEditItemRow(this)">
                </td>
                <td class="total-excl-tax">MYR 0.00</td>
                <td class="total-tax">MYR 0.00</td>
                <td class="adj-total">MYR 0.00</td>
                <td>
                    <button class="action-btn" onclick="removeEditItemRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            itemCounter++;
        }

        // Update item row calculations
        function updateItemRow(element) {
            const row = element.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const itemSelect = row.querySelector('.item-select');
            const selectedItem = itemSelect.options[itemSelect.selectedIndex];
            const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            
            // If an item is selected, update the unit price
            if (selectedItem.value) {
                const regularPrice = parseFloat(selectedItem.dataset.regular);
                const memberPrice = parseFloat(selectedItem.dataset.member);
                const minOrder = parseInt(selectedItem.dataset.min) || 0;
                
                // Check if quantity meets minimum order requirement
                if (quantity < minOrder) {
                    showNotification(`Minimum order for ${selectedItem.text.split(' - ')[0]} is ${minOrder} sets!`, true);
                    row.querySelector('.quantity-input').value = minOrder;
                    return updateItemRow(row.querySelector('.quantity-input'));
                }
                
                // Use member price if available, otherwise regular price
                row.querySelector('.price-input').value = memberPrice || regularPrice;
                return updateItemRow(row.querySelector('.price-input'));
            }
            
            // Calculate totals
            const totalExclTax = quantity * unitPrice;
            const totalTax = totalExclTax * (taxRate / 100);
            const adjTotal = totalExclTax + totalTax;
            
            // Update display
            row.querySelector('.total-excl-tax').textContent = `MYR ${totalExclTax.toFixed(2)}`;
            row.querySelector('.total-tax').textContent = `MYR ${totalTax.toFixed(2)}`;
            row.querySelector('.adj-total').textContent = `MYR ${adjTotal.toFixed(2)}`;
            
            // Update overall totals
            updateTotals();
        }

        // Update edit item row calculations
        function updateEditItemRow(element) {
            const row = element.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const itemSelect = row.querySelector('.item-select');
            const selectedItem = itemSelect.options[itemSelect.selectedIndex];
            const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
            
            // If an item is selected, update the unit price
            if (selectedItem.value) {
                const regularPrice = parseFloat(selectedItem.dataset.regular);
                const memberPrice = parseFloat(selectedItem.dataset.member);
                const minOrder = parseInt(selectedItem.dataset.min) || 0;
                
                // Check if quantity meets minimum order requirement
                if (quantity < minOrder) {
                    showNotification(`Minimum order for ${selectedItem.text.split(' - ')[0]} is ${minOrder} sets!`, true);
                    row.querySelector('.quantity-input').value = minOrder;
                    return updateEditItemRow(row.querySelector('.quantity-input'));
                }
                
                // Use member price if available, otherwise regular price
                row.querySelector('.price-input').value = memberPrice || regularPrice;
                return updateEditItemRow(row.querySelector('.price-input'));
            }
            
            // Calculate totals
            const totalExclTax = quantity * unitPrice;
            const totalTax = totalExclTax * (taxRate / 100);
            const adjTotal = totalExclTax + totalTax;
            
            // Update display
            row.querySelector('.total-excl-tax').textContent = `MYR ${totalExclTax.toFixed(2)}`;
            row.querySelector('.total-tax').textContent = `MYR ${totalTax.toFixed(2)}`;
            row.querySelector('.adj-total').textContent = `MYR ${adjTotal.toFixed(2)}`;
            
            // Update overall totals
            updateEditTotals();
        }

        // Remove item row
        function removeItemRow(button) {
            const row = button.closest('tr');
            row.remove();
            updateTotals();
        }

        // Remove edit item row
        function removeEditItemRow(button) {
            const row = button.closest('tr');
            row.remove();
            updateEditTotals();
        }

        // Update overall totals
        function updateTotals() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let subtotal = 0;
            let totalTax = 0;
            let adjTotal = 0;
            
            rows.forEach(row => {
                const exclTaxText = row.querySelector('.total-excl-tax').textContent;
                const taxText = row.querySelector('.total-tax').textContent;
                const adjText = row.querySelector('.adj-total').textContent;
                
                subtotal += parseFloat(exclTaxText.replace('MYR ', '')) || 0;
                totalTax += parseFloat(taxText.replace('MYR ', '')) || 0;
                adjTotal += parseFloat(adjText.replace('MYR ', '')) || 0;
            });
            
            // Apply discount if any
            const totalAfterDiscount = adjTotal - discount;
            
            // Update display
            document.getElementById('subtotal').textContent = `MYR ${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `MYR ${totalTax.toFixed(2)}`;
            document.getElementById('discount').textContent = `MYR ${discount.toFixed(2)}`;
            document.getElementById('total').textContent = `MYR ${totalAfterDiscount.toFixed(2)}`;
            document.getElementById('totalAmount').value = `MYR ${totalAfterDiscount.toFixed(2)}`;
        }

        // Update edit overall totals
        function updateEditTotals() {
            const rows = document.querySelectorAll('#editItemsTableBody tr');
            let subtotal = 0;
            let totalTax = 0;
            let adjTotal = 0;
            
            rows.forEach(row => {
                const exclTaxText = row.querySelector('.total-excl-tax').textContent;
                const taxText = row.querySelector('.total-tax').textContent;
                const adjText = row.querySelector('.adj-total').textContent;
                
                subtotal += parseFloat(exclTaxText.replace('MYR ', '')) || 0;
                totalTax += parseFloat(taxText.replace('MYR ', '')) || 0;
                adjTotal += parseFloat(adjText.replace('MYR ', '')) || 0;
            });
            
            // Apply discount if any
            const totalAfterDiscount = adjTotal - discount;
            
            // Update display
            document.getElementById('editSubtotal').textContent = `MYR ${subtotal.toFixed(2)}`;
            document.getElementById('editTax').textContent = `MYR ${totalTax.toFixed(2)}`;
            document.getElementById('editDiscount').textContent = `MYR ${discount.toFixed(2)}`;
            document.getElementById('editTotal').textContent = `MYR ${totalAfterDiscount.toFixed(2)}`;
            document.getElementById('editTotalAmount').value = `MYR ${totalAfterDiscount.toFixed(2)}`;
        }

        // Select payment type
        function selectPayment(type) {
            document.querySelectorAll('.payment-type').forEach(el => el.classList.remove('active'));
            document.querySelector(`.payment-type[data-payment="${type}"]`).classList.add('active');
            selectedPayment = type;
        }

        // Save cashbill as draft
        function saveCashbill() {
            const items = getItemsFromTable();
            
            if (items.length === 0) {
                showNotification('Please add at least one item!', true);
                return;
            }
            
            if (!selectedPayment) {
                showNotification('Please select a payment type!', true);
                return;
            }
            
            const firstName = document.getElementById('customerFirstName').value;
            const lastName = document.getElementById('customerLastName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const address = document.getElementById('customerAddress').value;
            
            if (!firstName || !lastName || !phone || !email) {
                showNotification('Please fill in all customer details!', true);
                return;
            }
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
            const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
            const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
            
            // Generate new ID
            const lastId = cashbills.length > 0 ? cashbills[cashbills.length - 1].id : '#PNE0000';
            const newIdNum = parseInt(lastId.substring(4)) + 1;
            const newId = `#PNE${newIdNum.toString().padStart(4, '0')}`;
            
            const newCashbill = {
                id: newId,
                customer: { firstName, lastName, phone, email, address },
                paymentType: selectedPayment,
                items,
                subtotal,
                tax,
                discount,
                total,
                promoCode: appliedPromo,
                status: 'draft',
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            cashbills.push(newCashbill);
            saveCashbills();
            renderCashbills();
            closeNewCashbillModal();
            showNotification('Cashbill saved as draft!');
        }

        // Commit cashbill
        function commitCashbill() {
            const items = getItemsFromTable();
            
            if (items.length === 0) {
                showNotification('Please add at least one item!', true);
                return;
            }
            
            if (!selectedPayment) {
                showNotification('Please select a payment type!', true);
                return;
            }
            
            const firstName = document.getElementById('customerFirstName').value;
            const lastName = document.getElementById('customerLastName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const address = document.getElementById('customerAddress').value;
            
            if (!firstName || !lastName || !phone || !email) {
                showNotification('Please fill in all customer details!', true);
                return;
            }
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
            const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
            const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
            
            // Generate new ID
            const lastId = cashbills.length > 0 ? cashbills[cashbills.length - 1].id : '#PNE0000';
            const newIdNum = parseInt(lastId.substring(4)) + 1;
            const newId = `#PNE${newIdNum.toString().padStart(4, '0')}`;
            
            const newCashbill = {
                id: newId,
                customer: { firstName, lastName, phone, email, address },
                paymentType: selectedPayment,
                items,
                subtotal,
                tax,
                discount,
                total,
                promoCode: appliedPromo,
                status: 'committed',
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            cashbills.push(newCashbill);
            saveCashbills();
            renderCashbills();
            closeNewCashbillModal();
            showNotification('Cashbill committed successfully!');
        }

        // Save edited cashbill
        function saveEditCashbill() {
            if (!currentEditingCashbill) return;
            
            const items = getEditItemsFromTable();
            
            if (items.length === 0) {
                showNotification('Please add at least one item!', true);
                return;
            }
            
            if (!selectedPayment) {
                showNotification('Please select a payment type!', true);
                return;
            }
            
            const firstName = document.getElementById('editCustomerFirstName').value;
            const lastName = document.getElementById('editCustomerLastName').value;
            const phone = document.getElementById('editCustomerPhone').value;
            const email = document.getElementById('editCustomerEmail').value;
            const address = document.getElementById('editCustomerAddress').value;
            
            if (!firstName || !lastName || !phone || !email) {
                showNotification('Please fill in all customer details!', true);
                return;
            }
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
            const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
            const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
            
            // Update cashbill
            currentEditingCashbill.customer = { firstName, lastName, phone, email, address };
            currentEditingCashbill.paymentType = selectedPayment;
            currentEditingCashbill.items = items;
            currentEditingCashbill.subtotal = subtotal;
            currentEditingCashbill.tax = tax;
            currentEditingCashbill.discount = discount;
            currentEditingCashbill.total = total;
            currentEditingCashbill.status = 'committed';
            
            saveCashbills();
            renderCashbills();
            closeEditCashbillModal();
            closeCashbillDetailModal();
            showNotification('Cashbill updated successfully!');
        }

        // Get items from table
        function getItemsFromTable() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            const items = [];
            
            rows.forEach(row => {
                const sno = parseInt(row.cells[0].textContent);
                const qty = parseInt(row.querySelector('.quantity-input').value) || 0;
                const description = row.querySelector('.item-select').options[row.querySelector('.item-select').selectedIndex].text.split(' - ')[0];
                const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                const totalExclTax = parseFloat(row.querySelector('.total-excl-tax').textContent.replace('MYR ', '')) || 0;
                const totalTax = parseFloat(row.querySelector('.total-tax').textContent.replace('MYR ', '')) || 0;
                const adjTotal = parseFloat(row.querySelector('.adj-total').textContent.replace('MYR ', '')) || 0;
                
                if (description && qty > 0) {
                    items.push({
                        sno,
                        qty,
                        description,
                        taxRate,
                        unitPrice,
                        totalExclTax,
                        totalTax,
                        adjTotal
                    });
                }
            });
            
            return items;
        }

        // Get items from edit table
        function getEditItemsFromTable() {
            const rows = document.querySelectorAll('#editItemsTableBody tr');
            const items = [];
            
            rows.forEach(row => {
                const sno = parseInt(row.cells[0].textContent);
                const qty = parseInt(row.querySelector('.quantity-input').value) || 0;
                const description = row.querySelector('.item-select').options[row.querySelector('.item-select').selectedIndex].text.split(' - ')[0];
                const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                const totalExclTax = parseFloat(row.querySelector('.total-excl-tax').textContent.replace('MYR ', '')) || 0;
                const totalTax = parseFloat(row.querySelector('.total-tax').textContent.replace('MYR ', '')) || 0;
                const adjTotal = parseFloat(row.querySelector('.adj-total').textContent.replace('MYR ', '')) || 0;
                
                if (description && qty > 0) {
                    items.push({
                        sno,
                        qty,
                        description,
                        taxRate,
                        unitPrice,
                        totalExclTax,
                        totalTax,
                        adjTotal
                    });
                }
            });
            
            return items;
        }

        // Save profile
        function saveProfile() {
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const email = document.getElementById('profileEmail').value;
            const phone = document.getElementById('profilePhone').value;
            const outlet = document.getElementById('profileOutlet').value;
            const password = document.getElementById('profilePassword').value;
            
            if (!firstName || !lastName || !email || !phone || !outlet) {
                showNotification('Please fill in all required fields!', true);
                return;
            }
            
            // Update current user
            currentUser.firstName = firstName;
            currentUser.lastName = lastName;
            currentUser.email = email;
            currentUser.phone = phone;
            currentUser.outlet = outlet;
            
            if (password) {
                currentUser.password = password;
            }
            
            // Update user in the users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = { ...currentUser };
            }
            
            // Update UI
            userName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            renderCrewProfile();
            closeEditProfileModal();
            showNotification('Profile updated successfully!');
        }

        // Save logbook entry
        function saveLogbook() {
            const firstName = document.getElementById('logbookFirstName').value;
            const lastName = document.getElementById('logbookLastName').value;
            const phone = document.getElementById('logbookPhone').value;
            const email = document.getElementById('logbookEmail').value;
            const address = document.getElementById('logbookAddress').value;
            const city = document.getElementById('logbookCity').value;
            const notes = document.getElementById('logbookNotes').value;
            
            if (!firstName || !lastName || !phone || !email || !address || !city) {
                showNotification('Please fill in all required fields!', true);
                return;
            }
            
            // Generate new ID
            const lastId = logbookEntries.length > 0 ? logbookEntries[logbookEntries.length - 1].id : 'LOG0000';
            const newIdNum = parseInt(lastId.substring(3)) + 1;
            const newId = `LOG${newIdNum.toString().padStart(4, '0')}`;
            
            const newEntry = {
                id: newId,
                firstName,
                lastName,
                phone,
                email,
                address,
                city,
                notes,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            logbookEntries.push(newEntry);
            saveLogbook();
            renderLogbook();
            closeNewLogbookModal();
            showNotification('Logbook entry saved successfully!');
        }

        // View cashbill
        function viewCashbill(id) {
            openCashbillDetailModal(id);
        }

        // Generate PDF
        function generatePDF(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add company header
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('PNE ARENA', 105, 20, { align: 'center' });
            
            // Add invoice title
            doc.setFontSize(18);
            doc.text('INVOICE', 105, 35, { align: 'center' });
            
            // Add cashbill details
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Cashbill No: ${bill.id}`, 20, 55);
            doc.text(`Date: ${new Date(bill.createdAt).toLocaleDateString()}`, 20, 65);
            doc.text(`Status: ${bill.status}`, 20, 75);
            
            // Add customer information
            doc.setFont('helvetica', 'bold');
            doc.text('Bill To:', 20, 95);
            doc.setFont('helvetica', 'normal');
            doc.text(`${bill.customer.firstName} ${bill.customer.lastName}`, 20, 105);
            doc.text(bill.customer.phone, 20, 115);
            doc.text(bill.customer.email, 20, 125);
            
            if (bill.customer.address) {
                const addressLines = doc.splitTextToSize(bill.customer.address, 80);
                doc.text(addressLines, 20, 135);
            }
            
            // Add payment information
            doc.setFont('helvetica', 'bold');
            doc.text('Payment Method:', 120, 95);
            doc.setFont('helvetica', 'normal');
            doc.text(bill.paymentType.charAt(0).toUpperCase() + bill.paymentType.slice(1), 120, 105);
            
            // Add items table
            doc.setFont('helvetica', 'bold');
            doc.text('Description', 20, 165);
            doc.text('Qty', 100, 165);
            doc.text('Unit Price', 130, 165);
            doc.text('Total', 170, 165);
            
            // Add line
            doc.line(20, 170, 190, 170);
            
            // Add items
            doc.setFont('helvetica', 'normal');
            let yPosition = 180;
            
            bill.items.forEach(item => {
                doc.text(item.description, 20, yPosition);
                doc.text(item.qty.toString(), 100, yPosition);
                doc.text(`MYR ${item.unitPrice.toFixed(2)}`, 130, yPosition);
                doc.text(`MYR ${item.adjTotal.toFixed(2)}`, 170, yPosition);
                yPosition += 10;
            });
            
            // Add another line
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 10;
            
            // Add summary
            doc.text('Subtotal:', 130, yPosition);
            doc.text(`MYR ${bill.subtotal.toFixed(2)}`, 170, yPosition);
            yPosition += 10;
            
            doc.text('Tax:', 130, yPosition);
            doc.text(`MYR ${bill.tax.toFixed(2)}`, 170, yPosition);
            yPosition += 10;
            
            doc.text('Discount:', 130, yPosition);
            doc.text(`MYR ${bill.discount.toFixed(2)}`, 170, yPosition);
            yPosition += 10;
            
            // Add total with bold font
            doc.setFont('helvetica', 'bold');
            doc.text('Total:', 130, yPosition);
            doc.text(`MYR ${bill.total.toFixed(2)}`, 170, yPosition);
            
            // Add footer
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Thank you for your business!', 105, 280, { align: 'center' });
            
            // Save the PDF
            doc.save(`PNE_ARENA_${bill.id}_${bill.customer.firstName}_${bill.customer.lastName}.pdf`);
            
            showNotification('Invoice generated successfully!');
        }

        // Print cashbill detail
        function printCashbillDetail() {
            const billId = document.querySelector('.cashbill-detail-title').textContent;
            generatePDF(billId);
        }

        // Request amendment
        function requestAmendment(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            if (currentUser.role === 'admin') {
                // Admin can edit directly
                openEditCashbillModal(id);
                closeCashbillDetailModal();
            } else {
                // Crew needs to request approval
                openApprovalModal(
                    `Amending cashbill ${bill.id} requires admin approval. Please enter your crew credentials to request approval.`,
                    () => {
                        bill.status = 'amendment';
                        saveCashbills();
                        renderCashbills();
                        closeCashbillDetailModal();
                        showNotification(`Amendment request for cashbill ${bill.id} sent to admin!`);
                    }
                );
            }
        }

        // Edit cashbill
        function editCashbill(id) {
            openEditCashbillModal(id);
            closeCashbillDetailModal();
        }

        // Reverse cashbill
        function reverseCashbill(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            if (currentUser.role === 'admin') {
                // Admin can reverse directly
                bill.status = 'reversed';
                saveCashbills();
                renderCashbills();
                closeCashbillDetailModal();
                showNotification(`Cashbill ${bill.id} reversed successfully!`);
            } else {
                // Crew needs to request approval
                openApprovalModal(
                    `Reversing cashbill ${bill.id} requires admin approval. Please enter your crew credentials to request approval.`,
                    () => {
                        bill.status = 'pending';
                        saveCashbills();
                        renderCashbills();
                        closeCashbillDetailModal();
                        showNotification(`Reversal request for cashbill ${bill.id} sent to admin!`);
                    }
                );
            }
        }

        // Approve reverse
        function approveReverse(id) {
            const bill = cashbills.find(b => b.id === id);
            if (!bill) return;
            
            openApprovalModal(
                `Approving reversal of cashbill ${bill.id} requires admin approval.`,
                () => {
                    bill.status = 'reversed';
                    saveCashbills();
                    renderCashbills();
                    closeCashbillDetailModal();
                    showNotification(`Cashbill ${bill.id} reversal approved!`);
                }
            );
        }

        // Request approval
        function requestApproval() {
            const crewId = document.getElementById('crewId').value;
            const crewPassword = document.getElementById('crewPassword').value;
            
            const crew = users.find(u => u.id === crewId && u.password === crewPassword && u.role === 'crew');
            
            if (crew) {
                if (pendingAction) {
                    pendingAction();
                    closeApprovalModal();
                }
            } else {
                showNotification('Invalid crew credentials!', true);
            }
        }

        // Save cashbills to localStorage
        function saveCashbills() {
            localStorage.setItem('cashbills', JSON.stringify(cashbills));
        }

        // Save logbook to localStorage
        function saveLogbook() {
            localStorage.setItem('logbookEntries', JSON.stringify(logbookEntries));
        }

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
