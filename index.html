<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNE PORTAL PRO - Advanced Cashbill System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #3949ab;
            --accent-color: #5c6bc0;
            --success-color: #43a047;
            --danger-color: #e53935;
            --warning-color: #fb8c00;
            --info-color: #039be5;
            --light-color: #f5f5f5;
            --dark-color: #263238;
            --sidebar-width: 280px;
            --header-height: 60px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Login Page Styles */
        .login-container {
            max-width: 450px;
            margin: 120px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .login-header h2 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .login-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .login-form .form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        
        .login-form .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(92, 107, 192, 0.25);
        }
        
        .login-form .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .login-form .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.4);
        }
        
        /* Portal Styles */
        .portal-container {
            display: none;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: all 0.3s ease;
            z-index: 1000;
            padding-top: var(--header-height);
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar-header {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 1.2rem;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar.collapsed .sidebar-header span {
            display: none;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-menu li a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--warning-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar-menu li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar-menu li a:hover::before {
            transform: translateX(0);
        }
        
        .sidebar-menu li a.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .sidebar-menu li a.active::before {
            transform: translateX(0);
        }
        
        .sidebar-menu li a i {
            font-size: 1.2rem;
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        
        .sidebar.collapsed .sidebar-menu li a span {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-menu li a {
            justify-content: center;
        }
        
        .sidebar.collapsed .sidebar-menu li a i {
            margin-right: 0;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 80px;
        }
        
        .navbar {
            background: linear-gradient(90deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: var(--header-height);
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.4rem;
        }
        
        .navbar .nav-link {
            color: var(--dark-color) !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .navbar .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .content-section {
            display: none;
            padding: 25px;
        }
        
        .content-section.active {
            display: block;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: none;
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-weight: 600;
            border-radius: 15px 15px 0 0 !important;
            padding: 18px 25px;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.4);
        }
        
        .btn-outline-primary {
            border-color: var(--accent-color);
            color: var(--accent-color);
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }
        
        .table {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .table thead {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }
        
        .table thead th {
            border: none;
            font-weight: 600;
            padding: 15px;
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
        }
        
        .product-item {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: white;
        }
        
        .product-item:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }
        
        .product-name {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .price-tag {
            font-weight: 700;
            color: var(--danger-color);
            font-size: 1.1rem;
        }
        
        .member-price {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .min-order {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-approved {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-committed {
            background-color: var(--info-color);
            color: white;
        }
        
        .status-draft {
            background-color: #78909c;
            color: white;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        .user-role {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
        }
        
        .role-admin {
            background-color: var(--danger-color);
            color: white;
        }
        
        .role-staff {
            background-color: var(--info-color);
            color: white;
        }
        
        .cashbill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .cashbill-item:last-child {
            border-bottom: none;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 8px;
        }
        
        .uncommitted-card {
            border-left: 5px solid var(--warning-color);
        }
        
        .uncommitted-card .card-header {
            background-color: var(--warning-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .print-header h2 {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .print-section {
            margin-bottom: 25px;
        }
        
        .print-section h5 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
        }
        
        .edit-mode {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }
        
        .edit-mode label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .admin-action {
            margin-left: 8px;
        }
        
        /* Dashboard Stats Cards */
        .stats-card {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card .card-body {
            padding: 25px;
            position: relative;
        }
        
        .stats-card .card-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.5rem;
            opacity: 0.2;
        }
        
        .stats-card h5 {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats-card h2 {
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stats-card p {
            margin-bottom: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .stats-card.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, var(--success-color), #66bb6a);
            color: white;
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #ffb74d);
            color: white;
        }
        
        .stats-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ef5350);
            color: white;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* Data Table Enhancements */
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 8px 15px;
        }
        
        .dataTables_wrapper .dataTables_length select {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 5px 10px;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 5px !important;
            margin: 0 3px !important;
        }
        
        /* Notification Center */
        .notification-center {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .notification-dropdown {
            min-width: 350px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.unread {
            background-color: #f8f9fa;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        .settings-panel.active {
            right: 0;
        }
        
        .settings-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-content {
            padding: 20px;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-group h5 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .settings-option:last-child {
            border-bottom: none;
        }
        
        .settings-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-mode .navbar {
            background: linear-gradient(90deg, #2d2d2d 0%, #1a1a1a 100%);
        }
        
        body.dark-mode .card {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-mode .table {
            color: #e0e0e0;
        }
        
        body.dark-mode .table thead {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }
        
        body.dark-mode .filter-section {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .product-item {
            background-color: #2d2d2d;
            border-color: #444;
        }
        
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-mode .settings-panel {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        /* Loading Spinner */
        .spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                width: var(--sidebar-width);
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .main-content.expanded {
                margin-left: 0;
            }
            
            .stats-card {
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .login-container {
                margin: 50px auto;
                padding: 30px 20px;
            }
            
            .content-section {
                padding: 15px;
            }
            
            .card-header {
                padding: 15px;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                margin-bottom: 5px;
            }
        }
        
        /* Enhanced Cashbill Table Styles */
        .cashbill-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .action-btn.view {
            background-color: var(--info-color);
            color: white;
        }
        
        .action-btn.edit {
            background-color: var(--warning-color);
            color: white;
        }
        
        .action-btn.delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .action-btn.commit {
            background-color: var(--success-color);
            color: white;
        }
        
        .action-btn.uncommit {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .action-btn.remark {
            background-color: var(--accent-color);
            color: white;
        }
        
        .remark-badge {
            background-color: #e3f2fd;
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        
        .remark-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .remark-tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        
        .remark-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .empty-state h4 {
            color: #555;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            margin-bottom: 20px;
        }
        
        /* Status Timeline */
        .status-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            position: relative;
        }
        
        .status-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .timeline-step .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .timeline-step.completed .step-icon {
            background-color: var(--success-color);
        }
        
        .timeline-step.active .step-icon {
            background-color: var(--info-color);
        }
        
        .timeline-step .step-label {
            font-size: 0.75rem;
            text-align: center;
            max-width: 80px;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container" style="display: none;">
        <div class="spinner"></div>
    </div>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-header">
            <h2><i class="fas fa-file-invoice-dollar"></i> PNE PORTAL PRO</h2>
            <p class="text-muted">Advanced Cashbill Management System</p>
        </div>
        <form id="loginForm" class="login-form">
            <div class="mb-3">
                <label for="username" class="form-label">Staff ID</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-sign-in-alt me-2"></i> Login
            </button>
        </form>
        <div class="text-center mt-3">
            <small class="text-muted">© 2023 PNE PORTAL PRO. All rights reserved.</small>
        </div>
    </div>
    <!-- Portal Container -->
    <div id="portalContainer" class="portal-container">
        <!-- Overlay for sidebar -->
        <div id="overlay" class="overlay"></div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-file-invoice-dollar me-2"></i>
                <span>PNE PORTAL PRO</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-link active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li><a href="#" class="menu-link" data-section="cashbill"><i class="fas fa-file-invoice-dollar"></i><span>New Cashbill</span></a></li>
                <li><a href="#" class="menu-link" data-section="cashbill-list"><i class="fas fa-list"></i><span>All Cashbills</span></a></li>
                <li><a href="#" class="menu-link" data-section="logbook"><i class="fas fa-book"></i><span>New Logbook</span></a></li>
                <li><a href="#" class="menu-link" data-section="logbook-list"><i class="fas fa-list"></i><span>All Logbooks</span></a></li>
                <li><a href="#" class="menu-link" data-section="products"><i class="fas fa-box"></i><span>Products</span></a></li>
                <li><a href="#" class="menu-link admin-only" data-section="uncommitted"><i class="fas fa-clipboard-list"></i><span>Uncommitted Requests</span></a></li>
                <li><a href="#" class="menu-link admin-only" data-section="staff"><i class="fas fa-users"></i><span>Staff Management</span></a></li>
                <li><a href="#" class="menu-link" data-section="reports"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
                <li><a href="#" class="menu-link admin-only" data-section="activity"><i class="fas fa-history"></i><span>Activity Log</span></a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
            </ul>
        </div>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-header">
                <h5><i class="fas fa-cog me-2"></i> Settings</h5>
                <button class="btn btn-sm btn-light" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <h5>Appearance</h5>
                    <div class="settings-option">
                        <label for="darkModeToggle">Dark Mode</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        </div>
                    </div>
                    <div class="settings-option">
                        <label for="sidebarToggle">Collapsed Sidebar</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sidebarToggle">
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h5>Notifications</h5>
                    <div class="settings-option">
                        <label for="emailNotifications">Email Notifications</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                        </div>
                    </div>
                    <div class="settings-option">
                        <label for="pushNotifications">Push Notifications</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pushNotifications" checked>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h5>Data Management</h5>
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="exportDataBtn">
                        <i class="fas fa-download me-2"></i> Export All Data
                    </button>
                    <button class="btn btn-sm btn-outline-danger w-100" id="clearDataBtn">
                        <i class="fas fa-trash-alt me-2"></i> Clear All Data
                    </button>
                </div>
                
                <div class="settings-group">
                    <h5>About</h5>
                    <p>PNE PORTAL PRO v2.0</p>
                    <p>Advanced Cashbill Management System</p>
                    <p>© 2023 PNE Solutions. All rights reserved.</p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="main-content">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg">
                <div class="container-fluid">
                    <button id="menuToggle" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a class="navbar-brand" href="#">PNE PORTAL PRO</a>
                    
                    <div class="ms-auto d-flex align-items-center">
                        <div class="notification-center me-3">
                            <button class="btn btn-sm btn-outline-primary position-relative" id="notificationBtn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge" id="notificationBadge">3</span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationBtn">
                                <div class="dropdown-header">Notifications</div>
                                <div class="notification-item unread">
                                    <div class="notification-title">New cashbill submitted</div>
                                    <div class="notification-time">2 minutes ago</div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-title">Payment received for #PA0001</div>
                                    <div class="notification-time">1 hour ago</div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-title">System update available</div>
                                    <div class="notification-time">3 hours ago</div>
                                </div>
                                <div class="notification-item">
                                    <div class="notification-title">Weekly report generated</div>
                                    <div class="notification-time">Yesterday</div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-center" href="#">View All Notifications</a>
                            </div>
                        </div>
                        
                        <span id="userInfo" class="me-3">
                            Welcome, <strong id="userName">User</strong>
                            <span id="userRole" class="user-role">Staff</span>
                        </span>
                        
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog me-2"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="#" id="settingsBtn"><i class="fas fa-cog me-2"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn2"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Dashboard</h2>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="todayBtn">Today</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="weekBtn">This Week</button>
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="monthBtn">This Month</button>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stats-card primary">
                                <div class="card-body">
                                    <i class="fas fa-file-invoice-dollar card-icon"></i>
                                    <h5>Total Cashbills</h5>
                                    <h2 id="totalCashbills">0</h2>
                                    <p><i class="fas fa-arrow-up me-1"></i> 12% from last month</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stats-card success">
                                <div class="card-body">
                                    <i class="fas fa-check-circle card-icon"></i>
                                    <h5>Completed</h5>
                                    <h2 id="completedCashbills">0</h2>
                                    <p><i class="fas fa-arrow-up me-1"></i> 8% from last month</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stats-card warning">
                                <div class="card-body">
                                    <i class="fas fa-clock card-icon"></i>
                                    <h5>Pending Approval</h5>
                                    <h2 id="pendingCashbills">0</h2>
                                    <p><i class="fas fa-arrow-down me-1"></i> 3% from last month</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card stats-card danger">
                                <div class="card-body">
                                    <i class="fas fa-money-bill-wave card-icon"></i>
                                    <h5>Total Revenue</h5>
                                    <h2 id="totalRevenue">RM 0</h2>
                                    <p><i class="fas fa-arrow-up me-1"></i> 15% from last month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Revenue Chart</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="chartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="chartDropdown">
                                            <li><a class="dropdown-item" href="#" id="downloadChartBtn">Download Chart</a></li>
                                            <li><a class="dropdown-item" href="#" id="refreshChartBtn">Refresh Data</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="revenueChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    Quick Actions
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-primary" id="newCashbillBtn">
                                            <i class="fas fa-plus-circle me-2"></i> New Cashbill
                                        </button>
                                        <button class="btn btn-outline-primary" id="newLogbookBtn">
                                            <i class="fas fa-plus-circle me-2"></i> New Logbook
                                        </button>
                                        <button class="btn btn-outline-secondary" id="exportDataBtn2">
                                            <i class="fas fa-file-export me-2"></i> Export Data
                                        </button>
                                        <button class="btn btn-outline-info" id="generateReportBtn">
                                            <i class="fas fa-chart-line me-2"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Recent Cashbills</span>
                                    <div>
                                        <button class="btn btn-sm btn-light" id="refreshCashbillsBtn">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="recentCashbillsTable">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Customer</th>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="6" class="text-center">No cashbills found</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cashbill Section -->
            <div id="cashbill" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Create New Cashbill</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="saveTemplateBtn">
                                <i class="fas fa-save me-1"></i> Save Template
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="loadTemplateBtn">
                                <i class="fas fa-folder-open me-1"></i> Load Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    Cashbill Information
                                </div>
                                <div class="card-body">
                                    <form id="cashbillForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="cashbillId" class="form-label">Cashbill ID</label>
                                                <input type="text" class="form-control" id="cashbillId" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="cashbillDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="cashbillDate" required>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Customer Information</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="customerFirstName" class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="customerFirstName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="customerLastName" class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="customerLastName" required>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="customerPhone" class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" id="customerPhone" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="customerEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="customerEmail">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerAddress" class="form-label">Address</label>
                                            <textarea class="form-control" id="customerAddress" rows="2" required></textarea>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Order Items</h5>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-md-5">
                                                    <label for="productSelect" class="form-label">Select Product</label>
                                                    <select class="form-select" id="productSelect">
                                                        <option value="">-- Select Product --</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="quantity" class="form-label">Quantity</label>
                                                    <input type="number" class="form-control" id="quantity" min="1" value="1">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="price" class="form-label">Price (RM)</label>
                                                    <input type="number" class="form-control" id="price" step="0.01" min="0">
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-primary" id="addItemBtn">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="card">
                                                <div class="card-header">
                                                    Order Items
                                                </div>
                                                <div class="card-body">
                                                    <div id="orderItems">
                                                        <div class="text-center text-muted py-3">No items added yet</div>
                                                    </div>
                                                    <div class="mt-3 text-end">
                                                        <h5>Total: RM <span id="totalAmount">0.00</span></h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mt-4 mb-3">Payment Information</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="paymentType" class="form-label">Payment Type</label>
                                                <select class="form-select" id="paymentType" required>
                                                    <option value="">-- Select Payment Type --</option>
                                                    <option value="cash">Cash</option>
                                                    <option value="bank-transfer">Bank Transfer</option>
                                                    <option value="credit-card">Credit Card</option>
                                                    <option value="e-wallet">E-Wallet</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="paymentStatus" class="form-label">Payment Status</label>
                                                <select class="form-select" id="paymentStatus" required>
                                                    <option value="pending">Pending</option>
                                                    <option value="partial">Partial</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="notes" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes" rows="2"></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-secondary" id="resetCashbillBtn">
                                                <i class="fas fa-redo me-1"></i> Reset
                                            </button>
                                            <div>
                                                <button type="button" class="btn btn-warning me-2" id="saveDraftBtn">
                                                    <i class="fas fa-save me-1"></i> Save as Draft
                                                </button>
                                                <button type="submit" class="btn btn-primary" id="commitCashbillBtn">
                                                    <i class="fas fa-check me-1"></i> Commit Cashbill
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    Customer History
                                </div>
                                <div class="card-body">
                                    <div id="customerHistory">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-history fa-3x mb-3"></i>
                                            <p>Enter customer details to view history</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Product Suggestions
                                </div>
                                <div class="card-body">
                                    <div id="productSuggestions">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-lightbulb fa-3x mb-3"></i>
                                            <p>Product suggestions will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cashbill List Section -->
            <div id="cashbill-list" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">All Cashbills</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="exportCashbillsBtn">
                                <i class="fas fa-file-excel me-1"></i> Export to Excel
                            </button>
                            <button class="btn btn-sm btn-primary" id="newCashbillFromListBtn">
                                <i class="fas fa-plus me-1"></i> New Cashbill
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="filter-section mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control" id="searchCashbill" placeholder="Search by ID or customer name...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterStatus">
                                            <option value="">All Status</option>
                                            <option value="draft">Draft</option>
                                            <option value="committed">Committed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="date" class="form-control" id="filterDate" placeholder="Filter by date">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                                            <i class="fas fa-times me-1"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="allCashbillsTable">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Cashbill ID</th>
                                            <th>Date</th>
                                            <th>Customer Name</th>
                                            <th>Prices</th>
                                            <th>Username Crew</th>
                                            <th>Crew ID</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="empty-state">
                                                    <i class="fas fa-file-invoice-dollar"></i>
                                                    <h4>No Cashbills Found</h4>
                                                    <p>Start by creating your first cashbill</p>
                                                    <button class="btn btn-primary" id="createFirstCashbillBtn">
                                                        <i class="fas fa-plus me-2"></i> Create Cashbill
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logbook Section -->
            <div id="logbook" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Create New Logbook Entry</h2>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    Logbook Information
                                </div>
                                <div class="card-body">
                                    <form id="logbookForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="logbookId" class="form-label">Logbook ID</label>
                                                <input type="text" class="form-control" id="logbookId" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="logbookDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="logbookDate" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="cashbillRef" class="form-label">Cashbill Reference</label>
                                                <select class="form-select" id="cashbillRef" required>
                                                    <option value="">-- Select Cashbill --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="trackingNumber" class="form-label">Tracking Number</label>
                                                <input type="text" class="form-control" id="trackingNumber">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="courierName" class="form-label">Courier Name</label>
                                                <input type="text" class="form-control" id="courierName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="deliveryStatus" class="form-label">Delivery Status</label>
                                                <select class="form-select" id="deliveryStatus" required>
                                                    <option value="preparing">Preparing</option>
                                                    <option value="picked-up">Picked Up</option>
                                                    <option value="in-transit">In Transit</option>
                                                    <option value="delivered">Delivered</option>
                                                    <option value="returned">Returned</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="deliveryAddress" class="form-label">Delivery Address</label>
                                            <textarea class="form-control" id="deliveryAddress" rows="2" required></textarea>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="deliveryDate" class="form-label">Expected Delivery Date</label>
                                                <input type="date" class="form-control" id="deliveryDate">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="deliveryTime" class="form-label">Expected Delivery Time</label>
                                                <input type="time" class="form-control" id="deliveryTime">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="logbookNotes" class="form-label">Notes</label>
                                            <textarea class="form-control" id="logbookNotes" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-secondary" id="resetLogbookBtn">
                                                <i class="fas fa-redo me-1"></i> Reset
                                            </button>
                                            <div>
                                                <button type="button" class="btn btn-warning me-2" id="saveLogbookDraftBtn">
                                                    <i class="fas fa-save me-1"></i> Save as Draft
                                                </button>
                                                <button type="submit" class="btn btn-primary" id="saveLogbookBtn">
                                                    <i class="fas fa-check me-1"></i> Save Logbook
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    Delivery Map
                                </div>
                                <div class="card-body">
                                    <div id="deliveryMap" style="height: 300px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                        <div class="text-center">
                                            <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">Enter delivery address to show map</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Delivery Timeline
                                </div>
                                <div class="card-body">
                                    <div id="deliveryTimeline">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-clock fa-3x mb-3"></i>
                                            <p>Delivery timeline will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logbook List Section -->
            <div id="logbook-list" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">All Logbooks</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="exportLogbooksBtn">
                                <i class="fas fa-file-excel me-1"></i> Export to Excel
                            </button>
                            <button class="btn btn-sm btn-primary" id="newLogbookFromListBtn">
                                <i class="fas fa-plus me-1"></i> New Logbook
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="filter-section mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control" id="searchLogbook" placeholder="Search by ID or courier name...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterDeliveryStatus">
                                            <option value="">All Status</option>
                                            <option value="preparing">Preparing</option>
                                            <option value="picked-up">Picked Up</option>
                                            <option value="in-transit">In Transit</option>
                                            <option value="delivered">Delivered</option>
                                            <option value="returned">Returned</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="date" class="form-control" id="filterLogbookDate" placeholder="Filter by date">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="clearLogbookFiltersBtn">
                                            <i class="fas fa-times me-1"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="allLogbooksTable">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Logbook ID</th>
                                            <th>Cashbill Ref</th>
                                            <th>Courier</th>
                                            <th>Date</th>
                                            <th>Delivery Status</th>
                                            <th>Tracking #</th>
                                            <th>Username Crew</th>
                                            <th>Crew ID</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="10" class="text-center">No logbooks found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Uncommitted Requests Section (Admin Only) -->
            <div id="uncommitted" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Uncommitted Requests</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" id="approveAllBtn">
                                <i class="fas fa-check-double me-1"></i> Approve All
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="rejectAllBtn">
                                <i class="fas fa-times me-1"></i> Reject All
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="uncommittedList">
                                <div class="empty-state">
                                    <i class="fas fa-clipboard-list"></i>
                                    <h4>No Uncommitted Requests</h4>
                                    <p>All cashbills have been committed</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="products" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Product Management</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="importProductsBtn">
                                <i class="fas fa-file-import me-1"></i> Import Products
                            </button>
                            <button class="btn btn-sm btn-primary admin-only" id="addProductBtn">
                                <i class="fas fa-plus me-1"></i> Add Product
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="filter-section mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control" id="searchProduct" placeholder="Search products...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterCategory">
                                            <option value="">All Categories</option>
                                            <option value="jubah">Jubah</option>
                                            <option value="accessories">Accessories</option>
                                            <option value="uniforms">Uniforms</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="sortBy">
                                            <option value="name">Sort by Name</option>
                                            <option value="price-low">Price: Low to High</option>
                                            <option value="price-high">Price: High to Low</option>
                                            <option value="newest">Newest First</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row" id="productsList">
                                <!-- Products will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management Section -->
            <div id="staff" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Staff Management</h2>
                        <button class="btn btn-sm btn-primary admin-only" id="addStaffBtn">
                            <i class="fas fa-user-plus me-1"></i> Add New Staff
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="staffTable">
                                    <thead>
                                        <tr>
                                            <th>Staff ID</th>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Staff will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="container-fluid">
                    <h2 class="mb-4">Reports</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-invoice-dollar fa-3x text-primary mb-3"></i>
                                    <h5>Cashbill Report</h5>
                                    <p class="text-muted">Generate cashbill reports with filters</p>
                                    <button class="btn btn-primary generate-report" data-type="cashbill">Generate</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-truck fa-3x text-success mb-3"></i>
                                    <h5>Delivery Report</h5>
                                    <p class="text-muted">Generate delivery and logistics reports</p>
                                    <button class="btn btn-primary generate-report" data-type="delivery">Generate</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                                    <h5>Sales Report</h5>
                                    <p class="text-muted">Generate sales and revenue reports</p>
                                    <button class="btn btn-primary generate-report" data-type="sales">Generate</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-box fa-3x text-info mb-3"></i>
                                    <h5>Inventory Report</h5>
                                    <p class="text-muted">Generate inventory and stock reports</p>
                                    <button class="btn btn-primary generate-report" data-type="inventory">Generate</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            Scheduled Reports
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Report Name</th>
                                            <th>Type</th>
                                            <th>Frequency</th>
                                            <th>Last Generated</th>
                                            <th>Next Run</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Weekly Sales Summary</td>
                                            <td>Sales</td>
                                            <td>Weekly</td>
                                            <td>2023-11-15</td>
                                            <td>2023-11-22</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1">Edit</button>
                                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Monthly Inventory Report</td>
                                            <td>Inventory</td>
                                            <td>Monthly</td>
                                            <td>2023-11-01</td>
                                            <td>2023-12-01</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1">Edit</button>
                                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Daily Delivery Status</td>
                                            <td>Delivery</td>
                                            <td>Daily</td>
                                            <td>2023-11-20</td>
                                            <td>2023-11-21</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1">Edit</button>
                                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i> Schedule New Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Activity Log Section (Admin Only) -->
            <div id="activity" class="content-section">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Activity Log</h2>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="exportActivityBtn">
                                <i class="fas fa-file-excel me-1"></i> Export Log
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="clearActivityBtn">
                                <i class="fas fa-trash-alt me-1"></i> Clear Log
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="filter-section mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control" id="searchActivity" placeholder="Search activities...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterUser">
                                            <option value="">All Users</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterAction">
                                            <option value="">All Actions</option>
                                            <option value="login">Login</option>
                                            <option value="create">Create</option>
                                            <option value="update">Update</option>
                                            <option value="delete">Delete</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="clearActivityFiltersBtn">
                                            <i class="fas fa-times me-1"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="activityTable">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                            <th>IP Address</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Activities will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productIcon" class="form-label">Product Icon</label>
                                <select class="form-select" id="productIcon">
                                    <option value="">-- Select Icon --</option>
                                    <option value="🕌">🕌 Mosque</option>
                                    <option value="📘">📘 Book</option>
                                    <option value="🧒">🧒 Child</option>
                                    <option value="🏷️">🏷️ Label</option>
                                    <option value="🏅">🏅 Medal</option>
                                    <option value="🔑">🔑 Key</option>
                                    <option value="👕">👕 T-Shirt</option>
                                    <option value="👖">👖 Pants</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory">
                                    <option value="jubah">Jubah</option>
                                    <option value="accessories">Accessories</option>
                                    <option value="uniforms">Uniforms</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productSku" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="productSku" placeholder="Auto-generated if empty">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="regularPrice" class="form-label">Regular Price (RM)</label>
                                <input type="number" class="form-control" id="regularPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="memberPrice" class="form-label">Member Price (RM)</label>
                                <input type="number" class="form-control" id="memberPrice" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productUnit" class="form-label">Unit</label>
                                <select class="form-select" id="productUnit">
                                    <option value="per set">Per Set</option>
                                    <option value="per piece">Per Piece</option>
                                    <option value="each">Each</option>
                                    <option value="per pc">Per PC</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="minOrder" class="form-label">Minimum Order</label>
                                <input type="number" class="form-control" id="minOrder" min="0" value="0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="stockQuantity" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" id="stockQuantity" min="0" value="0">
                            </div>
                            <div class="col-md-6">
                                <label for="reorderLevel" class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="reorderLevel" min="0" value="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productFeatures" class="form-label">Features (one per line)</label>
                            <textarea class="form-control" id="productFeatures" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Product Image URL</label>
                            <input type="url" class="form-control" id="productImage" placeholder="https://example.com/image.jpg">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Staff Modal -->
    <div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStaffModalLabel">Add New Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStaffForm">
                        <div class="mb-3">
                            <label for="staffFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="staffFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="staffLastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffUsername" class="form-label">Staff ID</label>
                            <input type="text" class="form-control" id="staffUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="staffPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="staffEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="staffEmail">
                        </div>
                        <div class="mb-3">
                            <label for="staffPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="staffPhone">
                        </div>
                        <div class="mb-3">
                            <label for="staffRole" class="form-label">Role</label>
                            <select class="form-select" id="staffRole" required>
                                <option value="staff">Crew</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveStaffBtn">Save Staff</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Cashbill Modal -->
    <div class="modal fade" id="viewCashbillModal" tabindex="-1" aria-labelledby="viewCashbillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewCashbillModalLabel">Cashbill Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cashbillDetails">
                        <!-- Cashbill details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printCashbillBtn">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="emailCashbillBtn">
                        <i class="fas fa-envelope me-1"></i> Email
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Cashbill Modal -->
    <div class="modal fade" id="editCashbillModal" tabindex="-1" aria-labelledby="editCashbillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCashbillModalLabel">Edit Cashbill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCashbillForm">
                        <input type="hidden" id="editCashbillId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCashbillDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="editCashbillDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPaymentType" class="form-label">Payment Type</label>
                                <select class="form-select" id="editPaymentType" required>
                                    <option value="cash">Cash</option>
                                    <option value="bank-transfer">Bank Transfer</option>
                                    <option value="credit-card">Credit Card</option>
                                    <option value="e-wallet">E-Wallet</option>
                                </select>
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Customer Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCustomerFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="editCustomerFirstName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCustomerLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="editCustomerLastName" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCustomerPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editCustomerPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCustomerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editCustomerEmail">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editCustomerAddress" rows="2" required></textarea>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Order Items</h5>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-5">
                                    <label for="editProductSelect" class="form-label">Select Product</label>
                                    <select class="form-select" id="editProductSelect">
                                        <option value="">-- Select Product --</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="editQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editQuantity" min="1" value="1">
                                </div>
                                <div class="col-md-3">
                                    <label for="editPrice" class="form-label">Price (RM)</label>
                                    <input type="number" class="form-control" id="editPrice" step="0.01" min="0">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary" id="addEditItemBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    Order Items
                                </div>
                                <div class="card-body">
                                    <div id="editOrderItems">
                                        <!-- Items will be populated here -->
                                    </div>
                                    <div class="mt-3 text-end">
                                        <h5>Total: RM <span id="editTotalAmount">0.00</span></h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editPaymentStatus" class="form-label">Payment Status</label>
                                <select class="form-select" id="editPaymentStatus" required>
                                    <option value="pending">Pending</option>
                                    <option value="partial">Partial</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="editNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="updateDraftBtn">
                        <i class="fas fa-save me-1"></i> Update Draft
                    </button>
                    <button type="button" class="btn btn-primary" id="updateAndCommitBtn">
                        <i class="fas fa-check me-1"></i> Update & Commit
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Logbook Modal -->
    <div class="modal fade" id="viewLogbookModal" tabindex="-1" aria-labelledby="viewLogbookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewLogbookModalLabel">Logbook Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logbookDetails">
                        <!-- Logbook details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printLogbookBtn">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="emailLogbookBtn">
                        <i class="fas fa-envelope me-1"></i> Email
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Generation Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Generate Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="reportType" class="form-label">Report Type</label>
                            <input type="text" class="form-control" id="reportType" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="reportDateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="reportDateRange">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="this-week">This Week</option>
                                <option value="last-week">Last Week</option>
                                <option value="this-month">This Month</option>
                                <option value="last-month">Last Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="row mb-3" id="customDateRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="reportStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="reportStartDate">
                            </div>
                            <div class="col-md-6">
                                <label for="reportEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="reportEndDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reportFormat" class="form-label">Format</label>
                            <select class="form-select" id="reportFormat">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reportEmail" class="form-label">Email Report To</label>
                            <input type="email" class="form-control" id="reportEmail" placeholder="Enter email address (optional)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Remark Modal -->
    <div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="remarkModalLabel">Add Remark</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="remarkForm">
                        <input type="hidden" id="remarkCashbillId">
                        <div class="mb-3">
                            <label for="remarkText" class="form-label">Remark</label>
                            <textarea class="form-control" id="remarkText" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveRemarkBtn">Save Remark</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Cashbill Template (Hidden) -->
    <div id="printCashbillTemplate" class="print-only" style="display: none;">
        <div class="print-header">
            <h2>PNE PORTAL PRO</h2>
            <h4>CASHBILL INVOICE</h4>
        </div>
        <div class="print-section">
            <h5>Cashbill Information</h5>
            <div id="printCashbillInfo"></div>
        </div>
        <div class="print-section">
            <h5>Customer Information</h5>
            <div id="printCustomerInfo"></div>
        </div>
        <div class="print-section">
            <h5>Order Items</h5>
            <div id="printOrderItems"></div>
        </div>
        <div class="print-section">
            <h5>Payment Information</h5>
            <div id="printPaymentInfo"></div>
        </div>
        <div class="text-center mt-4">
            <p>Thank you for your business!</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data storage
            initializeDataStorage();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cashbillDate').value = today;
            document.getElementById('logbookDate').value = today;
            
            // Initialize variables
            let currentUser = null;
            let sidebarOpen = false;
            let currentSection = 'dashboard';
            let editingCashbillId = null;
            let revenueChart = null;
            let notificationCount = 3;
            
            // DOM elements
            const loginPage = document.getElementById('loginPage');
            const portalContainer = document.getElementById('portalContainer');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('overlay');
            const menuToggle = document.getElementById('menuToggle');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutBtn2 = document.getElementById('logoutBtn2');
            const menuLinks = document.querySelectorAll('.menu-link');
            const contentSections = document.querySelectorAll('.content-section');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('pne_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPortal();
            }
            
            // Check for saved settings
            const savedDarkMode = localStorage.getItem('pne_dark_mode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }
            
            const savedSidebarState = localStorage.getItem('pne_sidebar_collapsed') === 'true';
            if (savedSidebarState) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                sidebarToggle.checked = true;
            }
            
            // Login form submission
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showLoading();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Authenticate user
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);
                
                setTimeout(() => {
                    hideLoading();
                    if (user) {
                        currentUser = user;
                        localStorage.setItem('pne_current_user', JSON.stringify(user));
                        
                        // Log activity
                        logActivity('login', `User ${user.name} logged in`);
                        
                        showPortal();
                    } else {
                        showToast('Invalid Staff ID or password', 'danger');
                    }
                }, 800);
            });
            
            // Show portal after login
            function showPortal() {
                loginPage.style.display = 'none';
                portalContainer.style.display = 'block';
                
                // Set user info
                userName.textContent = currentUser.name;
                userRole.textContent = currentUser.role === 'admin' ? 'Admin' : 'Crew';
                userRole.className = `user-role ${currentUser.role === 'admin' ? 'role-admin' : 'role-staff'}`;
                
                // Show success message
                showToast(`Welcome, ${currentUser.name}!`, 'success');
                
                // Check if user is admin to show/hide certain features
                if (currentUser.role === 'staff') {
                    // Hide admin-only features for regular staff
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'none';
                    });
                }
                
                // Load initial data
                loadDashboardData();
                loadProducts();
                loadStaff();
                loadCashbillList();
                loadLogbookList();
                updateCashbillRef();
                loadActivityLog();
                initializeRevenueChart();
                
                // Initialize DataTables
                setTimeout(() => {
                    $('#allCashbillsTable').DataTable({
                        responsive: true,
                        pageLength: 10,
                        order: [[2, 'desc']]
                    });
                    
                    $('#allLogbooksTable').DataTable({
                        responsive: true,
                        pageLength: 10,
                        order: [[4, 'desc']]
                    });
                    
                    $('#staffTable').DataTable({
                        responsive: true,
                        pageLength: 10,
                        order: [[0, 'asc']]
                    });
                    
                    $('#activityTable').DataTable({
                        responsive: true,
                        pageLength: 15,
                        order: [[0, 'desc']]
                    });
                }, 500);
            }
            
            // Logout functionality
            logoutBtn.addEventListener('click', logout);
            logoutBtn2.addEventListener('click', logout);
            
            function logout() {
                if (currentUser) {
                    // Log activity
                    logActivity('logout', `User ${currentUser.name} logged out`);
                }
                
                currentUser = null;
                localStorage.removeItem('pne_current_user');
                loginPage.style.display = 'block';
                portalContainer.style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showToast('You have been logged out', 'info');
            }
            
            // Toggle sidebar
            menuToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            function toggleSidebar() {
                if (window.innerWidth <= 992) {
                    // Mobile behavior
                    sidebarOpen = !sidebarOpen;
                    
                    if (sidebarOpen) {
                        sidebar.classList.add('mobile-open');
                        overlay.classList.add('active');
                    } else {
                        closeSidebar();
                    }
                } else {
                    // Desktop behavior
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                    
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('pne_sidebar_collapsed', isCollapsed);
                }
            }
            
            function closeSidebar() {
                sidebarOpen = false;
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            }
            
            // Menu navigation
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const section = this.getAttribute('data-section');
                    if (section) {
                        showSection(section);
                        closeSidebar();
                    }
                });
            });
            
            function showSection(sectionName) {
                // Update active menu link
                menuLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-section') === sectionName) {
                        link.classList.add('active');
                    }
                });
                
                // Show selected section
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === sectionName) {
                        section.classList.add('active');
                    }
                });
                
                currentSection = sectionName;
                
                // Refresh data when navigating to certain sections
                if (sectionName === 'uncommitted') {
                    refreshUncommittedList();
                } else if (sectionName === 'cashbill-list') {
                    loadCashbillList();
                } else if (sectionName === 'logbook-list') {
                    loadLogbookList();
                } else if (sectionName === 'products') {
                    loadProducts();
                } else if (sectionName === 'staff') {
                    loadStaff();
                } else if (sectionName === 'activity') {
                    loadActivityLog();
                }
            }
            
            // Settings panel
            settingsBtn.addEventListener('click', function() {
                settingsPanel.classList.add('active');
            });
            
            closeSettingsBtn.addEventListener('click', function() {
                settingsPanel.classList.remove('active');
            });
            
            // Dark mode toggle
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('pne_dark_mode', 'true');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('pne_dark_mode', 'false');
                }
            });
            
            // Sidebar toggle
            sidebarToggle.addEventListener('change', function() {
                if (this.checked) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    localStorage.setItem('pne_sidebar_collapsed', 'true');
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    localStorage.setItem('pne_sidebar_collapsed', 'false');
                }
            });
            
            // Quick action buttons
            document.getElementById('newCashbillBtn').addEventListener('click', function() {
                showSection('cashbill');
                generateNewCashbillId();
            });
            
            document.getElementById('newLogbookBtn').addEventListener('click', function() {
                showSection('logbook');
                generateNewLogbookId();
            });
            
            document.getElementById('newCashbillFromListBtn').addEventListener('click', function() {
                showSection('cashbill');
                generateNewCashbillId();
            });
            
            document.getElementById('newLogbookFromListBtn').addEventListener('click', function() {
                showSection('logbook');
                generateNewLogbookId();
            });
            
            // Create first cashbill button
            document.getElementById('createFirstCashbillBtn')?.addEventListener('click', function() {
                showSection('cashbill');
                generateNewCashbillId();
            });
            
            // Dashboard date range buttons
            document.getElementById('todayBtn').addEventListener('click', function() {
                setActiveButton(this, '#todayBtn, #weekBtn, #monthBtn');
                updateDashboardData('today');
            });
            
            document.getElementById('weekBtn').addEventListener('click', function() {
                setActiveButton(this, '#todayBtn, #weekBtn, #monthBtn');
                updateDashboardData('week');
            });
            
            document.getElementById('monthBtn').addEventListener('click', function() {
                setActiveButton(this, '#todayBtn, #weekBtn, #monthBtn');
                updateDashboardData('month');
            });
            
            function setActiveButton(activeBtn, selector) {
                document.querySelectorAll(selector).forEach(btn => {
                    btn.classList.remove('active');
                });
                activeBtn.classList.add('active');
            }
            
            // Initialize revenue chart
            function initializeRevenueChart() {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                // Generate sample data for the last 7 days
                const labels = [];
                const data = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    // Generate random revenue between 1000 and 5000
                    data.push(Math.floor(Math.random() * 4000) + 1000);
                }
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue (RM)',
                            data: data,
                            backgroundColor: 'rgba(92, 107, 192, 0.2)',
                            borderColor: 'rgba(92, 107, 192, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(92, 107, 192, 1)',
                            pointBorderColor: '#fff',
                            pointRadius: 4,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `Revenue: RM ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return 'RM ' + value;
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Update dashboard data based on date range
            function updateDashboardData(range) {
                showLoading();
                
                setTimeout(() => {
                    // In a real app, this would fetch data from a server
                    // For demo purposes, we'll generate random data
                    let cashbills = Math.floor(Math.random() * 50) + 20;
                    let completed = Math.floor(cashbills * 0.7);
                    let pending = cashbills - completed;
                    let revenue = Math.floor(Math.random() * 50000) + 20000;
                    
                    document.getElementById('totalCashbills').textContent = cashbills;
                    document.getElementById('completedCashbills').textContent = completed;
                    document.getElementById('pendingCashbills').textContent = pending;
                    document.getElementById('totalRevenue').textContent = `RM ${revenue.toLocaleString()}`;
                    
                    // Update chart data
                    if (revenueChart) {
                        const labels = [];
                        const data = [];
                        const today = new Date();
                        
                        let days = 7;
                        if (range === 'today') days = 1;
                        if (range === 'week') days = 7;
                        if (range === 'month') days = 30;
                        
                        for (let i = days - 1; i >= 0; i--) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);
                            
                            if (range === 'today') {
                                labels.push('Today');
                            } else if (range === 'week') {
                                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                            } else {
                                labels.push(date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }));
                            }
                            
                            // Generate random revenue between 1000 and 5000
                            data.push(Math.floor(Math.random() * 4000) + 1000);
                        }
                        
                        revenueChart.data.labels = labels;
                        revenueChart.data.datasets[0].data = data;
                        revenueChart.update();
                    }
                    
                    hideLoading();
                }, 800);
            }
            
            // Refresh cashbills button
            document.getElementById('refreshCashbillsBtn').addEventListener('click', function() {
                showLoading();
                
                setTimeout(() => {
                    loadRecentCashbills();
                    hideLoading();
                    showToast('Cashbills refreshed', 'success');
                }, 800);
            });
            
            // Download chart button
            document.getElementById('downloadChartBtn').addEventListener('click', function() {
                if (revenueChart) {
                    const url = revenueChart.toBase64Image();
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'revenue-chart.png';
                    a.click();
                    showToast('Chart downloaded', 'success');
                }
            });
            
            // Refresh chart button
            document.getElementById('refreshChartBtn').addEventListener('click', function() {
                showLoading();
                
                setTimeout(() => {
                    updateDashboardData('month');
                    hideLoading();
                    showToast('Chart data refreshed', 'success');
                }, 800);
            });
            
            // Generate report button
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                document.getElementById('reportType').value = 'Custom Report';
                reportModal.show();
            });
            
            // Report date range change
            document.getElementById('reportDateRange').addEventListener('change', function() {
                const customRange = document.getElementById('customDateRange');
                if (this.value === 'custom') {
                    customRange.style.display = 'flex';
                } else {
                    customRange.style.display = 'none';
                }
            });
            
            // Generate report button in modal
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const reportType = document.getElementById('reportType').value;
                const dateRange = document.getElementById('reportDateRange').value;
                const format = document.getElementById('reportFormat').value;
                const email = document.getElementById('reportEmail').value;
                
                showLoading();
                
                setTimeout(() => {
                    hideLoading();
                    
                    // Close modal
                    const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    reportModal.hide();
                    
                    // Show success message
                    showToast(`${reportType} generated successfully!`, 'success');
                    
                    // If email is provided, show additional message
                    if (email) {
                        showToast(`Report sent to ${email}`, 'info');
                    }
                }, 1500);
            });
            
            // Export data buttons
            document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
            document.getElementById('exportDataBtn2').addEventListener('click', exportAllData);
            document.getElementById('exportCashbillsBtn').addEventListener('click', () => exportData('cashbills'));
            document.getElementById('exportLogbooksBtn').addEventListener('click', () => exportData('logbooks'));
            document.getElementById('exportActivityBtn').addEventListener('click', () => exportData('activity'));
            
            // Clear data button
            document.getElementById('clearDataBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                    localStorage.clear();
                    initializeDataStorage();
                    showToast('All data cleared successfully', 'warning');
                    
                    // Reload the page to reset everything
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            });
            
            // Clear activity log button
            document.getElementById('clearActivityBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the activity log?')) {
                    localStorage.setItem('pne_activity_log', JSON.stringify([]));
                    loadActivityLog();
                    showToast('Activity log cleared', 'warning');
                }
            });
            
            // Notification button
            document.getElementById('notificationBtn').addEventListener('click', function() {
                // Mark all notifications as read
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                });
                
                // Reset notification badge
                document.getElementById('notificationBadge').textContent = '0';
                notificationCount = 0;
            });
            
            // Cashbill form handling
            const cashbillForm = document.getElementById('cashbillForm');
            const addItemBtn = document.getElementById('addItemBtn');
            const productSelect = document.getElementById('productSelect');
            const quantityInput = document.getElementById('quantity');
            const priceInput = document.getElementById('price');
            const orderItemsContainer = document.getElementById('orderItems');
            const totalAmountSpan = document.getElementById('totalAmount');
            
            // Load products into select dropdown
            function loadProductsIntoSelect() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                productSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.icon} ${product.name} - RM ${product.regularPrice}`;
                    productSelect.appendChild(option);
                });
            }
            
            // Set price when product is selected
            productSelect.addEventListener('change', function() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = this.value;
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        priceInput.value = product.regularPrice;
                        
                        // Disable price editing for staff users
                        if (currentUser && currentUser.role === 'staff') {
                            priceInput.disabled = true;
                        } else {
                            priceInput.disabled = false;
                        }
                        
                        // Update product suggestions
                        updateProductSuggestions(product);
                    }
                } else {
                    priceInput.value = '';
                    priceInput.disabled = false;
                }
            });
            
            // Update product suggestions
            function updateProductSuggestions(product) {
                const suggestionsContainer = document.getElementById('productSuggestions');
                
                // Get related products (same category)
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const relatedProducts = products.filter(p => 
                    p.category === product.category && p.id !== product.id
                ).slice(0, 3);
                
                if (relatedProducts.length > 0) {
                    let html = '<h6 class="mb-3">Related Products</h6>';
                    
                    relatedProducts.forEach(p => {
                        html += `
                            <div class="d-flex align-items-center mb-2 p-2 border rounded">
                                <div class="me-3 fs-4">${p.icon}</div>
                                <div>
                                    <div class="fw-bold">${p.name}</div>
                                    <div class="text-muted">RM ${p.regularPrice} ${p.unit}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    suggestionsContainer.innerHTML = html;
                } else {
                    suggestionsContainer.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-lightbulb fa-3x mb-3"></i>
                            <p>No related products found</p>
                        </div>
                    `;
                }
            }
            
            // Add item to order
            addItemBtn.addEventListener('click', function() {
                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                const price = parseFloat(priceInput.value) || 0;
                
                if (!productId) {
                    showToast('Please select a product', 'warning');
                    return;
                }
                
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showToast('Product not found', 'danger');
                    return;
                }
                
                // Clear placeholder if it exists
                const placeholder = orderItemsContainer.querySelector('.text-center');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // Create new item element
                const itemElement = document.createElement('div');
                itemElement.className = 'cashbill-item';
                itemElement.innerHTML = `
                    <div>
                        <div class="fw-bold">${product.icon} ${product.name}</div>
                        <div>${quantity} x RM ${price.toFixed(2)}</div>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add remove functionality
                itemElement.querySelector('.remove-item').addEventListener('click', function() {
                    itemElement.remove();
                    updateTotalAmount();
                    
                    // Add placeholder back if no items
                    if (orderItemsContainer.children.length === 0) {
                        orderItemsContainer.innerHTML = '<div class="text-center text-muted py-3">No items added yet</div>';
                    }
                });
                
                // Add to order items
                orderItemsContainer.appendChild(itemElement);
                
                // Update total
                updateTotalAmount();
                
                // Reset form
                productSelect.value = '';
                quantityInput.value = '1';
                priceInput.value = '';
                priceInput.disabled = false;
            });
            
            // Update total amount
            function updateTotalAmount() {
                let total = 0;
                
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        total += quantity * price;
                    }
                });
                
                totalAmountSpan.textContent = total.toFixed(2);
            }
            
            // Cashbill form submission
            cashbillForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Check if there are items in the order
                if (orderItemsContainer.children.length === 0 || orderItemsContainer.querySelector('.text-center')) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get form data
                const cashbillId = document.getElementById('cashbillId').value;
                const cashbillDate = document.getElementById('cashbillDate').value;
                const customerFirstName = document.getElementById('customerFirstName').value;
                const customerLastName = document.getElementById('customerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                const notes = document.getElementById('notes').value;
                
                // Get order items
                const items = [];
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(totalAmountSpan.textContent);
                
                // Create cashbill object
                const cashbill = {
                    id: cashbillId,
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: 'committed',
                    remark: '',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save cashbill
                saveCashbill(cashbill);
                
                // Log activity
                logActivity('create', `Created cashbill ${cashbillId}`);
                
                // Show success message
                showToast(`Cashbill ${cashbillId} committed successfully!`, 'success');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetCashbillForm();
                    generateNewCashbillId();
                }, 1500);
            });
            
            // Save cashbill function
            function saveCashbill(cashbill) {
                let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                
                // Check if cashbill already exists (for editing)
                const existingIndex = cashbills.findIndex(cb => cb.id === cashbill.id);
                if (existingIndex !== -1) {
                    cashbills[existingIndex] = cashbill;
                } else {
                    cashbills.push(cashbill);
                }
                
                localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                
                // Update counters
                updateCounters();
            }
            
            // Reset cashbill form
            function resetCashbillForm() {
                cashbillForm.reset();
                orderItemsContainer.innerHTML = '<div class="text-center text-muted py-3">No items added yet</div>';
                totalAmountSpan.textContent = '0.00';
                document.getElementById('cashbillDate').value = today;
                
                // Clear product suggestions
                document.getElementById('productSuggestions').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-lightbulb fa-3x mb-3"></i>
                        <p>Product suggestions will appear here</p>
                    </div>
                `;
            }
            
            document.getElementById('resetCashbillBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    resetCashbillForm();
                    generateNewCashbillId();
                }
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                // Check if there are items in the order
                if (orderItemsContainer.children.length === 0 || orderItemsContainer.querySelector('.text-center')) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get form data
                const cashbillId = document.getElementById('cashbillId').value;
                const cashbillDate = document.getElementById('cashbillDate').value;
                const customerFirstName = document.getElementById('customerFirstName').value;
                const customerLastName = document.getElementById('customerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                const notes = document.getElementById('notes').value;
                
                // Get order items
                const items = [];
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(totalAmountSpan.textContent);
                
                // Create cashbill object
                const cashbill = {
                    id: cashbillId,
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: 'draft',
                    remark: '',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save cashbill
                saveCashbill(cashbill);
                
                // Log activity
                logActivity('create', `Created draft cashbill ${cashbillId}`);
                
                showToast(`Cashbill ${cashbillId} saved as draft!`, 'info');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetCashbillForm();
                    generateNewCashbillId();
                }, 1500);
            });
            
            // Save template button
            document.getElementById('saveTemplateBtn').addEventListener('click', function() {
                // Get form data
                const customerFirstName = document.getElementById('customerFirstName').value;
                const customerLastName = document.getElementById('customerLastName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                const notes = document.getElementById('notes').value;
                
                // Get order items
                const items = [];
                orderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Create template object
                const template = {
                    name: `Template ${new Date().toLocaleDateString()}`,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save template
                let templates = JSON.parse(localStorage.getItem('pne_cashbill_templates') || '[]');
                templates.push(template);
                localStorage.setItem('pne_cashbill_templates', JSON.stringify(templates));
                
                showToast('Template saved successfully!', 'success');
            });
            
            // Load template button
            document.getElementById('loadTemplateBtn').addEventListener('click', function() {
                const templates = JSON.parse(localStorage.getItem('pne_cashbill_templates') || '[]');
                
                if (templates.length === 0) {
                    showToast('No templates available', 'warning');
                    return;
                }
                
                // For demo, just load the first template
                const template = templates[0];
                
                // Populate form with template data
                document.getElementById('customerFirstName').value = template.customer.firstName || '';
                document.getElementById('customerLastName').value = template.customer.lastName || '';
                document.getElementById('customerPhone').value = template.customer.phone || '';
                document.getElementById('customerEmail').value = template.customer.email || '';
                document.getElementById('customerAddress').value = template.customer.address || '';
                document.getElementById('paymentType').value = template.payment.type || '';
                document.getElementById('paymentStatus').value = template.payment.status || '';
                document.getElementById('notes').value = template.notes || '';
                
                // Clear existing items
                orderItemsContainer.innerHTML = '';
                
                // Add template items
                template.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cashbill-item';
                    itemElement.innerHTML = `
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            <div>${item.quantity} x RM ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add remove functionality
                    itemElement.querySelector('.remove-item').addEventListener('click', function() {
                        itemElement.remove();
                        updateTotalAmount();
                        
                        // Add placeholder back if no items
                        if (orderItemsContainer.children.length === 0) {
                            orderItemsContainer.innerHTML = '<div class="text-center text-muted py-3">No items added yet</div>';
                        }
                    });
                    
                    orderItemsContainer.appendChild(itemElement);
                });
                
                // Update total
                updateTotalAmount();
                
                showToast('Template loaded successfully!', 'success');
            });
            
            // Update customer history when phone number changes
            document.getElementById('customerPhone').addEventListener('input', function() {
                const phone = this.value;
                if (phone.length >= 3) {
                    updateCustomerHistory(phone);
                } else {
                    document.getElementById('customerHistory').innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-history fa-3x mb-3"></i>
                            <p>Enter customer details to view history</p>
                        </div>
                    `;
                }
            });
            
            // Update customer history
            function updateCustomerHistory(phone) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const customerCashbills = cashbills.filter(cb => cb.customer.phone === phone);
                
                const historyContainer = document.getElementById('customerHistory');
                
                if (customerCashbills.length > 0) {
                    let html = '<h6 class="mb-3">Previous Orders</h6>';
                    
                    customerCashbills.slice(0, 3).forEach(cb => {
                        html += `
                            <div class="border rounded p-3 mb-2">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="fw-bold">${cb.id}</div>
                                        <div class="text-muted">${cb.date}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">RM ${cb.totalAmount.toFixed(2)}</div>
                                        <div class="badge bg-${cb.status === 'committed' ? 'success' : 'warning'}">${cb.status}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    historyContainer.innerHTML = html;
                } else {
                    historyContainer.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-history fa-3x mb-3"></i>
                            <p>No previous orders found</p>
                        </div>
                    `;
                }
            }
            
            // Edit Cashbill Modal Setup
            const editCashbillModal = new bootstrap.Modal(document.getElementById('editCashbillModal'));
            const editCashbillForm = document.getElementById('editCashbillForm');
            const editProductSelect = document.getElementById('editProductSelect');
            const editQuantityInput = document.getElementById('editQuantity');
            const editPriceInput = document.getElementById('editPrice');
            const editOrderItemsContainer = document.getElementById('editOrderItems');
            const editTotalAmountSpan = document.getElementById('editTotalAmount');
            
            // Load products into edit select
            function loadProductsIntoEditSelect() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                editProductSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.icon} ${product.name} - RM ${product.regularPrice}`;
                    editProductSelect.appendChild(option);
                });
            }
            
            // Set price when product is selected in edit mode
            editProductSelect.addEventListener('change', function() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = this.value;
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        editPriceInput.value = product.regularPrice;
                    }
                } else {
                    editPriceInput.value = '';
                }
            });
            
            // Add item to edit order
            document.getElementById('addEditItemBtn').addEventListener('click', function() {
                const productId = editProductSelect.value;
                const quantity = parseInt(editQuantityInput.value) || 1;
                const price = parseFloat(editPriceInput.value) || 0;
                
                if (!productId) {
                    showToast('Please select a product', 'warning');
                    return;
                }
                
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showToast('Product not found', 'danger');
                    return;
                }
                
                // Create new item element
                const itemElement = document.createElement('div');
                itemElement.className = 'cashbill-item';
                itemElement.innerHTML = `
                    <div>
                        <div class="fw-bold">${product.icon} ${product.name}</div>
                        <div>${quantity} x RM ${price.toFixed(2)}</div>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-edit-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add remove functionality
                itemElement.querySelector('.remove-edit-item').addEventListener('click', function() {
                    itemElement.remove();
                    updateEditTotalAmount();
                });
                
                // Add to order items
                editOrderItemsContainer.appendChild(itemElement);
                
                // Update total
                updateEditTotalAmount();
                
                // Reset form
                editProductSelect.value = '';
                editQuantityInput.value = '1';
                editPriceInput.value = '';
            });
            
            // Update edit total amount
            function updateEditTotalAmount() {
                let total = 0;
                
                editOrderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        total += quantity * price;
                    }
                });
                
                editTotalAmountSpan.textContent = total.toFixed(2);
            }
            
            // Update draft button
            document.getElementById('updateDraftBtn').addEventListener('click', function() {
                updateCashbill('draft');
            });
            
            // Update and commit button
            document.getElementById('updateAndCommitBtn').addEventListener('click', function() {
                updateCashbill('committed');
            });
            
            // Update cashbill function
            function updateCashbill(newStatus) {
                // Get form data
                const cashbillId = document.getElementById('editCashbillId').value;
                const cashbillDate = document.getElementById('editCashbillDate').value;
                const customerFirstName = document.getElementById('editCustomerFirstName').value;
                const customerLastName = document.getElementById('editCustomerLastName').value;
                const customerName = `${customerFirstName} ${customerLastName}`;
                const customerPhone = document.getElementById('editCustomerPhone').value;
                const customerEmail = document.getElementById('editCustomerEmail').value;
                const customerAddress = document.getElementById('editCustomerAddress').value;
                const paymentType = document.getElementById('editPaymentType').value;
                const paymentStatus = document.getElementById('editPaymentStatus').value;
                const notes = document.getElementById('editNotes').value;
                
                // Check if there are items in the order
                if (editOrderItemsContainer.children.length === 0) {
                    showToast('Please add at least one item to the order', 'warning');
                    return;
                }
                
                // Get order items
                const items = [];
                editOrderItemsContainer.querySelectorAll('.cashbill-item').forEach(item => {
                    const name = item.querySelector('.fw-bold').textContent;
                    const text = item.querySelector('div div:last-child').textContent;
                    const match = text.match(/(\d+) x RM ([\d.]+)/);
                    
                    if (match) {
                        const quantity = parseInt(match[1]);
                        const price = parseFloat(match[2]);
                        items.push({ name, quantity, price });
                    }
                });
                
                // Calculate total
                const totalAmount = parseFloat(editTotalAmountSpan.textContent);
                
                // Get existing cashbill
                let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbillIndex = cashbills.findIndex(cb => cb.id === cashbillId);
                
                if (cashbillIndex === -1) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Update cashbill
                cashbills[cashbillIndex] = {
                    ...cashbills[cashbillIndex],
                    date: cashbillDate,
                    customer: {
                        firstName: customerFirstName,
                        lastName: customerLastName,
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail,
                        address: customerAddress
                    },
                    items: items,
                    totalAmount: totalAmount,
                    payment: {
                        type: paymentType,
                        status: paymentStatus
                    },
                    notes: notes,
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                };
                
                // Save cashbill
                localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                
                // Log activity
                logActivity('update', `Updated cashbill ${cashbillId}`);
                
                // Show success message
                const statusText = newStatus === 'draft' ? 'draft updated' : 'updated and committed';
                showToast(`Cashbill ${cashbillId} ${statusText} successfully!`, 'success');
                
                // Close modal
                editCashbillModal.hide();
                
                // Refresh data
                loadDashboardData();
                loadCashbillList();
                refreshUncommittedList();
                updateCounters();
            }
            
            // Edit cashbill function
            function editCashbill(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Only allow editing draft cashbills or if user is admin
                if (cashbill.status !== 'draft' && currentUser.role !== 'admin') {
                    showToast('Only draft cashbills can be edited', 'warning');
                    return;
                }
                
                // Set editing cashbill ID
                editingCashbillId = cashbillId;
                
                // Populate form with cashbill data
                document.getElementById('editCashbillId').value = cashbill.id;
                document.getElementById('editCashbillDate').value = cashbill.date;
                document.getElementById('editCustomerFirstName').value = cashbill.customer.firstName;
                document.getElementById('editCustomerLastName').value = cashbill.customer.lastName;
                document.getElementById('editCustomerPhone').value = cashbill.customer.phone;
                document.getElementById('editCustomerEmail').value = cashbill.customer.email || '';
                document.getElementById('editCustomerAddress').value = cashbill.customer.address;
                document.getElementById('editPaymentType').value = cashbill.payment.type;
                document.getElementById('editPaymentStatus').value = cashbill.payment.status;
                document.getElementById('editNotes').value = cashbill.notes || '';
                
                // Populate order items
                editOrderItemsContainer.innerHTML = '';
                cashbill.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cashbill-item';
                    itemElement.innerHTML = `
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            <div>${item.quantity} x RM ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-edit-item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add remove functionality
                    itemElement.querySelector('.remove-edit-item').addEventListener('click', function() {
                        itemElement.remove();
                        updateEditTotalAmount();
                    });
                    
                    editOrderItemsContainer.appendChild(itemElement);
                });
                
                // Update total
                updateEditTotalAmount();
                
                // Load products into select
                loadProductsIntoEditSelect();
                
                // Show modal
                editCashbillModal.show();
            }
            
            // Delete cashbill function
            function deleteCashbill(cashbillId) {
                if (confirm(`Are you sure you want to delete cashbill ${cashbillId}? This action cannot be undone.`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    cashbills = cashbills.filter(cb => cb.id !== cashbillId);
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    // Log activity
                    logActivity('delete', `Deleted cashbill ${cashbillId}`);
                    
                    showToast(`Cashbill ${cashbillId} deleted successfully!`, 'success');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            }
            
            // Uncommit cashbill function (admin only)
            function uncommitCashbill(cashbillId) {
                if (confirm(`Are you sure you want to uncommit cashbill ${cashbillId}? This will change its status back to draft.`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    const cashbill = cashbills.find(cb => cb.id === cashbillId);
                    
                    if (cashbill) {
                        cashbill.status = 'draft';
                        cashbill.updatedAt = new Date().toISOString();
                        localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                        
                        // Log activity
                        logActivity('update', `Uncommitted cashbill ${cashbillId}`);
                        
                        showToast(`Cashbill ${cashbillId} uncommitted successfully!`, 'success');
                        
                        // Refresh data
                        loadDashboardData();
                        loadCashbillList();
                        refreshUncommittedList();
                        updateCounters();
                    }
                }
            }
            
            // Add remark to cashbill function
            function addRemark(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Set cashbill ID in modal
                document.getElementById('remarkCashbillId').value = cashbillId;
                
                // Set current remark if exists
                document.getElementById('remarkText').value = cashbill.remark || '';
                
                // Show modal
                const remarkModal = new bootstrap.Modal(document.getElementById('remarkModal'));
                remarkModal.show();
            }
            
            // Save remark button
            document.getElementById('saveRemarkBtn').addEventListener('click', function() {
                const cashbillId = document.getElementById('remarkCashbillId').value;
                const remarkText = document.getElementById('remarkText').value;
                
                let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbillIndex = cashbills.findIndex(cb => cb.id === cashbillId);
                
                if (cashbillIndex === -1) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Update remark
                cashbills[cashbillIndex].remark = remarkText;
                cashbills[cashbillIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                
                // Log activity
                logActivity('update', `Added remark to cashbill ${cashbillId}`);
                
                showToast('Remark saved successfully!', 'success');
                
                // Close modal
                const remarkModal = bootstrap.Modal.getInstance(document.getElementById('remarkModal'));
                remarkModal.hide();
                
                // Refresh data
                loadCashbillList();
            });
            
            // Logbook form handling
            const logbookForm = document.getElementById('logbookForm');
            
            logbookForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const logbookId = document.getElementById('logbookId').value;
                const logbookDate = document.getElementById('logbookDate').value;
                const cashbillRef = document.getElementById('cashbillRef').value;
                const trackingNumber = document.getElementById('trackingNumber').value;
                const courierName = document.getElementById('courierName').value;
                const deliveryStatus = document.getElementById('deliveryStatus').value;
                const deliveryAddress = document.getElementById('deliveryAddress').value;
                const deliveryDate = document.getElementById('deliveryDate').value;
                const deliveryTime = document.getElementById('deliveryTime').value;
                const logbookNotes = document.getElementById('logbookNotes').value;
                
                // Create logbook object
                const logbook = {
                    id: logbookId,
                    date: logbookDate,
                    cashbillRef: cashbillRef,
                    trackingNumber: trackingNumber,
                    courierName: courierName,
                    deliveryStatus: deliveryStatus,
                    deliveryAddress: deliveryAddress,
                    expectedDelivery: {
                        date: deliveryDate,
                        time: deliveryTime
                    },
                    notes: logbookNotes,
                    status: 'saved',
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save logbook
                saveLogbook(logbook);
                
                // Log activity
                logActivity('create', `Created logbook ${logbookId}`);
                
                showToast(`Logbook ${logbookId} saved successfully!`, 'success');
                
                // Reset form after a delay
                setTimeout(() => {
                    resetLogbookForm();
                    generateNewLogbookId();
                }, 1500);
            });
            
            // Save logbook function
            function saveLogbook(logbook) {
                let logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                
                // Check if logbook already exists (for editing)
                const existingIndex = logbooks.findIndex(lb => lb.id === logbook.id);
                if (existingIndex !== -1) {
                    logbooks[existingIndex] = logbook;
                } else {
                    logbooks.push(logbook);
                }
                
                localStorage.setItem('pne_logbooks', JSON.stringify(logbooks));
            }
            
            // Reset logbook form
            function resetLogbookForm() {
                logbookForm.reset();
                document.getElementById('logbookDate').value = today;
                
                // Clear delivery map
                document.getElementById('deliveryMap').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Enter delivery address to show map</p>
                    </div>
                `;
                
                // Clear delivery timeline
                document.getElementById('deliveryTimeline').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-clock fa-3x mb-3"></i>
                        <p>Delivery timeline will appear here</p>
                    </div>
                `;
            }
            
            document.getElementById('resetLogbookBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                    resetLogbookForm();
                    generateNewLogbookId();
                }
            });
            
            // Save logbook draft
            document.getElementById('saveLogbookDraftBtn').addEventListener('click', function() {
                const logbookId = document.getElementById('logbookId').value;
                showToast(`Logbook ${logbookId} saved as draft!`, 'info');
            });
            
            // Update delivery map when address changes
            document.getElementById('deliveryAddress').addEventListener('input', function() {
                const address = this.value;
                if (address.length > 5) {
                    updateDeliveryMap(address);
                } else {
                    document.getElementById('deliveryMap').innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Enter delivery address to show map</p>
                        </div>
                    `;
                }
            });
            
            // Update delivery map
            function updateDeliveryMap(address) {
                // In a real app, this would integrate with Google Maps or similar
                // For demo, we'll just show a placeholder
                document.getElementById('deliveryMap').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-map-marked-alt fa-3x text-primary mb-3"></i>
                        <p class="fw-bold">Delivery Location</p>
                        <p>${address}</p>
                        <button class="btn btn-sm btn-outline-primary mt-2">Open in Maps</button>
                    </div>
                `;
                
                // Update delivery timeline
                updateDeliveryTimeline();
            }
            
            // Update delivery timeline
            function updateDeliveryTimeline() {
                const timelineContainer = document.getElementById('deliveryTimeline');
                
                const timeline = [
                    { status: 'Order Placed', time: 'Today, 10:30 AM', completed: true },
                    { status: 'Preparing', time: 'Today, 11:00 AM', completed: true },
                    { status: 'Ready for Pickup', time: 'Today, 1:00 PM', completed: false },
                    { status: 'In Transit', time: 'Today, 2:00 PM', completed: false },
                    { status: 'Delivered', time: 'Today, 4:00 PM', completed: false }
                ];
                
                let html = '<h6 class="mb-3">Delivery Timeline</h6><div class="status-timeline">';
                
                timeline.forEach((item, index) => {
                    html += `
                        <div class="timeline-step ${item.completed ? 'completed' : ''}">
                            <div class="step-icon">
                                ${item.completed ? '<i class="fas fa-check"></i>' : (index === 2 ? '<i class="fas fa-truck"></i>' : '<i class="fas fa-clock"></i>')}
                            </div>
                            <div class="step-label">${item.status}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                timelineContainer.innerHTML = html;
            }
            
            // Product management
            const addProductBtn = document.getElementById('addProductBtn');
            const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            const saveProductBtn = document.getElementById('saveProductBtn');
            const importProductsBtn = document.getElementById('importProductsBtn');
            
            addProductBtn.addEventListener('click', function() {
                // Only allow admin to add products
                if (currentUser && currentUser.role === 'admin') {
                    addProductModal.show();
                } else {
                    showToast('You do not have permission to add products', 'danger');
                }
            });
            
            saveProductBtn.addEventListener('click', function() {
                // Get form data
                const productName = document.getElementById('productName').value;
                const productIcon = document.getElementById('productIcon').value;
                const productCategory = document.getElementById('productCategory').value;
                const productSku = document.getElementById('productSku').value;
                const regularPrice = parseFloat(document.getElementById('regularPrice').value);
                const memberPrice = parseFloat(document.getElementById('memberPrice').value);
                const productUnit = document.getElementById('productUnit').value;
                const minOrder = parseInt(document.getElementById('minOrder').value) || 0;
                const stockQuantity = parseInt(document.getElementById('stockQuantity').value) || 0;
                const reorderLevel = parseInt(document.getElementById('reorderLevel').value) || 0;
                const productDescription = document.getElementById('productDescription').value;
                const productFeatures = document.getElementById('productFeatures').value;
                const productImage = document.getElementById('productImage').value;
                
                // Generate product ID and SKU if not provided
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productId = `PROD-${String(products.length + 1).padStart(3, '0')}`;
                const sku = productSku || `SKU-${String(products.length + 1).padStart(4, '0')}`;
                
                // Create product object
                const product = {
                    id: productId,
                    name: productName,
                    icon: productIcon,
                    category: productCategory,
                    sku: sku,
                    regularPrice: regularPrice,
                    memberPrice: memberPrice,
                    unit: productUnit,
                    minOrder: minOrder,
                    stockQuantity: stockQuantity,
                    reorderLevel: reorderLevel,
                    description: productDescription,
                    features: productFeatures.split('\n').filter(f => f.trim() !== ''),
                    image: productImage,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save product
                products.push(product);
                localStorage.setItem('pne_products', JSON.stringify(products));
                
                // Log activity
                logActivity('create', `Added product ${productName}`);
                
                showToast(`Product "${productName}" added successfully!`, 'success');
                addProductModal.hide();
                document.getElementById('addProductForm').reset();
                
                // Reload products
                loadProducts();
                loadProductsIntoSelect();
                loadProductsIntoEditSelect();
            });
            
            // Import products button
            importProductsBtn.addEventListener('click', function() {
                // Create a hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv,.json';
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            let data;
                            
                            if (file.name.endsWith('.json')) {
                                data = JSON.parse(event.target.result);
                            } else if (file.name.endsWith('.csv')) {
                                // Simple CSV parsing (for demo purposes)
                                const lines = event.target.result.split('\n');
                                const headers = lines[0].split(',');
                                
                                data = [];
                                for (let i = 1; i < lines.length; i++) {
                                    if (lines[i].trim() === '') continue;
                                    
                                    const values = lines[i].split(',');
                                    const product = {};
                                    
                                    headers.forEach((header, index) => {
                                        product[header.trim()] = values[index] ? values[index].trim() : '';
                                    });
                                    
                                    data.push(product);
                                }
                            }
                            
                            // Process and save products
                            const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                            let importedCount = 0;
                            
                            data.forEach(item => {
                                if (item.name && item.regularPrice) {
                                    const productId = `PROD-${String(products.length + importedCount + 1).padStart(3, '0')}`;
                                    
                                    const product = {
                                        id: productId,
                                        name: item.name,
                                        icon: item.icon || '📦',
                                        category: item.category || 'uncategorized',
                                        sku: item.sku || `SKU-${String(products.length + importedCount + 1).padStart(4, '0')}`,
                                        regularPrice: parseFloat(item.regularPrice) || 0,
                                        memberPrice: parseFloat(item.memberPrice) || 0,
                                        unit: item.unit || 'each',
                                        minOrder: parseInt(item.minOrder) || 0,
                                        stockQuantity: parseInt(item.stockQuantity) || 0,
                                        reorderLevel: parseInt(item.reorderLevel) || 0,
                                        description: item.description || '',
                                        features: item.features ? item.features.split(';') : [],
                                        image: item.image || '',
                                        createdBy: currentUser.username,
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    products.push(product);
                                    importedCount++;
                                }
                            });
                            
                            localStorage.setItem('pne_products', JSON.stringify(products));
                            
                            // Log activity
                            logActivity('import', `Imported ${importedCount} products`);
                            
                            showToast(`Successfully imported ${importedCount} products!`, 'success');
                            
                            // Reload products
                            loadProducts();
                            loadProductsIntoSelect();
                            loadProductsIntoEditSelect();
                            
                        } catch (error) {
                            showToast('Error importing products: ' + error.message, 'danger');
                        }
                    };
                    
                    reader.readAsText(file);
                });
                
                fileInput.click();
            });
            
            // Load products function
            function loadProducts() {
                const products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                const productsList = document.getElementById('productsList');
                
                productsList.innerHTML = '';
                
                if (products.length === 0) {
                    productsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No products found</p></div>';
                    return;
                }
                
                // Apply filters if on products page
                let filteredProducts = [...products];
                
                if (currentSection === 'products') {
                    const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
                    const categoryFilter = document.getElementById('filterCategory').value;
                    const sortBy = document.getElementById('sortBy').value;
                    
                    // Apply search filter
                    if (searchTerm) {
                        filteredProducts = filteredProducts.filter(product => 
                            product.name.toLowerCase().includes(searchTerm) ||
                            product.description.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Apply category filter
                    if (categoryFilter) {
                        filteredProducts = filteredProducts.filter(product => product.category === categoryFilter);
                    }
                    
                    // Apply sorting
                    if (sortBy === 'name') {
                        filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                    } else if (sortBy === 'price-low') {
                        filteredProducts.sort((a, b) => a.regularPrice - b.regularPrice);
                    } else if (sortBy === 'price-high') {
                        filteredProducts.sort((a, b) => b.regularPrice - a.regularPrice);
                    } else if (sortBy === 'newest') {
                        filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    }
                }
                
                filteredProducts.forEach(product => {
                    const featuresHtml = product.features.map(f => `<div>${f}</div>`).join('');
                    
                    const stockStatus = product.stockQuantity > product.reorderLevel ? 
                        `<span class="badge bg-success">In Stock (${product.stockQuantity})</span>` : 
                        `<span class="badge bg-warning">Low Stock (${product.stockQuantity})</span>`;
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'col-md-4 mb-4';
                    productElement.innerHTML = `
                        <div class="product-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="product-name">${product.icon} ${product.name}</div>
                                ${stockStatus}
                            </div>
                            <div class="price-tag">Price: RM ${product.regularPrice} ${product.unit}</div>
                            <div class="member-price">Member Price: RM ${product.memberPrice} ${product.unit}</div>
                            ${product.description ? `<div class="mt-2">${product.description}</div>` : ''}
                            ${featuresHtml ? `<div class="mt-2">${featuresHtml}</div>` : ''}
                            ${product.minOrder > 0 ? `<div class="min-order">Minimum Order: ${product.minOrder} ${product.unit}</div>` : ''}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary me-1 admin-only edit-product" data-id="${product.id}">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger admin-only delete-product" data-id="${product.id}">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    
                    productsList.appendChild(productElement);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            showToast('Edit product functionality would open here', 'info');
                        } else {
                            showToast('You do not have permission to edit products', 'danger');
                        }
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            const productId = this.getAttribute('data-id');
                            deleteProduct(productId);
                        } else {
                            showToast('You do not have permission to delete products', 'danger');
                        }
                    });
                });
                
                // Add event listeners to filters if on products page
                if (currentSection === 'products') {
                    document.getElementById('searchProduct').addEventListener('input', loadProducts);
                    document.getElementById('filterCategory').addEventListener('change', loadProducts);
                    document.getElementById('sortBy').addEventListener('change', loadProducts);
                }
            }
            
            // Delete product function
            function deleteProduct(productId) {
                if (confirm('Are you sure you want to delete this product?')) {
                    let products = JSON.parse(localStorage.getItem('pne_products') || '[]');
                    const product = products.find(p => p.id === productId);
                    
                    if (product) {
                        products = products.filter(p => p.id !== productId);
                        localStorage.setItem('pne_products', JSON.stringify(products));
                        
                        // Log activity
                        logActivity('delete', `Deleted product ${product.name}`);
                        
                        showToast('Product deleted successfully', 'success');
                        loadProducts();
                        loadProductsIntoSelect();
                        loadProductsIntoEditSelect();
                    }
                }
            }
            
            // Staff management
            const addStaffBtn = document.getElementById('addStaffBtn');
            const addStaffModal = new bootstrap.Modal(document.getElementById('addStaffModal'));
            const saveStaffBtn = document.getElementById('saveStaffBtn');
            
            addStaffBtn.addEventListener('click', function() {
                // Only allow admin to add staff
                if (currentUser && currentUser.role === 'admin') {
                    addStaffModal.show();
                } else {
                    showToast('You do not have permission to add staff', 'danger');
                }
            });
            
            saveStaffBtn.addEventListener('click', function() {
                // Get form data
                const staffFirstName = document.getElementById('staffFirstName').value;
                const staffLastName = document.getElementById('staffLastName').value;
                const staffName = `${staffFirstName} ${staffLastName}`;
                const staffUsername = document.getElementById('staffUsername').value;
                const staffPassword = document.getElementById('staffPassword').value;
                const staffEmail = document.getElementById('staffEmail').value;
                const staffPhone = document.getElementById('staffPhone').value;
                const staffRole = document.getElementById('staffRole').value;
                
                // Check if username already exists
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                if (users.find(u => u.username === staffUsername)) {
                    showToast('Staff ID already exists', 'danger');
                    return;
                }
                
                // Create user object
                const user = {
                    username: staffUsername,
                    password: staffPassword,
                    name: staffName,
                    email: staffEmail,
                    phone: staffPhone,
                    role: staffRole,
                    status: 'active',
                    lastLogin: null,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                
                // Save user
                users.push(user);
                localStorage.setItem('pne_users', JSON.stringify(users));
                
                // Log activity
                logActivity('create', `Added staff member ${staffName}`);
                
                showToast(`Staff "${staffName}" added successfully!`, 'success');
                addStaffModal.hide();
                document.getElementById('addStaffForm').reset();
                
                // Reload staff
                loadStaff();
            });
            
            // Load staff function
            function loadStaff() {
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                const staffTable = document.getElementById('staffTable');
                
                staffTable.innerHTML = '';
                
                if (users.length === 0) {
                    staffTable.innerHTML = '<tr><td colspan="7" class="text-center">No staff found</td></tr>';
                    return;
                }
                
                users.forEach(user => {
                    const lastLogin = user.lastLogin ? 
                        new Date(user.lastLogin).toLocaleString() : 
                        '<span class="text-muted">Never</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.username}</td>
                        <td><span class="user-role ${user.role === 'admin' ? 'role-admin' : 'role-staff'}">${user.role === 'admin' ? 'Admin' : 'Crew'}</span></td>
                        <td><span class="badge bg-${user.status === 'active' ? 'success' : 'danger'}">${user.status}</span></td>
                        <td>${lastLogin}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1 admin-only edit-staff" data-username="${user.username}">
                                <i class="fas fa-edit me-1"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger admin-only delete-staff" data-username="${user.username}">
                                <i class="fas fa-trash me-1"></i> Delete
                            </button>
                        </td>
                    `;
                    
                    staffTable.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-staff').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            showToast('Edit staff functionality would open here', 'info');
                        } else {
                            showToast('You do not have permission to edit staff', 'danger');
                        }
                    });
                });
                
                document.querySelectorAll('.delete-staff').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (currentUser && currentUser.role === 'admin') {
                            const username = this.getAttribute('data-username');
                            deleteStaff(username);
                        } else {
                            showToast('You do not have permission to delete staff', 'danger');
                        }
                    });
                });
            }
            
            // Delete staff function
            function deleteStaff(username) {
                if (confirm('Are you sure you want to delete this staff member?')) {
                    let users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                    const user = users.find(u => u.username === username);
                    
                    if (user) {
                        users = users.filter(u => u.username !== username);
                        localStorage.setItem('pne_users', JSON.stringify(users));
                        
                        // Log activity
                        logActivity('delete', `Deleted staff member ${user.name}`);
                        
                        showToast('Staff member deleted successfully', 'success');
                        loadStaff();
                    }
                }
            }
            
            // Load dashboard data
            function loadDashboardData() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                
                // Update counters
                document.getElementById('totalCashbills').textContent = cashbills.length;
                document.getElementById('completedCashbills').textContent = cashbills.filter(cb => cb.status === 'committed').length;
                document.getElementById('pendingCashbills').textContent = cashbills.filter(cb => cb.status === 'draft').length;
                
                // Calculate total revenue
                const totalRevenue = cashbills
                    .filter(cb => cb.status === 'committed')
                    .reduce((sum, cb) => sum + cb.totalAmount, 0);
                document.getElementById('totalRevenue').textContent = `RM ${totalRevenue.toLocaleString()}`;
                
                // Load recent cashbills
                loadRecentCashbills();
            }
            
            // Load recent cashbills
            function loadRecentCashbills() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const recentCashbillsTable = document.getElementById('recentCashbillsTable');
                
                recentCashbillsTable.innerHTML = '';
                
                if (cashbills.length === 0) {
                    recentCashbillsTable.innerHTML = '<tr><td colspan="6" class="text-center">No cashbills found</td></tr>';
                    return;
                }
                
                // Sort by date (newest first) and take first 5
                const sortedCashbills = [...cashbills]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5);
                
                sortedCashbills.forEach(cashbill => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cashbill.id}</td>
                        <td>${cashbill.customer.name}</td>
                        <td>${cashbill.date}</td>
                        <td>RM ${cashbill.totalAmount.toFixed(2)}</td>
                        <td><span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary view-cashbill" data-id="${cashbill.id}">
                                <i class="fas fa-eye me-1"></i> View
                            </button>
                        </td>
                    `;
                    
                    recentCashbillsTable.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-cashbill').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const cashbillId = this.getAttribute('data-id');
                        viewCashbillDetails(cashbillId);
                    });
                });
            }
            
            // Load cashbill list
            function loadCashbillList() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const allCashbillsTable = document.getElementById('allCashbillsTable');
                
                // Clear existing table
                if ($.fn.DataTable.isDataTable('#allCashbillsTable')) {
                    $('#allCashbillsTable').DataTable().destroy();
                }
                
                allCashbillsTable.innerHTML = '';
                
                if (cashbills.length === 0) {
                    allCashbillsTable.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                                    <h4>No Cashbills Found</h4>
                                    <p>Start by creating your first cashbill</p>
                                    <button class="btn btn-primary" id="createFirstCashbillBtn">
                                        <i class="fas fa-plus me-2"></i> Create Cashbill
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    // Add event listener to create first cashbill button
                    document.getElementById('createFirstCashbillBtn')?.addEventListener('click', function() {
                        showSection('cashbill');
                        generateNewCashbillId();
                    });
                    
                    return;
                }
                
                // Sort by date (newest first)
                const sortedCashbills = [...cashbills]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Get users for crew information
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                
                sortedCashbills.forEach((cashbill, index) => {
                    // Find the user who created the cashbill
                    const user = users.find(u => u.username === cashbill.createdBy);
                    const userName = user ? user.name : 'Unknown';
                    
                    const remarkBadge = cashbill.remark ? 
                        `<span class="remark-badge remark-tooltip">
                            <i class="fas fa-comment"></i>
                            <span class="tooltiptext">${cashbill.remark}</span>
                        </span>` : '';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${cashbill.id}</td>
                        <td>${cashbill.date}</td>
                        <td>${cashbill.customer.name}</td>
                        <td>RM ${cashbill.totalAmount.toFixed(2)}</td>
                        <td>${userName}</td>
                        <td>${cashbill.createdBy}</td>
                        <td>
                            <span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span>
                            ${remarkBadge}
                        </td>
                        <td>
                            <div class="cashbill-actions">
                                <button class="btn btn-sm action-btn view" data-id="${cashbill.id}" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${cashbill.status === 'draft' ? `
                                    <button class="btn btn-sm action-btn edit" data-id="${cashbill.id}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm action-btn delete" data-id="${cashbill.id}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${currentUser.role === 'admin' ? `
                                    <button class="btn btn-sm action-btn uncommit" data-id="${cashbill.id}" title="Uncommit">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-sm action-btn delete" data-id="${cashbill.id}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm action-btn remark" data-id="${cashbill.id}" title="Add Remark">
                                    <i class="fas fa-comment"></i>
                                </button>
                                ${cashbill.status === 'draft' && currentUser.role === 'admin' ? `
                                    <button class="btn btn-sm action-btn commit" data-id="${cashbill.id}" title="Commit">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    allCashbillsTable.appendChild(row);
                });
                
                // Add event listeners to buttons using event delegation
                allCashbillsTable.addEventListener('click', function(e) {
                    const target = e.target;
                    const button = target.closest('button');
                    
                    if (!button) return;
                    
                    const cashbillId = button.getAttribute('data-id');
                    
                    if (button.classList.contains('view')) {
                        viewCashbillDetails(cashbillId);
                    } else if (button.classList.contains('edit')) {
                        editCashbill(cashbillId);
                    } else if (button.classList.contains('delete')) {
                        deleteCashbill(cashbillId);
                    } else if (button.classList.contains('uncommit')) {
                        uncommitCashbill(cashbillId);
                    } else if (button.classList.contains('remark')) {
                        addRemark(cashbillId);
                    } else if (button.classList.contains('commit')) {
                        approveCashbill(cashbillId);
                    }
                });
                
                // Initialize DataTable
                setTimeout(() => {
                    $('#allCashbillsTable').DataTable({
                        responsive: true,
                        pageLength: 10,
                        order: [[2, 'desc']]
                    });
                }, 100);
                
                // Add filter functionality
                setupCashbillFilters();
            }
            
            // Setup cashbill filters
            function setupCashbillFilters() {
                const searchInput = document.getElementById('searchCashbill');
                const statusFilter = document.getElementById('filterStatus');
                const dateFilter = document.getElementById('filterDate');
                const clearBtn = document.getElementById('clearFiltersBtn');
                
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusValue = statusFilter.value;
                    const dateValue = dateFilter.value;
                    
                    const table = $('#allCashbillsTable').DataTable();
                    
                    // Search global filter
                    table.search(searchTerm).draw();
                    
                    // Custom filtering for status and date
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        const status = data[7]; // Status column
                        const date = data[2]; // Date column
                        
                        // Status filter
                        if (statusValue && !status.includes(statusValue)) {
                            return false;
                        }
                        
                        // Date filter
                        if (dateValue && date !== dateValue) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    table.draw();
                }
                
                searchInput.addEventListener('input', applyFilters);
                statusFilter.addEventListener('change', applyFilters);
                dateFilter.addEventListener('change', applyFilters);
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    statusFilter.value = '';
                    dateFilter.value = '';
                    
                    const table = $('#allCashbillsTable').DataTable();
                    table.search('').columns().search('').draw();
                });
            }
            
            // Load logbook list
            function loadLogbookList() {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const allLogbooksTable = document.getElementById('allLogbooksTable');
                
                // Clear existing table
                if ($.fn.DataTable.isDataTable('#allLogbooksTable')) {
                    $('#allLogbooksTable').DataTable().destroy();
                }
                
                allLogbooksTable.innerHTML = '';
                
                if (logbooks.length === 0) {
                    allLogbooksTable.innerHTML = '<tr><td colspan="10" class="text-center">No logbooks found</td></tr>';
                    return;
                }
                
                // Sort by date (newest first)
                const sortedLogbooks = [...logbooks]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Get users for crew information
                const users = JSON.parse(localStorage.getItem('pne_users') || '[]');
                
                sortedLogbooks.forEach((logbook, index) => {
                    // Find the user who created the logbook
                    const user = users.find(u => u.username === logbook.createdBy);
                    const userName = user ? user.name : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${logbook.id}</td>
                        <td>${logbook.cashbillRef}</td>
                        <td>${logbook.courierName}</td>
                        <td>${logbook.date}</td>
                        <td><span class="status-badge status-${logbook.deliveryStatus}">${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</span></td>
                        <td>${logbook.trackingNumber || '-'}</td>
                        <td>${userName}</td>
                        <td>${logbook.createdBy}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-logbook" data-id="${logbook.id}">
                                <i class="fas fa-eye me-1"></i> View
                            </button>
                        </td>
                    `;
                    
                    allLogbooksTable.appendChild(row);
                });
                
                // Add event listeners to buttons using event delegation
                allLogbooksTable.addEventListener('click', function(e) {
                    const target = e.target;
                    const button = target.closest('button');
                    
                    if (!button) return;
                    
                    const logbookId = button.getAttribute('data-id');
                    
                    if (button.classList.contains('view-logbook')) {
                        viewLogbookDetails(logbookId);
                    }
                });
                
                // Initialize DataTable
                setTimeout(() => {
                    $('#allLogbooksTable').DataTable({
                        responsive: true,
                        pageLength: 10,
                        order: [[4, 'desc']]
                    });
                }, 100);
                
                // Add filter functionality
                setupLogbookFilters();
            }
            
            // Setup logbook filters
            function setupLogbookFilters() {
                const searchInput = document.getElementById('searchLogbook');
                const statusFilter = document.getElementById('filterDeliveryStatus');
                const dateFilter = document.getElementById('filterLogbookDate');
                const clearBtn = document.getElementById('clearLogbookFiltersBtn');
                
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusValue = statusFilter.value;
                    const dateValue = dateFilter.value;
                    
                    const table = $('#allLogbooksTable').DataTable();
                    
                    // Search global filter
                    table.search(searchTerm).draw();
                    
                    // Custom filtering for status and date
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        const status = data[5]; // Status column
                        const date = data[4]; // Date column
                        
                        // Status filter
                        if (statusValue && !status.includes(statusValue.replace('-', ' '))) {
                            return false;
                        }
                        
                        // Date filter
                        if (dateValue && date !== dateValue) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    table.draw();
                }
                
                searchInput.addEventListener('input', applyFilters);
                statusFilter.addEventListener('change', applyFilters);
                dateFilter.addEventListener('change', applyFilters);
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    statusFilter.value = '';
                    dateFilter.value = '';
                    
                    const table = $('#allLogbooksTable').DataTable();
                    table.search('').columns().search('').draw();
                });
            }
            
            // Update cashbill reference dropdown
            function updateCashbillRef() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbillRef = document.getElementById('cashbillRef');
                
                cashbillRef.innerHTML = '<option value="">-- Select Cashbill --</option>';
                
                cashbills.forEach(cashbill => {
                    const option = document.createElement('option');
                    option.value = cashbill.id;
                    option.textContent = `${cashbill.id} - ${cashbill.customer.name}`;
                    cashbillRef.appendChild(option);
                });
            }
            
            // View cashbill details function
            function viewCashbillDetails(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Set modal title
                document.getElementById('viewCashbillModalLabel').textContent = `Cashbill Details - ${cashbillId}`;
                
                // Populate modal with cashbill details
                const cashbillDetails = document.getElementById('cashbillDetails');
                cashbillDetails.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Cashbill ID:</strong> ${cashbill.id}</p>
                            <p><strong>Customer:</strong> ${cashbill.customer.name}</p>
                            <p><strong>Date:</strong> ${cashbill.date}</p>
                            <p><strong>Phone:</strong> ${cashbill.customer.phone}</p>
                            <p><strong>Email:</strong> ${cashbill.customer.email || '-'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span class="status-badge status-${cashbill.status}">${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</span></p>
                            <p><strong>Created By:</strong> ${cashbill.createdBy}</p>
                            <p><strong>Payment Type:</strong> ${cashbill.payment.type}</p>
                            <p><strong>Payment Status:</strong> ${cashbill.payment.status}</p>
                            <p><strong>Total Amount:</strong> RM ${cashbill.totalAmount.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Address:</strong> ${cashbill.customer.address}</p>
                    </div>
                    
                    ${cashbill.remark ? `
                    <div class="mb-3">
                        <p><strong>Remark:</strong> ${cashbill.remark}</p>
                    </div>
                    ` : ''}
                    
                    ${cashbill.notes ? `<div class="mb-3"><p><strong>Notes:</strong> ${cashbill.notes}</p></div>` : ''}
                    
                    <h5 class="mt-4 mb-3">Order Items</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cashbill.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>RM ${item.price.toFixed(2)}</td>
                                        <td>RM ${(item.quantity * item.price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td><strong>RM ${cashbill.totalAmount.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Show modal
                const viewCashbillModal = new bootstrap.Modal(document.getElementById('viewCashbillModal'));
                viewCashbillModal.show();
            }
            
            // View logbook details function
            function viewLogbookDetails(logbookId) {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const logbook = logbooks.find(lb => lb.id === logbookId);
                
                if (!logbook) {
                    showToast('Logbook not found', 'danger');
                    return;
                }
                
                // Set modal title
                document.getElementById('viewLogbookModalLabel').textContent = `Logbook Details - ${logbookId}`;
                
                // Populate modal with logbook details
                const logbookDetails = document.getElementById('logbookDetails');
                logbookDetails.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Logbook ID:</strong> ${logbook.id}</p>
                            <p><strong>Cashbill Ref:</strong> ${logbook.cashbillRef}</p>
                            <p><strong>Date:</strong> ${logbook.date}</p>
                            <p><strong>Courier Name:</strong> ${logbook.courierName}</p>
                            <p><strong>Tracking Number:</strong> ${logbook.trackingNumber || '-'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Delivery Status:</strong> <span class="status-badge status-${logbook.deliveryStatus}">${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</span></p>
                            <p><strong>Expected Delivery Date:</strong> ${logbook.expectedDelivery.date || '-'}</p>
                            <p><strong>Expected Delivery Time:</strong> ${logbook.expectedDelivery.time || '-'}</p>
                            <p><strong>Created By:</strong> ${logbook.createdBy}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Delivery Address:</strong> ${logbook.deliveryAddress}</p>
                    </div>
                    
                    ${logbook.notes ? `<div class="mb-3"><p><strong>Notes:</strong> ${logbook.notes}</p></div>` : ''}
                `;
                
                // Show modal
                const viewLogbookModal = new bootstrap.Modal(document.getElementById('viewLogbookModal'));
                viewLogbookModal.show();
            }
            
            // Print cashbill button
            document.getElementById('printCashbillBtn').addEventListener('click', function() {
                const cashbillId = document.querySelector('#viewCashbillModal .modal-title').textContent.split(' - ')[1];
                printCashbill(cashbillId);
            });
            
            // Email cashbill button
            document.getElementById('emailCashbillBtn').addEventListener('click', function() {
                const cashbillId = document.querySelector('#viewCashbillModal .modal-title').textContent.split(' - ')[1];
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (cashbill && cashbill.customer.email) {
                    showToast(`Cashbill sent to ${cashbill.customer.email}`, 'success');
                } else {
                    showToast('Customer email not available', 'warning');
                }
            });
            
            // Print logbook button
            document.getElementById('printLogbookBtn').addEventListener('click', function() {
                const logbookId = document.querySelector('#viewLogbookModal .modal-title').textContent.split(' - ')[1];
                printLogbook(logbookId);
            });
            
            // Email logbook button
            document.getElementById('emailLogbookBtn').addEventListener('click', function() {
                showToast('Logbook email functionality would be implemented here', 'info');
            });
            
            // Print cashbill function
            function printCashbill(cashbillId) {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const cashbill = cashbills.find(cb => cb.id === cashbillId);
                
                if (!cashbill) {
                    showToast('Cashbill not found', 'danger');
                    return;
                }
                
                // Populate print template
                document.getElementById('printCashbillInfo').innerHTML = `
                    <p><strong>Cashbill ID:</strong> ${cashbill.id}</p>
                    <p><strong>Date:</strong> ${cashbill.date}</p>
                    <p><strong>Status:</strong> ${cashbill.status.charAt(0).toUpperCase() + cashbill.status.slice(1)}</p>
                `;
                
                document.getElementById('printCustomerInfo').innerHTML = `
                    <p><strong>Name:</strong> ${cashbill.customer.name}</p>
                    <p><strong>Phone:</strong> ${cashbill.customer.phone}</p>
                    <p><strong>Email:</strong> ${cashbill.customer.email || '-'}</p>
                    <p><strong>Address:</strong> ${cashbill.customer.address}</p>
                `;
                
                const itemsHtml = cashbill.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>RM ${item.price.toFixed(2)}</td>
                        <td>RM ${(item.quantity * item.price).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                document.getElementById('printOrderItems').innerHTML = `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td><strong>RM ${cashbill.totalAmount.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                
                document.getElementById('printPaymentInfo').innerHTML = `
                    <p><strong>Payment Type:</strong> ${cashbill.payment.type}</p>
                    <p><strong>Payment Status:</strong> ${cashbill.payment.status}</p>
                `;
                
                // Print the document
                window.print();
            }
            
            // Print logbook function
            function printLogbook(logbookId) {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const logbook = logbooks.find(lb => lb.id === logbookId);
                
                if (!logbook) {
                    showToast('Logbook not found', 'danger');
                    return;
                }
                
                // Create a simple print window
                const printContent = `
                    <html>
                    <head>
                        <title>Logbook - ${logbook.id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: var(--primary-color); }
                            .section { margin-bottom: 20px; }
                            .label { font-weight: bold; }
                            .status-badge { 
                                display: inline-block; 
                                padding: 4px 8px; 
                                border-radius: 12px; 
                                font-size: 0.8rem; 
                                font-weight: 600; 
                                color: white; 
                            }
                            .status-preparing { background-color: var(--warning-color); }
                            .status-picked-up { background-color: var(--info-color); }
                            .status-in-transit { background-color: var(--primary-color); }
                            .status-delivered { background-color: var(--success-color); }
                            .status-returned { background-color: var(--danger-color); }
                        </style>
                    </head>
                    <body>
                        <h1>Logbook Details</h1>
                        <div class="section">
                            <p><span class="label">Logbook ID:</span> ${logbook.id}</p>
                            <p><span class="label">Cashbill Ref:</span> ${logbook.cashbillRef}</p>
                            <p><span class="label">Date:</span> ${logbook.date}</p>
                            <p><span class="label">Courier Name:</span> ${logbook.courierName}</p>
                            <p><span class="label">Tracking Number:</span> ${logbook.trackingNumber || '-'}</p>
                            <p><span class="label">Delivery Status:</span> <span class="status-badge status-${logbook.deliveryStatus}">${logbook.deliveryStatus.replace('-', ' ').charAt(0).toUpperCase() + logbook.deliveryStatus.replace('-', ' ').slice(1)}</span></p>
                            <p><span class="label">Expected Delivery Date:</span> ${logbook.expectedDelivery.date || '-'}</p>
                            <p><span class="label">Expected Delivery Time:</span> ${logbook.expectedDelivery.time || '-'}</p>
                        </div>
                        <div class="section">
                            <p><span class="label">Delivery Address:</span></p>
                            <p>${logbook.deliveryAddress}</p>
                        </div>
                        ${logbook.notes ? `
                        <div class="section">
                            <p><span class="label">Notes:</span></p>
                            <p>${logbook.notes}</p>
                        </div>
                        ` : ''}
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }
            
            // Uncommitted requests functionality
            function refreshUncommittedList() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const uncommittedList = document.getElementById('uncommittedList');
                
                // Get draft cashbills
                const draftCashbills = cashbills.filter(cb => cb.status === 'draft');
                
                if (draftCashbills.length === 0) {
                    uncommittedList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h4>No Uncommitted Requests</h4>
                            <p>All cashbills have been committed</p>
                        </div>
                    `;
                    return;
                }
                
                uncommittedList.innerHTML = '';
                
                draftCashbills.forEach(cashbill => {
                    const itemsText = cashbill.items.map(item => 
                        `${item.name} (${item.quantity}x)`
                    ).join(', ');
                    
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card uncommitted-card mb-3';
                    cardElement.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${cashbill.id} - ${cashbill.customer.name}</span>
                            <span class="status-badge status-draft">Draft</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${cashbill.date}</p>
                                    <p><strong>Created by:</strong> ${cashbill.createdBy}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Amount:</strong> RM ${cashbill.totalAmount.toFixed(2)}</p>
                                    <p><strong>Items:</strong> ${itemsText}</p>
                                </div>
                            </div>
                            <div class="action-buttons mt-3">
                                <button class="btn btn-sm btn-primary view-uncommitted" data-id="${cashbill.id}">
                                    <i class="fas fa-eye me-1"></i> View
                                </button>
                                <button class="btn btn-sm btn-warning edit-uncommitted" data-id="${cashbill.id}">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-uncommitted" data-id="${cashbill.id}">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                                <button class="btn btn-sm btn-success approve-uncommitted" data-id="${cashbill.id}">
                                    <i class="fas fa-check me-1"></i> Approve
                                </button>
                                <button class="btn btn-sm btn-danger reject-uncommitted" data-id="${cashbill.id}">
                                    <i class="fas fa-times me-1"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                    
                    uncommittedList.appendChild(cardElement);
                });
                
                // Add event listeners to the buttons
                uncommittedList.addEventListener('click', function(e) {
                    const target = e.target;
                    const button = target.closest('button');
                    
                    if (!button) return;
                    
                    const cashbillId = button.getAttribute('data-id');
                    
                    if (button.classList.contains('view-uncommitted')) {
                        viewCashbillDetails(cashbillId);
                    } else if (button.classList.contains('edit-uncommitted')) {
                        editCashbill(cashbillId);
                    } else if (button.classList.contains('delete-uncommitted')) {
                        deleteCashbill(cashbillId);
                    } else if (button.classList.contains('approve-uncommitted')) {
                        approveCashbill(cashbillId);
                    } else if (button.classList.contains('reject-uncommitted')) {
                        rejectCashbill(cashbillId);
                    }
                });
            }
            
            // Approve all button
            document.getElementById('approveAllBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to approve all uncommitted requests?')) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    let approvedCount = 0;
                    
                    cashbills.forEach(cashbill => {
                        if (cashbill.status === 'draft') {
                            cashbill.status = 'committed';
                            cashbill.updatedAt = new Date().toISOString();
                            approvedCount++;
                        }
                    });
                    
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    // Log activity
                    logActivity('update', `Approved ${approvedCount} cashbills`);
                    
                    showToast(`Successfully approved ${approvedCount} cashbills!`, 'success');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            });
            
            // Reject all button
            document.getElementById('rejectAllBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reject all uncommitted requests?')) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    let rejectedCount = 0;
                    
                    cashbills = cashbills.filter(cashbill => {
                        if (cashbill.status === 'draft') {
                            rejectedCount++;
                            return false;
                        }
                        return true;
                    });
                    
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    // Log activity
                    logActivity('delete', `Rejected ${rejectedCount} cashbills`);
                    
                    showToast(`Successfully rejected ${rejectedCount} cashbills!`, 'warning');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            });
            
            // Approve cashbill function
            function approveCashbill(cashbillId) {
                if (confirm(`Are you sure you want to approve cashbill ${cashbillId}?`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    const cashbill = cashbills.find(cb => cb.id === cashbillId);
                    
                    if (cashbill) {
                        cashbill.status = 'committed';
                        cashbill.updatedAt = new Date().toISOString();
                        localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                        
                        // Log activity
                        logActivity('update', `Approved cashbill ${cashbillId}`);
                        
                        showToast(`Cashbill ${cashbillId} approved successfully!`, 'success');
                        
                        // Refresh data
                        loadDashboardData();
                        loadCashbillList();
                        refreshUncommittedList();
                        updateCounters();
                    }
                }
            }
            
            // Reject cashbill function
            function rejectCashbill(cashbillId) {
                if (confirm(`Are you sure you want to reject cashbill ${cashbillId}?`)) {
                    let cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                    cashbills = cashbills.filter(cb => cb.id !== cashbillId);
                    localStorage.setItem('pne_cashbills', JSON.stringify(cashbills));
                    
                    // Log activity
                    logActivity('delete', `Rejected cashbill ${cashbillId}`);
                    
                    showToast(`Cashbill ${cashbillId} rejected!`, 'warning');
                    
                    // Refresh data
                    loadDashboardData();
                    loadCashbillList();
                    refreshUncommittedList();
                    updateCounters();
                }
            }
            
            // Update counters function
            function updateCounters() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                
                document.getElementById('totalCashbills').textContent = cashbills.length;
                document.getElementById('completedCashbills').textContent = cashbills.filter(cb => cb.status === 'committed').length;
                document.getElementById('pendingCashbills').textContent = cashbills.filter(cb => cb.status === 'draft').length;
                
                const totalRevenue = cashbills
                    .filter(cb => cb.status === 'committed')
                    .reduce((sum, cb) => sum + cb.totalAmount, 0);
                document.getElementById('totalRevenue').textContent = `RM ${totalRevenue.toLocaleString()}`;
            }
            
            // Generate new cashbill ID
            function generateNewCashbillId() {
                const cashbills = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                const counter = cashbills.length + 1;
                document.getElementById('cashbillId').value = `#PA${String(counter).padStart(4, '0')}`;
            }
            
            // Generate new logbook ID
            function generateNewLogbookId() {
                const logbooks = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                const counter = logbooks.length + 1;
                document.getElementById('logbookId').value = `LOG-${String(counter).padStart(4, '0')}`;
            }
            
            // Generate report buttons
            document.querySelectorAll('.generate-report').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-type');
                    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                    document.getElementById('reportType').value = reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report';
                    reportModal.show();
                });
            });
            
            // Activity log functions
            function loadActivityLog() {
                const activities = JSON.parse(localStorage.getItem('pne_activity_log') || '[]');
                const activityTable = document.getElementById('activityTable');
                
                // Clear existing table
                if ($.fn.DataTable.isDataTable('#activityTable')) {
                    $('#activityTable').DataTable().destroy();
                }
                
                activityTable.innerHTML = '';
                
                if (activities.length === 0) {
                    activityTable.innerHTML = '<tr><td colspan="5" class="text-center">No activities found</td></tr>';
                    return;
                }
                
                // Sort by timestamp (newest first)
                const sortedActivities = [...activities]
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Populate user filter dropdown
                const userFilter = document.getElementById('filterUser');
                const users = [...new Set(sortedActivities.map(a => a.user))];
                
                userFilter.innerHTML = '<option value="">All Users</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilter.appendChild(option);
                });
                
                sortedActivities.forEach(activity => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(activity.timestamp).toLocaleString()}</td>
                        <td>${activity.user}</td>
                        <td><span class="badge bg-${getActionColor(activity.action)}">${activity.action}</span></td>
                        <td>${activity.details}</td>
                        <td>${activity.ip || '-'}</td>
                    `;
                    
                    activityTable.appendChild(row);
                });
                
                // Initialize DataTable
                setTimeout(() => {
                    $('#activityTable').DataTable({
                        responsive: true,
                        pageLength: 15,
                        order: [[0, 'desc']]
                    });
                }, 100);
                
                // Add filter functionality
                setupActivityFilters();
            }
            
            function getActionColor(action) {
                switch(action) {
                    case 'login': return 'success';
                    case 'logout': return 'secondary';
                    case 'create': return 'primary';
                    case 'update': return 'warning';
                    case 'delete': return 'danger';
                    case 'import': return 'info';
                    default: return 'secondary';
                }
            }
            
            function setupActivityFilters() {
                const searchInput = document.getElementById('searchActivity');
                const userFilter = document.getElementById('filterUser');
                const actionFilter = document.getElementById('filterAction');
                const clearBtn = document.getElementById('clearActivityFiltersBtn');
                
                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const userValue = userFilter.value;
                    const actionValue = actionFilter.value;
                    
                    const table = $('#activityTable').DataTable();
                    
                    // Search global filter
                    table.search(searchTerm).draw();
                    
                    // Custom filtering for user and action
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        const user = data[1]; // User column
                        const action = data[2]; // Action column
                        
                        // User filter
                        if (userValue && user !== userValue) {
                            return false;
                        }
                        
                        // Action filter
                        if (actionValue && !action.includes(actionValue)) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    table.draw();
                }
                
                searchInput.addEventListener('input', applyFilters);
                userFilter.addEventListener('change', applyFilters);
                actionFilter.addEventListener('change', applyFilters);
                
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    userFilter.value = '';
                    actionFilter.value = '';
                    
                    const table = $('#activityTable').DataTable();
                    table.search('').columns().search('').draw();
                });
            }
            
            function logActivity(action, details) {
                if (!currentUser) return;
                
                const activities = JSON.parse(localStorage.getItem('pne_activity_log') || '[]');
                
                const activity = {
                    timestamp: new Date().toISOString(),
                    user: currentUser.name,
                    action: action,
                    details: details,
                    ip: '192.168.1.1' // In a real app, this would be the actual IP
                };
                
                activities.push(activity);
                
                // Keep only the last 1000 activities
                if (activities.length > 1000) {
                    activities.splice(0, activities.length - 1000);
                }
                
                localStorage.setItem('pne_activity_log', JSON.stringify(activities));
                
                // Update notification count if this is a significant action
                if (['create', 'update', 'delete'].includes(action)) {
                    notificationCount++;
                    document.getElementById('notificationBadge').textContent = notificationCount;
                }
            }
            
            // Export data functions
            function exportAllData() {
                showLoading();
                
                setTimeout(() => {
                    const data = {
                        users: JSON.parse(localStorage.getItem('pne_users') || '[]'),
                        products: JSON.parse(localStorage.getItem('pne_products') || '[]'),
                        cashbills: JSON.parse(localStorage.getItem('pne_cashbills') || '[]'),
                        logbooks: JSON.parse(localStorage.getItem('pne_logbooks') || '[]'),
                        activity: JSON.parse(localStorage.getItem('pne_activity_log') || '[]'),
                        templates: JSON.parse(localStorage.getItem('pne_cashbill_templates') || '[]'),
                        exportDate: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `pne_portal_backup_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    hideLoading();
                    showToast('All data exported successfully!', 'success');
                }, 1000);
            }
            
            function exportData(type) {
                showLoading();
                
                setTimeout(() => {
                    let data, filename;
                    
                    switch(type) {
                        case 'cashbills':
                            data = JSON.parse(localStorage.getItem('pne_cashbills') || '[]');
                            filename = `cashbills_${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        case 'logbooks':
                            data = JSON.parse(localStorage.getItem('pne_logbooks') || '[]');
                            filename = `logbooks_${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        case 'activity':
                            data = JSON.parse(localStorage.getItem('pne_activity_log') || '[]');
                            filename = `activity_log_${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        default:
                            hideLoading();
                            showToast('Invalid export type', 'danger');
                            return;
                    }
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', filename);
                    linkElement.click();
                    
                    hideLoading();
                    showToast(`${type} exported successfully!`, 'success');
                }, 1000);
            }
            
            // Initialize data storage
            function initializeDataStorage() {
                // Check if users exist, if not create default users
                if (!localStorage.getItem('pne_users')) {
                    const defaultUsers = [
                        {
                            username: '0000',
                            password: 'Dd123',
                            name: 'Admin User',
                            email: 'admin@pneportal.com',
                            phone: '0123456789',
                            role: 'admin',
                            status: 'active',
                            lastLogin: null,
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            username: '0001',
                            password: '1234',
                            name: 'Crew One',
                            email: 'crew1@pneportal.com',
                            phone: '0123456788',
                            role: 'staff',
                            status: 'active',
                            lastLogin: null,
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('pne_users', JSON.stringify(defaultUsers));
                }
                
                // Check if products exist, if not create default products
                if (!localStorage.getItem('pne_products')) {
                    const defaultProducts = [
                        {
                            id: 'PROD-001',
                            name: 'Adult Jubah',
                            icon: '🕌',
                            category: 'jubah',
                            sku: 'SKU-0001',
                            regularPrice: 250,
                            memberPrice: 220,
                            unit: 'per set',
                            minOrder: 0,
                            stockQuantity: 50,
                            reorderLevel: 10,
                            description: 'High-quality adult jubah for special occasions',
                            features: ['Free: Cap included', 'Available in multiple sizes', 'Premium fabric'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-002',
                            name: 'Year 6 Jubah',
                            icon: '📘',
                            category: 'jubah',
                            sku: 'SKU-0002',
                            regularPrice: 170,
                            memberPrice: 150,
                            unit: 'per set',
                            minOrder: 10,
                            stockQuantity: 100,
                            reorderLevel: 20,
                            description: 'Comfortable jubah for Year 6 students',
                            features: ['Free: Cap included', 'School colors available', 'Durable material'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-003',
                            name: 'Kindergarten Jubah',
                            icon: '🧒',
                            category: 'jubah',
                            sku: 'SKU-0003',
                            regularPrice: 110,
                            memberPrice: 99,
                            unit: 'per set',
                            minOrder: 10,
                            stockQuantity: 150,
                            reorderLevel: 30,
                            description: 'Cute jubah for kindergarten children',
                            features: ['Free: Cap included', 'Child-friendly design', 'Easy to wear'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-004',
                            name: 'Plaque Arkalic',
                            icon: '🏷️',
                            category: 'accessories',
                            sku: 'SKU-0004',
                            regularPrice: 19.90,
                            memberPrice: 17.50,
                            unit: 'each',
                            minOrder: 0,
                            stockQuantity: 200,
                            reorderLevel: 50,
                            description: 'Customizable plaque for achievements',
                            features: ['Includes: Name printing', 'Size: 145mm x 100mm', 'High-quality finish'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-005',
                            name: 'Cute Medal',
                            icon: '🏅',
                            category: 'accessories',
                            sku: 'SKU-0005',
                            regularPrice: 12.90,
                            memberPrice: 10.90,
                            unit: 'each',
                            minOrder: 10,
                            stockQuantity: 300,
                            reorderLevel: 100,
                            description: 'Adorable medals for events',
                            features: ['Material: Arkalic', 'Custom design available', 'Ribbon included'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-006',
                            name: 'Cute Keychain',
                            icon: '🔑',
                            category: 'accessories',
                            sku: 'SKU-0006',
                            regularPrice: 5.90,
                            memberPrice: 3.90,
                            unit: 'each',
                            minOrder: 10,
                            stockQuantity: 500,
                            reorderLevel: 150,
                            description: 'Fun keychains for everyone',
                            features: ['Material: Arkalic (Sublimation)', 'Size: 9cm x 3cm', 'Waterproof'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-007',
                            name: 'Attendance Keychain',
                            icon: '🔑',
                            category: 'accessories',
                            sku: 'SKU-0007',
                            regularPrice: 4.90,
                            memberPrice: 3.50,
                            unit: 'each',
                            minOrder: 10,
                            stockQuantity: 400,
                            reorderLevel: 100,
                            description: 'Practical keychain for attendance tracking',
                            features: ['Material: Acrylic', 'Thickness: 2mm', 'Size: 4.4cm x 5.5cm'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-008',
                            name: 'Kindergarten T-Shirt',
                            icon: '👕',
                            category: 'uniforms',
                            sku: 'SKU-0008',
                            regularPrice: 29.90,
                            memberPrice: 25.00,
                            unit: 'per piece',
                            minOrder: 20,
                            stockQuantity: 200,
                            reorderLevel: 50,
                            description: 'Comfortable t-shirt for kindergarten',
                            features: ['Material: Microfiber', 'Free: School name & logo printing', 'Breathable fabric'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'PROD-009',
                            name: 'Kindergarten T-Shirt + Pants Set',
                            icon: '👕👖',
                            category: 'uniforms',
                            sku: 'SKU-0009',
                            regularPrice: 45.00,
                            memberPrice: 39.90,
                            unit: 'per set',
                            minOrder: 20,
                            stockQuantity: 150,
                            reorderLevel: 40,
                            description: 'Complete set for kindergarten students',
                            features: ['Material: Microfiber + Tracksuit', 'Matching set', 'Comfortable fit'],
                            createdBy: 'system',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('pne_products', JSON.stringify(defaultProducts));
                }
                
                // Initialize empty arrays for cashbills and logbooks if they don't exist
                if (!localStorage.getItem('pne_cashbills')) {
                    localStorage.setItem('pne_cashbills', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('pne_logbooks')) {
                    localStorage.setItem('pne_logbooks', JSON.stringify([]));
                }
                
                // Initialize activity log if it doesn't exist
                if (!localStorage.getItem('pne_activity_log')) {
                    localStorage.setItem('pne_activity_log', JSON.stringify([]));
                }
                
                // Initialize cashbill templates if they don't exist
                if (!localStorage.getItem('pne_cashbill_templates')) {
                    localStorage.setItem('pne_cashbill_templates', JSON.stringify([]));
                }
            }
            
            // Toast notification function
            function showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast, {
                    autohide: true,
                    delay: 3000
                });
                
                bsToast.show();
                
                // Remove toast element after it's hidden
                toast.addEventListener('hidden.bs.toast', function() {
                    toast.remove();
                });
            }
            
            // Loading spinner functions
            function showLoading() {
                loadingSpinner.style.display = 'flex';
            }
            
            function hideLoading() {
                loadingSpinner.style.display = 'none';
            }
            
            // Initialize the application
            loadProductsIntoSelect();
            loadProductsIntoEditSelect();
            
            // Add responsive handling
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
