<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNE Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* CSS remains the same - no changes needed here */
        :root {
            --primary-black: #121212;
            --secondary-black: #1e1e1e;
            --soft-black: #2d2d2d;
            --light-black: #3a3a3a;
            --primary-gray: #f8f9fa;
            --secondary-gray: #e9ecef;
            --soft-gray: #dee2e6;
            --accent-color: #4361ee;
            --accent-hover: #3a56d4;
            --success-color: #06ffa5;
            --warning-color: #ffbe0b;
            --danger-color: #ff006e;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background-color: var(--primary-gray);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1.6;
        }
        /* Login Screen Styles */
        .login-container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-heavy);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
        }
        .login-logo {
            margin-bottom: 24px;
        }
        .login-logo h1 {
            color: var(--primary-black);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .login-logo p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 24px;
        }
        .form-group {
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: var(--primary-gray);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .btn {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        .btn-secondary {
            background-color: var(--soft-black);
        }
        .btn-secondary:hover {
            background-color: var(--light-black);
        }
        .btn-success {
            background-color: var(--success-color);
            color: var(--primary-black);
        }
        .btn-success:hover {
            background-color: #00e691;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--primary-black);
        }
        .btn-warning:hover {
            background-color: #e6a800;
        }
        .btn-danger {
            background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #e6005f;
        }
        /* Portal Styles */
        .portal-container {
            width: 100%;
            max-width: 1000px;
            min-height: 100vh;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            display: none;
        }
        .portal-header {
            background-color: var(--primary-black);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .portal-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-details {
            text-align: right;
        }
        .user-name {
            font-weight: 600;
            font-size: 16px;
        }
        .user-role {
            font-size: 14px;
            opacity: 0.8;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
        }
        .portal-nav {
            display: flex;
            background-color: var(--secondary-black);
            color: white;
        }
        .nav-item {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
            position: relative;
            font-size: 14px;
        }
        .nav-item:last-child {
            border-right: none;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .nav-item.active {
            background-color: var(--accent-color);
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: white;
        }
        .nav-item i {
            display: block;
            font-size: 18px;
            margin-bottom: 4px;
        }
        .portal-content {
            padding: 24px;
            min-height: calc(100vh - 160px);
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-black);
        }
        /* Cashbill List Styles */
        .cashbill-list {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .cashbill-item {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        .cashbill-item:last-child {
            border-bottom: none;
        }
        .cashbill-item:hover {
            background-color: var(--primary-gray);
        }
        .cashbill-info {
            flex: 1;
        }
        .cashbill-id {
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-black);
            margin-bottom: 4px;
        }
        .cashbill-details {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .cashbill-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .cashbill-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 16px;
        }
        .status-committed {
            background-color: rgba(6, 255, 165, 0.1);
            color: var(--success-color);
        }
        .status-pending {
            background-color: rgba(255, 190, 11, 0.1);
            color: var(--warning-color);
        }
        .status-reversed {
            background-color: rgba(255, 0, 110, 0.1);
            color: var(--danger-color);
        }
        .status-amendment {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--accent-color);
        }
        .cashbill-actions {
            display: flex;
            gap: 8px;
        }
        .icon-btn {
            width: 36px;
            height: 36px;
            background-color: var(--primary-gray);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--light-black);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .icon-btn:hover {
            background-color: white;
            color: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        /* Form Styles */
        .cashbill-form {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .section-subtitle {
            font-size: 18px;
            color: var(--primary-black);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }
        /* Items Table Styles */
        .items-table-container {
            overflow-x: auto;
            margin-bottom: 16px;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        .items-table th {
            background-color: var(--secondary-black);
            color: white;
            padding: 14px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .items-table td {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
        }
        .items-table tr:last-child td {
            border-bottom: none;
        }
        .items-table tr:hover {
            background-color: var(--primary-gray);
        }
        .item-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .quantity-input, .tax-input {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            background-color: white;
        }
        .price-input {
            width: 110px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            background-color: white;
        }
        .action-btn {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover {
            background-color: rgba(255, 0, 110, 0.1);
        }
        .add-item-btn {
            margin-top: 12px;
        }
        /* Payment Section */
        .payment-types {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        .payment-type {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
        }
        .payment-type:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        .payment-type.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .payment-type i {
            font-size: 22px;
            margin-bottom: 6px;
        }
        .payment-type div {
            font-weight: 600;
            font-size: 14px;
        }
        /* Payment Processing */
        .payment-processing {
            background-color: var(--primary-gray);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            display: none;
        }
        .payment-processing.active {
            display: block;
        }
        .payment-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .payment-status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
        }
        .payment-status-text {
            flex: 1;
        }
        .payment-status-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .payment-status-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .payment-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-black);
            text-align: center;
            margin: 20px 0;
        }
        .payment-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        /* Summary Section */
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 18px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
            margin-top: 12px;
            color: var(--primary-black);
        }
        /* Crew Profile Styles */
        .crew-profile {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 600;
        }
        .profile-info h2 {
            font-size: 22px;
            margin-bottom: 4px;
            color: var(--primary-black);
        }
        .profile-info p {
            color: var(--text-secondary);
        }
        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value {
            padding: 10px 14px;
            background-color: var(--primary-gray);
            border-radius: 8px;
            font-weight: 500;
        }
        /* Courier Logbook Styles */
        .logbook-form {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .logbook-list {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .logbook-item {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .logbook-item:last-child {
            border-bottom: none;
        }
        .logbook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }
        .logbook-id {
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-black);
        }
        .logbook-date {
            color: var(--text-secondary);
            font-size: 14px;
        }
        .logbook-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 14px;
            margin-top: 14px;
        }
        .logbook-detail {
            display: flex;
            flex-direction: column;
        }
        .logbook-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .logbook-value {
            font-weight: 500;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-black);
        }
        .close-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .close-btn:hover {
            background-color: var(--primary-gray);
            color: var(--primary-black);
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
        }
        /* Cashbill Detail Styles */
        .cashbill-detail {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }
        .cashbill-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .cashbill-detail-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-black);
        }
        .cashbill-detail-status {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-section {
            margin-bottom: 24px;
        }
        .detail-section-title {
            font-size: 18px;
            color: var(--primary-black);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value {
            font-weight: 500;
            font-size: 15px;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .detail-table th {
            background-color: var(--secondary-black);
            color: white;
            padding: 14px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-table td {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
        }
        .detail-table tr:last-child td {
            border-bottom: none;
        }
        .detail-table tr:hover {
            background-color: var(--primary-gray);
        }
        .detail-summary {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .detail-summary-table {
            width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .detail-summary-table td {
            padding: 10px 14px;
        }
        .detail-summary-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        .detail-summary-table td:last-child {
            text-align: right;
            font-weight: 600;
        }
        .detail-summary-table tr.total td {
            font-weight: 700;
            font-size: 17px;
            border-top: 1px solid var(--border-color);
            padding-top: 14px;
            color: var(--primary-black);
        }
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 20px;
            background-color: var(--success-color);
            color: var(--primary-black);
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 3000;
            max-width: 320px;
            font-weight: 500;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background-color: var(--danger-color);
            color: white;
        }
        .notification.warning {
            background-color: var(--warning-color);
            color: var(--primary-black);
        }
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Admin Panel Styles */
        .admin-panel {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .admin-tools {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .admin-tool {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--primary-gray);
        }
        .admin-tool:hover {
            background-color: var(--secondary-gray);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        .admin-tool i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--accent-color);
        }
        .admin-tool div {
            font-weight: 600;
        }
        /* Untally Payment Form */
        .untally-form {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            display: none;
        }
        .untally-form.active {
            display: block;
        }
        /* Crew Management Modal */
        .crew-list {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-top: 20px;
        }
        .crew-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .crew-item:last-child {
            border-bottom: none;
        }
        .crew-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .crew-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
        }
        .crew-details h4 {
            font-size: 16px;
            margin-bottom: 2px;
        }
        .crew-details p {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .crew-actions {
            display: flex;
            gap: 8px;
        }
        /* System Settings */
        .settings-section {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .settings-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--primary-black);
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--soft-gray);
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-weight: 500;
        }
        .settings-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--soft-gray);
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        /* Responsive Styles */
        @media (max-width: 1024px) {
            .portal-content {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 14px;
            }
            
            .payment-types {
                flex-direction: column;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-summary {
                justify-content: flex-start;
            }
            
            .detail-summary-table {
                width: 100%;
            }
        }
        @media (max-width: 768px) {
            .login-card {
                padding: 28px 20px;
            }
            
            .portal-header {
                padding: 14px 20px;
            }
            
            .portal-title {
                font-size: 18px;
            }
            
            .nav-item {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .nav-item i {
                font-size: 16px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .cashbill-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
            }
            
            .cashbill-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">
                <h1><i class="fas fa-cash-register"></i> Portal PNE</h1>
                <p>Cashbill Management System</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="userId">User ID</label>
                    <input type="text" id="userId" placeholder="Enter your ID" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>
    <div class="portal-container" id="portalContainer">
        <div class="portal-header">
            <div class="portal-title">
                <i class="fas fa-cash-register"></i> Portal PNE
            </div>
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-role" id="userRole">Role</div>
                </div>
                <div class="user-avatar" id="userAvatar">U</div>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="portal-nav">
            <div class="nav-item active" data-section="cashbill">
                <i class="fas fa-file-invoice-dollar"></i> Cashbill
            </div>
            <div class="nav-item" data-section="crewProfile">
                <i class="fas fa-user-tie"></i> Crew Profile
            </div>
            <div class="nav-item" data-section="courierLogbook">
                <i class="fas fa-clipboard-list"></i> Courier Logbook
            </div>
            <div class="nav-item" data-section="adminPanel" id="adminPanelNav" style="display:none;">
                <i class="fas fa-tools"></i> Admin Panel
            </div>
        </div>
        
        <div class="portal-content">
            <!-- Cashbill Section -->
            <div class="content-section active" id="cashbillSection">
                <div class="section-header">
                    <h2 class="section-title">Cashbill Management</h2>
                    <button class="btn" id="newCashbillBtn">
                        <i class="fas fa-plus"></i> New Cashbill
                    </button>
                </div>
                
                <div class="cashbill-list" id="cashbillList">
                    <!-- Cashbill items will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Crew Profile Section -->
            <div class="content-section" id="crewProfileSection">
                <div class="section-header">
                    <h2 class="section-title">Crew Profile</h2>
                    <button class="btn" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
                
                <div class="crew-profile" id="crewProfile">
                    <!-- Crew profile will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Courier Logbook Section -->
            <div class="content-section" id="courierLogbookSection">
                <div class="section-header">
                    <h2 class="section-title">Courier Logbook</h2>
                    <button class="btn" id="newLogbookBtn">
                        <i class="fas fa-plus"></i> New Logbook Entry
                    </button>
                </div>
                
                <div class="logbook-list" id="logbookList">
                    <!-- Logbook entries will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Admin Panel Section -->
            <div class="content-section" id="adminPanelSection">
                <div class="section-header">
                    <h2 class="section-title">Admin Panel</h2>
                </div>
                
                <div class="admin-panel">
                    <h3 class="section-subtitle">
                        <i class="fas fa-tools"></i> Administrative Tools
                    </h3>
                    <div class="admin-tools">
                        <div class="admin-tool" id="untallyPaymentBtn">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>Untally Payment</div>
                        </div>
                        <div class="admin-tool" id="manageCrewBtn">
                            <i class="fas fa-users-cog"></i>
                            <div>Manage Crew</div>
                        </div>
                        <div class="admin-tool" id="systemSettingsBtn">
                            <i class="fas fa-cogs"></i>
                            <div>System Settings</div>
                        </div>
                        <div class="admin-tool" id="manageItemsBtn">
                            <i class="fas fa-boxes"></i>
                            <div>Manage Items</div>
                        </div>
                    </div>
                </div>
                
                <div class="untally-form" id="untallyForm">
                    <h3 class="section-subtitle">
                        <i class="fas fa-money-bill-wave"></i> Untally Payment Adjustment
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="untallyCashbillId">Cashbill ID</label>
                            <input type="text" id="untallyCashbillId" placeholder="Enter cashbill ID">
                        </div>
                        <div class="form-group">
                            <label for="untallyAmount">Adjustment Amount (MYR)</label>
                            <input type="number" id="untallyAmount" placeholder="Enter amount" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="untallyReason">Reason for Adjustment</label>
                        <textarea id="untallyReason" rows="3" placeholder="Explain the reason for this adjustment"></textarea>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-secondary" id="cancelUntallyBtn">Cancel</button>
                        <button class="btn btn-warning" id="processUntallyBtn">Process Adjustment</button>
                    </div>
                </div>
                
                <div id="crewManagementForm" style="display: none;">
                    <div class="admin-panel">
                        <h3 class="section-subtitle">
                            <i class="fas fa-users-cog"></i> Crew Management
                        </h3>
                        <button class="btn" id="addCrewBtn" style="margin-bottom: 16px;">
                            <i class="fas fa-plus"></i> Add New Crew
                        </button>
                        
                        <div class="crew-list" id="crewList">
                            <!-- Crew list will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div id="systemSettingsForm" style="display: none;">
                    <div class="admin-panel">
                        <h3 class="section-subtitle">
                            <i class="fas fa-cogs"></i> System Settings
                        </h3>
                        
                        <div class="settings-section">
                            <h3>General Settings</h3>
                            <div class="settings-item">
                                <div class="settings-label">Auto-save drafts</div>
                                <div class="settings-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoSaveDrafts" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="settings-item">
                                <div class="settings-label">Email notifications</div>
                                <div class="settings-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifications">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="settings-item">
                                <div class="settings-label">Require payment processing</div>
                                <div class="settings-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="requirePayment" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h3>Promo Codes</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newPromoCode">New Promo Code</label>
                                    <input type="text" id="newPromoCode" placeholder="Enter code">
                                </div>
                                <div class="form-group">
                                    <label for="newPromoDiscount">Discount (%)</label>
                                    <input type="number" id="newPromoDiscount" placeholder="Enter discount" min="1" max="100">
                                </div>
                            </div>
                            <button class="btn" id="addPromoBtn">Add Promo Code</button>
                            
                            <div class="crew-list" style="margin-top: 16px;">
                                <div class="crew-item">
                                    <div class="crew-info">
                                        <div>
                                            <h4>SAVE10</h4>
                                            <p>10% discount</p>
                                        </div>
                                    </div>
                                    <div class="crew-actions">
                                        <button class="icon-btn" title="Remove">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="crew-item">
                                    <div class="crew-info">
                                        <div>
                                            <h4>WELCOME</h4>
                                            <p>15% discount</p>
                                        </div>
                                    </div>
                                    <div class="crew-actions">
                                        <button class="icon-btn" title="Remove">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="crew-item">
                                    <div class="crew-info">
                                        <div>
                                            <h4>STUDENT</h4>
                                            <p>20% discount</p>
                                        </div>
                                    </div>
                                    <div class="crew-actions">
                                        <button class="icon-btn" title="Remove">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="itemsManagementForm" style="display: none;">
                    <div class="admin-panel">
                        <h3 class="section-subtitle">
                            <i class="fas fa-boxes"></i> Item Management
                        </h3>
                        <button class="btn" id="addItemBtn" style="margin-bottom: 16px;">
                            <i class="fas fa-plus"></i> Add New Item
                        </button>
                        
                        <div class="crew-list" id="itemsList">
                            <!-- Items list will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Cashbill Modal -->
    <div class="modal" id="newCashbillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Cashbill</h3>
                <button class="close-btn" id="closeCashbillModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cashbillForm">
                    <!-- Customer Information Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-user"></i> Customer Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerFirstName">First Name</label>
                                <input type="text" id="customerFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerLastName">Last Name</label>
                                <input type="text" id="customerLastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerPhone">Phone Number</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="customerEmail">Email</label>
                                <input type="email" id="customerEmail" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <textarea id="customerAddress" rows="2" placeholder="Enter customer address"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-box"></i> Items
                        </h3>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>SNO</th>
                                        <th>Qty</th>
                                        <th>Desc / Serial No / IMEI</th>
                                        <th>Tax %</th>
                                        <th>Unit Price (MYR)</th>
                                        <th>Total Excl Tax (MYR)</th>
                                        <th>Total Tax (MYR)</th>
                                        <th>Adj Total (MYR)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <!-- Remarks Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-comment-alt"></i> Remarks
                        </h3>
                        <div class="form-group">
                            <label for="cashbillRemarks">Additional Notes</label>
                            <textarea id="cashbillRemarks" rows="3" placeholder="Enter any additional remarks or notes"></textarea>
                        </div>
                    </div>
                    
                    <!-- Payment Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-credit-card"></i> Payment Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Type</label>
                                <div class="payment-types">
                                    <div class="payment-type" data-payment="cash">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>Cash</div>
                                    </div>
                                    <div class="payment-type" data-payment="card">
                                        <i class="fas fa-credit-card"></i>
                                        <div>Card</div>
                                    </div>
                                    <div class="payment-type" data-payment="ewallet">
                                        <i class="fas fa-mobile-alt"></i>
                                        <div>E-Wallet</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="promoCode">Promo Code (Optional)</label>
                                <input type="text" id="promoCode" placeholder="Enter promo code" onchange="applyPromoCode()">
                            </div>
                        </div>
                        
                        <div class="payment-processing" id="paymentProcessing">
                            <div class="payment-status">
                                <div class="payment-status-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="payment-status-text">
                                    <div class="payment-status-title">Payment Method Selected</div>
                                    <div class="payment-status-desc" id="paymentMethodDesc">Please select a payment method</div>
                                </div>
                            </div>
                            
                            <div class="payment-amount" id="paymentAmount">MYR 0.00</div>
                            
                            <div class="payment-actions">
                                <button type="button" class="btn btn-secondary" id="changePaymentBtn">Change Payment</button>
                                <button type="button" class="btn btn-success" id="processPaymentBtn">Process Payment</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-calculator"></i> Summary
                        </h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span id="tax">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span id="discount">MYR 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="total">MYR 0.00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCashbillBtn">Cancel</button>
                <button class="btn" id="saveCashbillBtn">Save Draft</button>
                <button class="btn btn-success" id="commitCashbillBtn">Commit</button>
            </div>
        </div>
    </div>
    
    <!-- Cashbill Detail Modal -->
    <div class="modal" id="cashbillDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cashbill Details</h3>
                <button class="close-btn" id="closeCashbillDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cashbill-detail" id="cashbillDetail">
                    <!-- Cashbill details will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="action-buttons" id="cashbillActionButtons">
                    <!-- Action buttons will be populated by JavaScript -->
                </div>
                <button class="btn btn-secondary" id="closeDetailBtn">Close</button>
                <button class="btn" id="printDetailBtn">
                    <i class="fas fa-print"></i> Print Invoice
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Cashbill Modal -->
    <div class="modal" id="editCashbillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Cashbill</h3>
                <button class="close-btn" id="closeEditCashbillModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCashbillForm">
                    <!-- Customer Information Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-user"></i> Customer Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCustomerFirstName">First Name</label>
                                <input type="text" id="editCustomerFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomerLastName">Last Name</label>
                                <input type="text" id="editCustomerLastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCustomerPhone">Phone Number</label>
                                <input type="tel" id="editCustomerPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomerEmail">Email</label>
                                <input type="email" id="editCustomerEmail" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editCustomerAddress">Address</label>
                            <textarea id="editCustomerAddress" rows="2" placeholder="Enter customer address"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-box"></i> Items
                        </h3>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>SNO</th>
                                        <th>Qty</th>
                                        <th>Desc / Serial No / IMEI</th>
                                        <th>Tax %</th>
                                        <th>Unit Price (MYR)</th>
                                        <th>Total Excl Tax (MYR)</th>
                                        <th>Total Tax (MYR)</th>
                                        <th>Adj Total (MYR)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="editItemsTableBody">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="editAddItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <!-- Remarks Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-comment-alt"></i> Remarks
                        </h3>
                        <div class="form-group">
                            <label for="editCashbillRemarks">Additional Notes</label>
                            <textarea id="editCashbillRemarks" rows="3" placeholder="Enter any additional remarks or notes"></textarea>
                        </div>
                    </div>
                    
                    <!-- Payment Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-credit-card"></i> Payment Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Type</label>
                                <div class="payment-types" id="editPaymentTypes">
                                    <div class="payment-type" data-payment="cash">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <div>Cash</div>
                                    </div>
                                    <div class="payment-type" data-payment="card">
                                        <i class="fas fa-credit-card"></i>
                                        <div>Card</div>
                                    </div>
                                    <div class="payment-type" data-payment="ewallet">
                                        <i class="fas fa-mobile-alt"></i>
                                        <div>E-Wallet</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editPromoCode">Promo Code (Optional)</label>
                                <input type="text" id="editPromoCode" placeholder="Enter promo code" onchange="applyEditPromoCode()">
                            </div>
                        </div>
                        
                        <div class="payment-processing" id="editPaymentProcessing">
                            <div class="payment-status">
                                <div class="payment-status-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="payment-status-text">
                                    <div class="payment-status-title">Payment Method Selected</div>
                                    <div class="payment-status-desc" id="editPaymentMethodDesc">Please select a payment method</div>
                                </div>
                            </div>
                            
                            <div class="payment-amount" id="editPaymentAmount">MYR 0.00</div>
                            
                            <div class="payment-actions">
                                <button type="button" class="btn btn-secondary" id="editChangePaymentBtn">Change Payment</button>
                                <button type="button" class="btn btn-success" id="editProcessPaymentBtn">Process Payment</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="form-section">
                        <h3 class="section-subtitle">
                            <i class="fas fa-calculator"></i> Summary
                        </h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="editSubtotal">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span id="editTax">MYR 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span id="editDiscount">MYR 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="editTotal">MYR 0.00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCashbillBtn">Cancel</button>
                <button class="btn btn-success" id="saveEditCashbillBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="close-btn" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileFirstName">First Name</label>
                            <input type="text" id="profileFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="profileLastName">Last Name</label>
                            <input type="text" id="profileLastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileEmail">Email</label>
                            <input type="email" id="profileEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Phone</label>
                            <input type="tel" id="profilePhone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profileOutlet">Outlet Location</label>
                        <input type="text" id="profileOutlet" required>
                    </div>
                    <div class="form-group">
                        <label for="profilePassword">New Password (leave blank to keep current)</label>
                        <input type="password" id="profilePassword">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                <button class="btn" id="saveProfileBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- New Logbook Modal -->
    <div class="modal" id="newLogbookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Courier Logbook Entry</h3>
                <button class="close-btn" id="closeLogbookModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="logbookForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookFirstName">First Name</label>
                            <input type="text" id="logbookFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookLastName">Last Name</label>
                            <input type="text" id="logbookLastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookPhone">Phone Number</label>
                            <input type="tel" id="logbookPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookEmail">Email</label>
                            <input type="email" id="logbookEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logbookAddress">Address</label>
                            <input type="text" id="logbookAddress" required>
                        </div>
                        <div class="form-group">
                            <label for="logbookCity">City</label>
                            <input type="text" id="logbookCity" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="logbookNotes">Notes</label>
                        <textarea id="logbookNotes" rows="3" placeholder="Enter additional notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLogbookBtn">Cancel</button>
                <button class="btn" id="saveLogbookBtn">Save Entry</button>
            </div>
        </div>
    </div>
    
    <!-- Add Crew Modal -->
    <div class="modal" id="addCrewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Crew Member</h3>
                <button class="close-btn" id="closeAddCrewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCrewForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newCrewId">Crew ID</label>
                            <input type="text" id="newCrewId" placeholder="Enter crew ID" required>
                        </div>
                        <div class="form-group">
                            <label for="newCrewPassword">Password</label>
                            <input type="password" id="newCrewPassword" placeholder="Enter password" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newCrewFirstName">First Name</label>
                            <input type="text" id="newCrewFirstName" placeholder="Enter first name" required>
                        </div>
                        <div class="form-group">
                            <label for="newCrewLastName">Last Name</label>
                            <input type="text" id="newCrewLastName" placeholder="Enter last name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newCrewEmail">Email</label>
                            <input type="email" id="newCrewEmail" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="newCrewPhone">Phone</label>
                            <input type="tel" id="newCrewPhone" placeholder="Enter phone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newCrewOutlet">Outlet Location</label>
                        <input type="text" id="newCrewOutlet" placeholder="Enter outlet location" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddCrewBtn">Cancel</button>
                <button class="btn btn-success" id="saveAddCrewBtn">Add Crew Member</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Crew Modal -->
    <div class="modal" id="editCrewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Crew Member</h3>
                <button class="close-btn" id="closeEditCrewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCrewForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCrewId">Crew ID</label>
                            <input type="text" id="editCrewId" placeholder="Enter crew ID" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="editCrewPassword">New Password (leave blank to keep current)</label>
                            <input type="password" id="editCrewPassword" placeholder="Enter new password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCrewFirstName">First Name</label>
                            <input type="text" id="editCrewFirstName" placeholder="Enter first name" required>
                        </div>
                        <div class="form-group">
                            <label for="editCrewLastName">Last Name</label>
                            <input type="text" id="editCrewLastName" placeholder="Enter last name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCrewEmail">Email</label>
                            <input type="email" id="editCrewEmail" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="editCrewPhone">Phone</label>
                            <input type="tel" id="editCrewPhone" placeholder="Enter phone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editCrewOutlet">Outlet Location</label>
                        <input type="text" id="editCrewOutlet" placeholder="Enter outlet location" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCrewBtn">Cancel</button>
                <button class="btn btn-success" id="saveEditCrewBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Add Item Modal -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Item</h3>
                <button class="close-btn" id="closeAddItemModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newItemId">Item ID</label>
                            <input type="text" id="newItemId" placeholder="Enter item ID" required>
                        </div>
                        <div class="form-group">
                            <label for="newItemName">Item Name</label>
                            <input type="text" id="newItemName" placeholder="Enter item name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newItemRegularPrice">Regular Price (MYR)</label>
                            <input type="number" id="newItemRegularPrice" placeholder="Enter regular price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="newItemMemberPrice">Member Price (MYR)</label>
                            <input type="number" id="newItemMemberPrice" placeholder="Enter member price" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newItemTaxRate">Tax Rate (%)</label>
                            <input type="number" id="newItemTaxRate" placeholder="Enter tax rate" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="newItemMinOrder">Minimum Order (optional)</label>
                            <input type="number" id="newItemMinOrder" placeholder="Enter minimum order quantity" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newItemDescription">Description</label>
                        <textarea id="newItemDescription" rows="3" placeholder="Enter item description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddItemBtn">Cancel</button>
                <button class="btn btn-success" id="saveAddItemBtn">Add Item</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Item Modal -->
    <div class="modal" id="editItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Item</h3>
                <button class="close-btn" id="closeEditItemModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemId">Item ID</label>
                            <input type="text" id="editItemId" placeholder="Enter item ID" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="editItemName">Item Name</label>
                            <input type="text" id="editItemName" placeholder="Enter item name" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemRegularPrice">Regular Price (MYR)</label>
                            <input type="number" id="editItemRegularPrice" placeholder="Enter regular price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemMemberPrice">Member Price (MYR)</label>
                            <input type="number" id="editItemMemberPrice" placeholder="Enter member price" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemTaxRate">Tax Rate (%)</label>
                            <input type="number" id="editItemTaxRate" placeholder="Enter tax rate" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemMinOrder">Minimum Order (optional)</label>
                            <input type="number" id="editItemMinOrder" placeholder="Enter minimum order quantity" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editItemDescription">Description</label>
                        <textarea id="editItemDescription" rows="3" placeholder="Enter item description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditItemBtn">Cancel</button>
                <button class="btn btn-success" id="saveEditItemBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Approval Modal -->
    <div class="modal" id="approvalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approval Required</h3>
                <button class="close-btn" id="closeApprovalModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="approvalMessage" style="margin-bottom: 24px; font-size: 16px;">Action requires admin approval.</p>
                <div class="form-group">
                    <label for="crewId">Crew ID</label>
                    <input type="text" id="crewId" placeholder="Enter your crew ID">
                </div>
                <div class="form-group">
                    <label for="crewPassword">Crew Password</label>
                    <input type="password" id="crewPassword" placeholder="Enter your password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelApprovalBtn">Cancel</button>
                <button class="btn btn-warning" id="requestApprovalBtn">Request Approval</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Data
        let users = [
            { id: '0000', password: 'Dd123', firstName: 'Danial', lastName: 'Danish', role: 'admin', email: 'danial@example.com', phone: '0123456789', outlet: 'Head Office' },
            { id: '1001', password: '0000', firstName: 'John', lastName: 'Doe', role: 'crew', email: 'john@example.com', phone: '0123456788', outlet: 'Outlet A' },
            { id: '1002', password: '0000', firstName: 'Jane', lastName: 'Smith', role: 'crew', email: 'jane@example.com', phone: '0123456787', outlet: 'Outlet B' }
        ];
        
        let itemTypes = [
            {
                id: 'adult-robes',
                name: 'Adult Robes',
                regularPrice: 250,
                memberPrice: 220,
                description: 'Free cap included',
                taxRate: 10
            },
            {
                id: 'year6-robes',
                name: 'Year 6 Robes',
                regularPrice: 170,
                memberPrice: 150,
                description: 'Minimum order: 10 sets, Free cap included',
                taxRate: 10,
                minOrder: 10
            },
            {
                id: 'kindergarten-robes',
                name: 'Kindergarten Robes',
                regularPrice: 110,
                memberPrice: 99,
                description: 'Minimum order: 10 sets, Free cap included',
                taxRate: 10,
                minOrder: 10
            }
        ];
        
        let promoCodes = {
            "SAVE10": 0.1,
            "WELCOME": 0.15,
            "STUDENT": 0.2
        };
        
        // System settings
        let systemSettings = {
            autoSaveDrafts: true,
            emailNotifications: false,
            requirePayment: true
        };
        
        // State
        let currentUser = null;
        let cashbills = [];
        let logbookEntries = [];
        let selectedItems = [];
        let selectedPayment = null;
        let appliedPromo = null;
        let discount = 0;
        let pendingAction = null;
        let itemCounter = 1;
        let currentEditingCashbill = null;
        let activeSection = 'cashbill';
        let paymentProcessed = false;
        let editPaymentProcessed = false;
        let currentEditingCrew = null;
        let currentEditingItem = null;
        
        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const portalContainer = document.getElementById('portalContainer');
        const loginForm = document.getElementById('loginForm');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');
        const cashbillList = document.getElementById('cashbillList');
        const crewProfile = document.getElementById('crewProfile');
        const logbookList = document.getElementById('logbookList');
        const notification = document.getElementById('notification');
        const adminPanelNav = document.getElementById('adminPanelNav');
        
        // Modals
        const newCashbillModal = document.getElementById('newCashbillModal');
        const cashbillDetailModal = document.getElementById('cashbillDetailModal');
        const editCashbillModal = document.getElementById('editCashbillModal');
        const editProfileModal = document.getElementById('editProfileModal');
        const newLogbookModal = document.getElementById('newLogbookModal');
        const addCrewModal = document.getElementById('addCrewModal');
        const editCrewModal = document.getElementById('editCrewModal');
        const addItemModal = document.getElementById('addItemModal');
        const editItemModal = document.getElementById('editItemModal');
        const approvalModal = document.getElementById('approvalModal');
        
        // Buttons
        const newCashbillBtn = document.getElementById('newCashbillBtn');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const newLogbookBtn = document.getElementById('newLogbookBtn');
        const addItemBtn = document.getElementById('addItemBtn');
        const editAddItemBtn = document.getElementById('editAddItemBtn');
        const addCrewBtn = document.getElementById('addCrewBtn');
        const saveAddCrewBtn = document.getElementById('saveAddCrewBtn');
        const saveEditCrewBtn = document.getElementById('saveEditCrewBtn');
        const addNewItemBtn = document.getElementById('addNewItemBtn');
        const saveAddItemBtn = document.getElementById('saveAddItemBtn');
        const saveEditItemBtn = document.getElementById('saveEditItemBtn');
        
        // Payment elements
        const paymentProcessing = document.getElementById('paymentProcessing');
        const paymentMethodDesc = document.getElementById('paymentMethodDesc');
        const paymentAmount = document.getElementById('paymentAmount');
        const changePaymentBtn = document.getElementById('changePaymentBtn');
        const processPaymentBtn = document.getElementById('processPaymentBtn');
        const promoCodeInput = document.getElementById('promoCode');
        
        // Edit payment elements
        const editPaymentProcessing = document.getElementById('editPaymentProcessing');
        const editPaymentMethodDesc = document.getElementById('editPaymentMethodDesc');
        const editPaymentAmount = document.getElementById('editPaymentAmount');
        const editChangePaymentBtn = document.getElementById('editChangePaymentBtn');
        const editProcessPaymentBtn = document.getElementById('editProcessPaymentBtn');
        const editPromoCodeInput = document.getElementById('editPromoCode');
        
        // Admin Panel
        const untallyPaymentBtn = document.getElementById('untallyPaymentBtn');
        const manageCrewBtn = document.getElementById('manageCrewBtn');
        const systemSettingsBtn = document.getElementById('systemSettingsBtn');
        const manageItemsBtn = document.getElementById('manageItemsBtn');
        const untallyForm = document.getElementById('untallyForm');
        const cancelUntallyBtn = document.getElementById('cancelUntallyBtn');
        const processUntallyBtn = document.getElementById('processUntallyBtn');
        const crewManagementForm = document.getElementById('crewManagementForm');
        const systemSettingsForm = document.getElementById('systemSettingsForm');
        const itemsManagementForm = document.getElementById('itemsManagementForm');
        const crewList = document.getElementById('crewList');
        const itemsList = document.getElementById('itemsList');
        
        // Initialize
        function init() {
            try {
                // Load data from localStorage
                loadAllData();
                
                // Check for saved session
                const savedUser = localStorage.getItem('currentUser');
                const savedSection = localStorage.getItem('activeSection');
                
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    loginContainer.style.display = 'none';
                    portalContainer.style.display = 'block';
                    userName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    userRole.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Crew Member';
                    userAvatar.textContent = `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;
                    
                    if (currentUser.role === 'admin') {
                        adminPanelNav.style.display = 'block';
                    }
                    
                    if (savedSection) {
                        activeSection = savedSection;
                    }
                    
                    renderPortal();
                    switchSection(activeSection);
                }
                
                // Load cashbills if not exists
                if (cashbills.length === 0) {
                    cashbills = [
                        {
                            id: '#PNE0001',
                            customer: { 
                                firstName: 'John', 
                                lastName: 'Doe', 
                                phone: '0123456789', 
                                email: 'john@example.com',
                                address: '123 Main Street, Kuala Lumpur, 50000'
                            },
                            paymentType: 'cash',
                            items: [
                                { 
                                    sno: 1, 
                                    qty: 2, 
                                    description: 'Adult Robes', 
                                    taxRate: 10, 
                                    unitPrice: 250, 
                                    totalExclTax: 500, 
                                    totalTax: 50, 
                                    adjTotal: 550 
                                }
                            ],
                            subtotal: 500,
                            tax: 50,
                            discount: 0,
                            total: 550,
                            promoCode: null,
                            remarks: 'Customer requested urgent delivery',
                            status: 'committed',
                            createdBy: '1001',
                            createdAt: new Date('2023-05-15').toISOString()
                        },
                        {
                            id: '#PNE0002',
                            customer: { 
                                firstName: 'Jane', 
                                lastName: 'Smith', 
                                phone: '0123456788', 
                                email: 'jane@example.com',
                                address: '456 Jalan Sultan, Petaling Jaya, 46000'
                            },
                            paymentType: 'card',
                            items: [
                                { 
                                    sno: 1, 
                                    qty: 10, 
                                    description: 'Year 6 Robes', 
                                    taxRate: 10, 
                                    unitPrice: 170, 
                                    totalExclTax: 1700, 
                                    totalTax: 170, 
                                    adjTotal: 1870 
                                }
                            ],
                            subtotal: 1700,
                            tax: 170,
                            discount: 0,
                            total: 1870,
                            promoCode: null,
                            remarks: 'School bulk order',
                            status: 'committed',
                            createdBy: '1002',
                            createdAt: new Date('2023-05-16').toISOString()
                        }
                    ];
                    saveCashbills();
                }
                
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Failed to initialize the application. Please refresh the page.', true);
            }
        }
        
        // Load all data from localStorage
        function loadAllData() {
            try {
                // Load users
                const savedUsers = localStorage.getItem('users');
                if (savedUsers) {
                    users = JSON.parse(savedUsers);
                }
                
                // Load cashbills
                const savedCashbills = localStorage.getItem('cashbills');
                if (savedCashbills) {
                    cashbills = JSON.parse(savedCashbills);
                }
                
                // Load logbook entries
                const savedLogbook = localStorage.getItem('logbookEntries');
                if (savedLogbook) {
                    logbookEntries = JSON.parse(savedLogbook);
                }
                
                // Load item types
                const savedItemTypes = localStorage.getItem('itemTypes');
                if (savedItemTypes) {
                    itemTypes = JSON.parse(savedItemTypes);
                }
                
                // Load promo codes
                const savedPromoCodes = localStorage.getItem('promoCodes');
                if (savedPromoCodes) {
                    promoCodes = JSON.parse(savedPromoCodes);
                }
                
                // Load system settings
                const savedSystemSettings = localStorage.getItem('systemSettings');
                if (savedSystemSettings) {
                    systemSettings = JSON.parse(savedSystemSettings);
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
            }
        }
        
        // Save all data to localStorage
        function saveAllData() {
            try {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('cashbills', JSON.stringify(cashbills));
                localStorage.setItem('logbookEntries', JSON.stringify(logbookEntries));
                localStorage.setItem('itemTypes', JSON.stringify(itemTypes));
                localStorage.setItem('promoCodes', JSON.stringify(promoCodes));
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
                showNotification('Failed to save data. Please try again.', true);
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            try {
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);
                
                navItems.forEach(item => {
                    item.addEventListener('click', () => switchSection(item.dataset.section));
                });
                
                newCashbillBtn.addEventListener('click', openNewCashbillModal);
                editProfileBtn.addEventListener('click', openEditProfileModal);
                newLogbookBtn.addEventListener('click', openNewLogbookModal);
                addItemBtn.addEventListener('click', addNewItem);
                editAddItemBtn.addEventListener('click', addEditItem);
                
                // Admin panel buttons
                untallyPaymentBtn.addEventListener('click', () => {
                    untallyForm.classList.toggle('active');
                    crewManagementForm.style.display = 'none';
                    systemSettingsForm.style.display = 'none';
                    itemsManagementForm.style.display = 'none';
                });
                
                manageCrewBtn.addEventListener('click', () => {
                    crewManagementForm.style.display = 'block';
                    untallyForm.classList.remove('active');
                    systemSettingsForm.style.display = 'none';
                    itemsManagementForm.style.display = 'none';
                    renderCrewList();
                });
                
                systemSettingsBtn.addEventListener('click', () => {
                    systemSettingsForm.style.display = 'block';
                    untallyForm.classList.remove('active');
                    crewManagementForm.style.display = 'none';
                    itemsManagementForm.style.display = 'none';
                    renderSystemSettings();
                });
                
                manageItemsBtn.addEventListener('click', () => {
                    itemsManagementForm.style.display = 'block';
                    untallyForm.classList.remove('active');
                    crewManagementForm.style.display = 'none';
                    systemSettingsForm.style.display = 'none';
                    renderItemsList();
                });
                
                addCrewBtn.addEventListener('click', openAddCrewModal);
                addNewItemBtn.addEventListener('click', openAddItemModal);
                
                cancelUntallyBtn.addEventListener('click', () => {
                    untallyForm.classList.remove('active');
                });
                
                processUntallyBtn.addEventListener('click', processUntallyPayment);
                
                // Payment processing buttons
                changePaymentBtn.addEventListener('click', () => {
                    paymentProcessing.classList.remove('active');
                    selectedPayment = null;
                    paymentProcessed = false;
                    updatePaymentDisplay();
                });
                
                processPaymentBtn.addEventListener('click', () => {
                    if (selectedPayment) {
                        paymentProcessed = true;
                        showNotification(`Payment processed successfully via ${selectedPayment}!`);
                        processPaymentBtn.disabled = true;
                        processPaymentBtn.innerHTML = '<i class="fas fa-check"></i> Payment Processed';
                    }
                });
                
                // Edit payment processing buttons
                editChangePaymentBtn.addEventListener('click', () => {
                    editPaymentProcessing.classList.remove('active');
                    selectedPayment = null;
                    editPaymentProcessed = false;
                    updateEditPaymentDisplay();
                });
                
                editProcessPaymentBtn.addEventListener('click', () => {
                    if (selectedPayment) {
                        editPaymentProcessed = true;
                        showNotification(`Payment processed successfully via ${selectedPayment}!`);
                        editProcessPaymentBtn.disabled = true;
                        editProcessPaymentBtn.innerHTML = '<i class="fas fa-check"></i> Payment Processed';
                    }
                });
                
                // Modal close buttons
                document.getElementById('closeCashbillModal').addEventListener('click', closeNewCashbillModal);
                document.getElementById('closeCashbillDetailModal').addEventListener('click', closeCashbillDetailModal);
                document.getElementById('closeEditCashbillModal').addEventListener('click', closeEditCashbillModal);
                document.getElementById('closeProfileModal').addEventListener('click', closeEditProfileModal);
                document.getElementById('closeLogbookModal').addEventListener('click', closeNewLogbookModal);
                document.getElementById('closeAddCrewModal').addEventListener('click', closeAddCrewModal);
                document.getElementById('closeEditCrewModal').addEventListener('click', closeEditCrewModal);
                document.getElementById('closeAddItemModal').addEventListener('click', closeAddItemModal);
                document.getElementById('closeEditItemModal').addEventListener('click', closeEditItemModal);
                document.getElementById('closeApprovalModal').addEventListener('click', closeApprovalModal);
                
                // Modal cancel buttons
                document.getElementById('cancelCashbillBtn').addEventListener('click', closeNewCashbillModal);
                document.getElementById('closeDetailBtn').addEventListener('click', closeCashbillDetailModal);
                document.getElementById('cancelEditCashbillBtn').addEventListener('click', closeEditCashbillModal);
                document.getElementById('cancelProfileBtn').addEventListener('click', closeEditProfileModal);
                document.getElementById('cancelLogbookBtn').addEventListener('click', closeNewLogbookModal);
                document.getElementById('cancelAddCrewBtn').addEventListener('click', closeAddCrewModal);
                document.getElementById('cancelEditCrewBtn').addEventListener('click', closeEditCrewModal);
                document.getElementById('cancelAddItemBtn').addEventListener('click', closeAddItemModal);
                document.getElementById('cancelEditItemBtn').addEventListener('click', closeEditItemModal);
                document.getElementById('cancelApprovalBtn').addEventListener('click', closeApprovalModal);
                
                // Modal action buttons
                document.getElementById('saveCashbillBtn').addEventListener('click', saveCashbill);
                document.getElementById('commitCashbillBtn').addEventListener('click', commitCashbill);
                document.getElementById('saveEditCashbillBtn').addEventListener('click', saveEditCashbill);
                document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
                document.getElementById('saveLogbookBtn').addEventListener('click', saveLogbook);
                document.getElementById('saveAddCrewBtn').addEventListener('click', saveAddCrew);
                document.getElementById('saveEditCrewBtn').addEventListener('click', saveEditCrew);
                document.getElementById('saveAddItemBtn').addEventListener('click', saveAddItem);
                document.getElementById('saveEditItemBtn').addEventListener('click', saveEditItem);
                document.getElementById('requestApprovalBtn').addEventListener('click', requestApproval);
                document.getElementById('printDetailBtn').addEventListener('click', printCashbillDetail);
                
                // System settings
                document.getElementById('autoSaveDrafts').addEventListener('change', (e) => {
                    systemSettings.autoSaveDrafts = e.target.checked;
                    saveAllData();
                });
                
                document.getElementById('emailNotifications').addEventListener('change', (e) => {
                    systemSettings.emailNotifications = e.target.checked;
                    saveAllData();
                });
                
                document.getElementById('requirePayment').addEventListener('change', (e) => {
                    systemSettings.requirePayment = e.target.checked;
                    saveAllData();
                });
                
                document.getElementById('addPromoBtn').addEventListener('click', addPromoCode);
                
                // Payment type selection
                document.querySelectorAll('.payment-type').forEach(type => {
                    type.addEventListener('click', () => selectPayment(type.dataset.payment));
                });
            } catch (error) {
                console.error('Error setting up event listeners:', error);
                showNotification('Failed to set up event listeners. Please refresh the page.', true);
            }
        }
        
        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            try {
                const userId = userIdInput.value;
                const password = passwordInput.value;
                
                const user = users.find(u => u.id === userId && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    loginContainer.style.display = 'none';
                    portalContainer.style.display = 'block';
                    userName.textContent = `${user.firstName} ${user.lastName}`;
                    userRole.textContent = user.role === 'admin' ? 'Administrator' : 'Crew Member';
                    userAvatar.textContent = `${user.firstName.charAt(0)}${user.lastName.charAt(0)}`;
                    
                    if (user.role === 'admin') {
                        adminPanelNav.style.display = 'block';
                    }
                    
                    renderPortal();
                    switchSection(activeSection);
                    showNotification('Login successful!');
                } else {
                    showNotification('Invalid ID or password!', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('An error occurred during login. Please try again.', true);
            }
        }
        
        // Handle logout
        function handleLogout() {
            try {
                currentUser = null;
                localStorage.removeItem('currentUser');
                loginContainer.style.display = 'flex';
                portalContainer.style.display = 'none';
                userIdInput.value = '';
                passwordInput.value = '';
                showNotification('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('An error occurred during logout. Please try again.', true);
            }
        }
        
        // Switch portal section
        function switchSection(section) {
            try {
                navItems.forEach(item => item.classList.remove('active'));
                contentSections.forEach(sec => sec.classList.remove('active'));
                
                const navItem = document.querySelector(`.nav-item[data-section="${section}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
                
                const contentSection = document.getElementById(`${section}Section`);
                if (contentSection) {
                    contentSection.classList.add('active');
                }
                
                activeSection = section;
                localStorage.setItem('activeSection', section);
                
                if (section === 'cashbill') {
                    renderCashbills();
                } else if (section === 'crewProfile') {
                    renderCrewProfile();
                } else if (section === 'courierLogbook') {
                    renderLogbook();
                }
            } catch (error) {
                console.error('Error switching section:', error);
                showNotification('An error occurred while switching sections. Please try again.', true);
            }
        }
        
        // Render portal content
        function renderPortal() {
            try {
                renderCashbills();
                renderCrewProfile();
                renderLogbook();
            } catch (error) {
                console.error('Error rendering portal:', error);
                showNotification('An error occurred while rendering the portal. Please refresh the page.', true);
            }
        }
        
        // Render cashbills
        function renderCashbills() {
            try {
                cashbillList.innerHTML = '';
                
                if (cashbills.length === 0) {
                    cashbillList.innerHTML = '<div class="cashbill-item"><div style="text-align: center; color: var(--text-secondary);">No cashbills found</div></div>';
                    return;
                }
                
                cashbills.forEach(bill => {
                    const billItem = document.createElement('div');
                    billItem.className = 'cashbill-item';
                    
                    const statusClass = bill.status === 'committed' ? 'status-committed' : 
                                       bill.status === 'pending' ? 'status-pending' : 
                                       bill.status === 'reversed' ? 'status-reversed' : 'status-amendment';
                    
                    billItem.innerHTML = `
                        <div class="cashbill-info">
                            <div class="cashbill-id">${bill.id}</div>
                            <div class="cashbill-details">
                                <div class="cashbill-detail-item">
                                    <i class="fas fa-user"></i>
                                    <span>${bill.customer.firstName} ${bill.customer.lastName}</span>
                                </div>
                                <div class="cashbill-detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${bill.customer.address ? bill.customer.address.split(',')[0] : 'N/A'}</span>
                                </div>
                                <div class="cashbill-detail-item">
                                    <i class="fas fa-box"></i>
                                    <span>${bill.items.length} items</span>
                                </div>
                                <div class="cashbill-detail-item">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>MYR ${bill.total.toFixed(2)}</span>
                                </div>
                                <div class="cashbill-detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${new Date(bill.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="cashbill-status ${statusClass}">${bill.status}</div>
                        <div class="cashbill-actions">
                            <button class="icon-btn" onclick="viewCashbill('${bill.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="icon-btn" onclick="generatePDF('${bill.id}')" title="Generate PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            ${currentUser.role === 'admin' ? `
                                <button class="icon-btn" onclick="editCashbill('${bill.id}')" title="Edit Cashbill">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${bill.status === 'committed' ? `
                                    <button class="icon-btn" onclick="reverseCashbill('${bill.id}')" title="Reverse">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                ` : ''}
                            ` : bill.createdBy === currentUser.id ? `
                                ${bill.status === 'committed' ? `
                                    <button class="icon-btn" onclick="requestAmendment('${bill.id}')" title="Request Amendment">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="icon-btn" onclick="reverseCashbill('${bill.id}')" title="Reverse">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                ` : ''}
                                ${bill.status === 'amendment' && currentUser.role === 'admin' ? `
                                    <button class="icon-btn" onclick="editCashbill('${bill.id}')" title="Edit Cashbill">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${bill.status === 'pending' && currentUser.role === 'admin' ? `
                                    <button class="icon-btn" onclick="approveReverse('${bill.id}')" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;
                    
                    cashbillList.appendChild(billItem);
                });
            } catch (error) {
                console.error('Error rendering cashbills:', error);
                showNotification('An error occurred while rendering cashbills. Please try again.', true);
            }
        }
        
        // Render crew profile
        function renderCrewProfile() {
            try {
                crewProfile.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar">${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}</div>
                        <div class="profile-info">
                            <h2>${currentUser.firstName} ${currentUser.lastName}</h2>
                            <p>${currentUser.role === 'admin' ? 'Administrator' : 'Crew Member'}</p>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">User ID</div>
                            <div class="detail-value">${currentUser.id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${currentUser.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${currentUser.phone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Outlet Location</div>
                            <div class="detail-value">${currentUser.outlet}</div>
                        </div>
                    </div>
                    
                    ${currentUser.role === 'admin' ? `
                        <div style="margin-top: 24px;">
                            <h3 style="font-size: 18px; margin-bottom: 16px; color: var(--primary-black);">Manage Crew Members</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                                ${users.filter(u => u.role === 'crew').map(crew => `
                                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <div style="font-weight: 600;">${crew.firstName} ${crew.lastName}</div>
                                            <div style="width: 36px; height: 36px; border-radius: 50%; background-color: var(--accent-color); color: white; display: flex; justify-content: center; align-items: center; font-weight: 600;">
                                                ${crew.firstName.charAt(0)}${crew.lastName.charAt(0)}
                                            </div>
                                        </div>
                                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">ID: ${crew.id}</div>
                                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Outlet: ${crew.outlet}</div>
                                        <button class="btn" style="width: 100%; margin-top: 8px;" onclick="editCrewMember('${crew.id}')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error rendering crew profile:', error);
                showNotification('An error occurred while rendering crew profile. Please try again.', true);
            }
        }
        
        // Render logbook
        function renderLogbook() {
            try {
                logbookList.innerHTML = '';
                
                if (logbookEntries.length === 0) {
                    logbookList.innerHTML = '<div class="logbook-item"><div style="text-align: center; color: var(--text-secondary);">No logbook entries found</div></div>';
                    return;
                }
                
                logbookEntries.forEach(entry => {
                    const logbookItem = document.createElement('div');
                    logbookItem.className = 'logbook-item';
                    
                    logbookItem.innerHTML = `
                        <div class="logbook-header">
                            <div class="logbook-id">${entry.id}</div>
                            <div class="logbook-date">${new Date(entry.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div class="logbook-details">
                            <div class="logbook-detail">
                                <div class="logbook-label">Name</div>
                                <div class="logbook-value">${entry.firstName} ${entry.lastName}</div>
                            </div>
                            <div class="logbook-detail">
                                <div class="logbook-label">Phone</div>
                                <div class="logbook-value">${entry.phone}</div>
                            </div>
                            <div class="logbook-detail">
                                <div class="logbook-label">Email</div>
                                <div class="logbook-value">${entry.email}</div>
                            </div>
                            <div class="logbook-detail">
                                <div class="logbook-label">Address</div>
                                <div class="logbook-value">${entry.address}, ${entry.city}</div>
                            </div>
                            ${entry.notes ? `
                                <div class="logbook-detail" style="grid-column: 1 / -1;">
                                    <div class="logbook-label">Notes</div>
                                    <div class="logbook-value">${entry.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    logbookList.appendChild(logbookItem);
                });
            } catch (error) {
                console.error('Error rendering logbook:', error);
                showNotification('An error occurred while rendering logbook. Please try again.', true);
            }
        }
        
        // Render crew list
        function renderCrewList() {
            try {
                crewList.innerHTML = '';
                
                const crewMembers = users.filter(u => u.role === 'crew');
                
                if (crewMembers.length === 0) {
                    crewList.innerHTML = '<div class="crew-item"><div style="text-align: center; color: var(--text-secondary);">No crew members found</div></div>';
                    return;
                }
                
                crewMembers.forEach(crew => {
                    const crewItem = document.createElement('div');
                    crewItem.className = 'crew-item';
                    
                    crewItem.innerHTML = `
                        <div class="crew-info">
                            <div class="crew-avatar-small">${crew.firstName.charAt(0)}${crew.lastName.charAt(0)}</div>
                            <div class="crew-details">
                                <h4>${crew.firstName} ${crew.lastName}</h4>
                                <p>ID: ${crew.id} | Outlet: ${crew.outlet}</p>
                            </div>
                        </div>
                        <div class="crew-actions">
                            <button class="icon-btn" onclick="editCrewMember('${crew.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn" onclick="deleteCrewMember('${crew.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    crewList.appendChild(crewItem);
                });
            } catch (error) {
                console.error('Error rendering crew list:', error);
                showNotification('An error occurred while rendering crew list. Please try again.', true);
            }
        }
        
        // Render system settings
        function renderSystemSettings() {
            try {
                // Update toggle switches
                document.getElementById('autoSaveDrafts').checked = systemSettings.autoSaveDrafts;
                document.getElementById('emailNotifications').checked = systemSettings.emailNotifications;
                document.getElementById('requirePayment').checked = systemSettings.requirePayment;
            } catch (error) {
                console.error('Error rendering system settings:', error);
                showNotification('An error occurred while rendering system settings. Please try again.', true);
            }
        }
        
        // Render items list
        function renderItemsList() {
            try {
                itemsList.innerHTML = '';
                
                if (itemTypes.length === 0) {
                    itemsList.innerHTML = '<div class="crew-item"><div style="text-align: center; color: var(--text-secondary);">No items found</div></div>';
                    return;
                }
                
                itemTypes.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'crew-item';
                    
                    itemElement.innerHTML = `
                        <div class="crew-info">
                            <div>
                                <h4>${item.name}</h4>
                                <p>ID: ${item.id} | Regular: MYR ${item.regularPrice} | Member: MYR ${item.memberPrice}</p>
                            </div>
                        </div>
                        <div class="crew-actions">
                            <button class="icon-btn" onclick="editItem('${item.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn" onclick="deleteItem('${item.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    itemsList.appendChild(itemElement);
                });
            } catch (error) {
                console.error('Error rendering items list:', error);
                showNotification('An error occurred while rendering items list. Please try again.', true);
            }
        }
        
        // Open new cashbill modal
        function openNewCashbillModal() {
            try {
                // Reset form
                document.getElementById('cashbillForm').reset();
                selectedItems = [];
                selectedPayment = null;
                appliedPromo = null;
                discount = 0;
                itemCounter = 1;
                paymentProcessed = false;
                
                // Clear items table
                document.getElementById('itemsTableBody').innerHTML = '';
                
                // Reset payment processing
                paymentProcessing.classList.remove('active');
                processPaymentBtn.disabled = false;
                processPaymentBtn.innerHTML = '<i class="fas fa-credit-card"></i> Process Payment';
                
                // Update totals
                updateTotals();
                
                newCashbillModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening new cashbill modal:', error);
                showNotification('An error occurred while opening the new cashbill modal. Please try again.', true);
            }
        }
        
        // Close new cashbill modal
        function closeNewCashbillModal() {
            try {
                newCashbillModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing new cashbill modal:', error);
            }
        }
        
        // Open cashbill detail modal
        function openCashbillDetailModal(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                const cashbillDetail = document.getElementById('cashbillDetail');
                const cashbillActionButtons = document.getElementById('cashbillActionButtons');
                
                // Get creator info
                const creator = users.find(u => u.id === bill.createdBy) || {};
                
                cashbillDetail.innerHTML = `
                    <div class="cashbill-detail-header">
                        <div>
                            <div class="cashbill-detail-title">${bill.id}</div>
                            <div style="color: var(--text-secondary); margin-top: 8px;">
                                Created on ${new Date(bill.createdAt).toLocaleDateString()} at ${new Date(bill.createdAt).toLocaleTimeString()}
                            </div>
                        </div>
                        <div class="cashbill-detail-status status-${bill.status}">${bill.status}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">
                            <i class="fas fa-user"></i> Customer Information
                        </h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">First Name</div>
                                <div class="detail-value">${bill.customer.firstName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Last Name</div>
                                <div class="detail-value">${bill.customer.lastName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Phone Number</div>
                                <div class="detail-value">${bill.customer.phone}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">${bill.customer.email}</div>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">${bill.customer.address || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">
                            <i class="fas fa-box"></i> Items
                        </h3>
                        <div class="detail-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">SNO</th>
                                        <th style="width: 15%;">Qty</th>
                                        <th style="width: 30%;">Description</th>
                                        <th style="width: 10%;">Tax %</th>
                                        <th style="width: 15%;">Unit Price (MYR)</th>
                                        <th style="width: 20%;">Adj Total (MYR)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bill.items.map(item => `
                                        <tr>
                                            <td>${item.sno}</td>
                                            <td>${item.qty}</td>
                                            <td>${item.description}</td>
                                            <td>${item.taxRate}%</td>
                                            <td>${item.unitPrice.toFixed(2)}</td>
                                            <td>${item.adjTotal.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    ${bill.remarks ? `
                        <div class="detail-section">
                            <h3 class="detail-section-title">
                                <i class="fas fa-comment-alt"></i> Remarks
                            </h3>
                            <div class="detail-value">${bill.remarks}</div>
                        </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">
                            <i class="fas fa-info-circle"></i> Additional Information
                        </h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Payment Type</div>
                                <div class="detail-value">${bill.paymentType.charAt(0).toUpperCase() + bill.paymentType.slice(1)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Created By</div>
                                <div class="detail-value">${creator.firstName || 'Unknown'} ${creator.lastName || ''} (${bill.createdBy})</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Outlet</div>
                                <div class="detail-value">${creator.outlet || 'Unknown'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Promo Code</div>
                                <div class="detail-value">${bill.promoCode || 'None'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">
                            <i class="fas fa-calculator"></i> Payment Summary
                        </h3>
                        <div class="detail-summary">
                            <table class="detail-summary-table">
                                <tr>
                                    <td>Subtotal:</td>
                                    <td>MYR ${bill.subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>Tax:</td>
                                    <td>MYR ${bill.tax.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>Discount:</td>
                                    <td>MYR ${bill.discount.toFixed(2)}</td>
                                </tr>
                                <tr class="total">
                                    <td>Total:</td>
                                    <td>MYR ${bill.total.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
                
                // Set action buttons based on user role and bill status
                cashbillActionButtons.innerHTML = '';
                
                if (currentUser.role === 'admin') {
                    cashbillActionButtons.innerHTML += `
                        <button class="btn" onclick="editCashbill('${bill.id}')">
                            <i class="fas fa-edit"></i> Edit Cashbill
                        </button>
                    `;
                    
                    if (bill.status === 'committed') {
                        cashbillActionButtons.innerHTML += `
                            <button class="btn btn-danger" onclick="reverseCashbill('${bill.id}')">
                                <i class="fas fa-undo"></i> Reverse
                            </button>
                        `;
                    }
                } else if (bill.createdBy === currentUser.id) {
                    if (bill.status === 'committed') {
                        cashbillActionButtons.innerHTML += `
                            <button class="btn btn-warning" onclick="requestAmendment('${bill.id}')">
                                <i class="fas fa-edit"></i> Request Amendment
                            </button>
                            <button class="btn btn-danger" onclick="reverseCashbill('${bill.id}')">
                                <i class="fas fa-undo"></i> Reverse
                            </button>
                        `;
                    } else if (bill.status === 'amendment' && currentUser.role === 'admin') {
                        cashbillActionButtons.innerHTML += `
                            <button class="btn" onclick="editCashbill('${bill.id}')">
                                <i class="fas fa-edit"></i> Edit Cashbill
                            </button>
                        `;
                    } else if (bill.status === 'pending' && currentUser.role === 'admin') {
                        cashbillActionButtons.innerHTML += `
                            <button class="btn btn-success" onclick="approveReverse('${bill.id}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        `;
                    }
                }
                
                cashbillDetailModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening cashbill detail modal:', error);
                showNotification('An error occurred while opening the cashbill detail modal. Please try again.', true);
            }
        }
        
        // Close cashbill detail modal
        function closeCashbillDetailModal() {
            try {
                cashbillDetailModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing cashbill detail modal:', error);
            }
        }
        
        // Open edit cashbill modal
        function openEditCashbillModal(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                currentEditingCashbill = bill;
                
                // Populate form with bill data
                document.getElementById('editCustomerFirstName').value = bill.customer.firstName;
                document.getElementById('editCustomerLastName').value = bill.customer.lastName;
                document.getElementById('editCustomerPhone').value = bill.customer.phone;
                document.getElementById('editCustomerEmail').value = bill.customer.email;
                document.getElementById('editCustomerAddress').value = bill.customer.address || '';
                document.getElementById('editCashbillRemarks').value = bill.remarks || '';
                document.getElementById('editPromoCode').value = bill.promoCode || '';
                
                // Set payment type
                document.querySelectorAll('#editPaymentTypes .payment-type').forEach(type => {
                    type.classList.remove('active');
                    if (type.dataset.payment === bill.paymentType) {
                        type.classList.add('active');
                    }
                });
                selectedPayment = bill.paymentType;
                
                // Reset edit payment processing
                editPaymentProcessing.classList.remove('active');
                editProcessPaymentBtn.disabled = false;
                editProcessPaymentBtn.innerHTML = '<i class="fas fa-credit-card"></i> Process Payment';
                editPaymentProcessed = false;
                
                // Clear and populate items table
                const itemsTableBody = document.getElementById('editItemsTableBody');
                itemsTableBody.innerHTML = '';
                
                bill.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.sno}</td>
                        <td>
                            <input type="number" class="quantity-input" min="1" value="${item.qty}" onchange="updateEditItemRow(this)">
                        </td>
                        <td>
                            <select class="item-select" onchange="updateEditItemRow(this)">
                                <option value="">Select an item</option>
                                ${itemTypes.map(type => `
                                    <option value="${type.id}" data-regular="${type.regularPrice}" data-member="${type.memberPrice}" data-tax="${type.taxRate}" data-min="${type.minOrder || 0}" ${type.name === item.description ? 'selected' : ''}>
                                        ${type.name} - MYR ${type.regularPrice} (Member: MYR ${type.memberPrice})
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td>
                            <input type="number" class="tax-input" min="0" max="100" value="${item.taxRate}" onchange="updateEditItemRow(this)">
                        </td>
                        <td>
                            <input type="number" class="price-input" min="0" step="0.01" value="${item.unitPrice}" onchange="updateEditItemRow(this)">
                        </td>
                        <td class="total-excl-tax">MYR ${item.totalExclTax.toFixed(2)}</td>
                        <td class="total-tax">MYR ${item.totalTax.toFixed(2)}</td>
                        <td class="adj-total">MYR ${item.adjTotal.toFixed(2)}</td>
                        <td>
                            <button class="action-btn" onclick="removeEditItemRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsTableBody.appendChild(row);
                });
                
                // Update totals
                updateEditTotals();
                
                editCashbillModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit cashbill modal:', error);
                showNotification('An error occurred while opening the edit cashbill modal. Please try again.', true);
            }
        }
        
        // Close edit cashbill modal
        function closeEditCashbillModal() {
            try {
                editCashbillModal.style.display = 'none';
                currentEditingCashbill = null;
            } catch (error) {
                console.error('Error closing edit cashbill modal:', error);
            }
        }
        
        // Open edit profile modal
        function openEditProfileModal() {
            try {
                // Populate form with current user data
                document.getElementById('profileFirstName').value = currentUser.firstName;
                document.getElementById('profileLastName').value = currentUser.lastName;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = currentUser.phone;
                document.getElementById('profileOutlet').value = currentUser.outlet;
                document.getElementById('profilePassword').value = '';
                
                editProfileModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit profile modal:', error);
                showNotification('An error occurred while opening the edit profile modal. Please try again.', true);
            }
        }
        
        // Close edit profile modal
        function closeEditProfileModal() {
            try {
                editProfileModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing edit profile modal:', error);
            }
        }
        
        // Open new logbook modal
        function openNewLogbookModal() {
            try {
                // Reset form
                document.getElementById('logbookForm').reset();
                
                newLogbookModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening new logbook modal:', error);
                showNotification('An error occurred while opening the new logbook modal. Please try again.', true);
            }
        }
        
        // Close new logbook modal
        function closeNewLogbookModal() {
            try {
                newLogbookModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing new logbook modal:', error);
            }
        }
        
        // Open add crew modal
        function openAddCrewModal() {
            try {
                // Reset form
                document.getElementById('addCrewForm').reset();
                
                addCrewModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening add crew modal:', error);
                showNotification('An error occurred while opening the add crew modal. Please try again.', true);
            }
        }
        
        // Close add crew modal
        function closeAddCrewModal() {
            try {
                addCrewModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing add crew modal:', error);
            }
        }
        
        // Open edit crew modal
        function openEditCrewModal(id) {
            try {
                const crew = users.find(u => u.id === id);
                if (!crew) return;
                
                currentEditingCrew = crew;
                
                // Populate form with crew data
                document.getElementById('editCrewId').value = crew.id;
                document.getElementById('editCrewPassword').value = '';
                document.getElementById('editCrewFirstName').value = crew.firstName;
                document.getElementById('editCrewLastName').value = crew.lastName;
                document.getElementById('editCrewEmail').value = crew.email;
                document.getElementById('editCrewPhone').value = crew.phone;
                document.getElementById('editCrewOutlet').value = crew.outlet;
                
                editCrewModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit crew modal:', error);
                showNotification('An error occurred while opening the edit crew modal. Please try again.', true);
            }
        }
        
        // Close edit crew modal
        function closeEditCrewModal() {
            try {
                editCrewModal.style.display = 'none';
                currentEditingCrew = null;
            } catch (error) {
                console.error('Error closing edit crew modal:', error);
            }
        }
        
        // Open add item modal
        function openAddItemModal() {
            try {
                // Reset form
                document.getElementById('addItemForm').reset();
                
                addItemModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening add item modal:', error);
                showNotification('An error occurred while opening the add item modal. Please try again.', true);
            }
        }
        
        // Close add item modal
        function closeAddItemModal() {
            try {
                addItemModal.style.display = 'none';
            } catch (error) {
                console.error('Error closing add item modal:', error);
            }
        }
        
        // Open edit item modal
        function openEditItemModal(id) {
            try {
                const item = itemTypes.find(i => i.id === id);
                if (!item) return;
                
                currentEditingItem = item;
                
                // Populate form with item data
                document.getElementById('editItemId').value = item.id;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemRegularPrice').value = item.regularPrice;
                document.getElementById('editItemMemberPrice').value = item.memberPrice;
                document.getElementById('editItemTaxRate').value = item.taxRate;
                document.getElementById('editItemMinOrder').value = item.minOrder || '';
                document.getElementById('editItemDescription').value = item.description || '';
                
                editItemModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit item modal:', error);
                showNotification('An error occurred while opening the edit item modal. Please try again.', true);
            }
        }
        
        // Close edit item modal
        function closeEditItemModal() {
            try {
                editItemModal.style.display = 'none';
                currentEditingItem = null;
            } catch (error) {
                console.error('Error closing edit item modal:', error);
            }
        }
        
        // Open approval modal
        function openApprovalModal(message, action) {
            try {
                document.getElementById('approvalMessage').textContent = message;
                document.getElementById('crewId').value = '';
                document.getElementById('crewPassword').value = '';
                pendingAction = action;
                approvalModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening approval modal:', error);
                showNotification('An error occurred while opening the approval modal. Please try again.', true);
            }
        }
        
        // Close approval modal
        function closeApprovalModal() {
            try {
                approvalModal.style.display = 'none';
                pendingAction = null;
            } catch (error) {
                console.error('Error closing approval modal:', error);
            }
        }
        
        // Add new item to table
        function addNewItem() {
            try {
                const tableBody = document.getElementById('itemsTableBody');
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${itemCounter}</td>
                    <td>
                        <input type="number" class="quantity-input" min="1" value="1" onchange="updateItemRow(this)">
                    </td>
                    <td>
                        <select class="item-select" onchange="updateItemRow(this)">
                            <option value="">Select an item</option>
                            ${itemTypes.map(item => `
                                <option value="${item.id}" data-regular="${item.regularPrice}" data-member="${item.memberPrice}" data-tax="${item.taxRate}" data-min="${item.minOrder || 0}">
                                    ${item.name} - MYR ${item.regularPrice} (Member: MYR ${item.memberPrice})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="tax-input" min="0" max="100" value="10" onchange="updateItemRow(this)">
                    </td>
                    <td>
                        <input type="number" class="price-input" min="0" step="0.01" value="0" onchange="updateItemRow(this)">
                    </td>
                    <td class="total-excl-tax">MYR 0.00</td>
                    <td class="total-tax">MYR 0.00</td>
                    <td class="adj-total">MYR 0.00</td>
                    <td>
                        <button class="action-btn" onclick="removeItemRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                itemCounter++;
            } catch (error) {
                console.error('Error adding new item:', error);
                showNotification('An error occurred while adding a new item. Please try again.', true);
            }
        }
        
        // Add new item to edit table
        function addEditItem() {
            try {
                const tableBody = document.getElementById('editItemsTableBody');
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${itemCounter}</td>
                    <td>
                        <input type="number" class="quantity-input" min="1" value="1" onchange="updateEditItemRow(this)">
                    </td>
                    <td>
                        <select class="item-select" onchange="updateEditItemRow(this)">
                            <option value="">Select an item</option>
                            ${itemTypes.map(item => `
                                <option value="${item.id}" data-regular="${item.regularPrice}" data-member="${item.memberPrice}" data-tax="${item.taxRate}" data-min="${item.minOrder || 0}">
                                    ${item.name} - MYR ${item.regularPrice} (Member: MYR ${item.memberPrice})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="tax-input" min="0" max="100" value="10" onchange="updateEditItemRow(this)">
                    </td>
                    <td>
                        <input type="number" class="price-input" min="0" step="0.01" value="0" onchange="updateEditItemRow(this)">
                    </td>
                    <td class="total-excl-tax">MYR 0.00</td>
                    <td class="total-tax">MYR 0.00</td>
                    <td class="adj-total">MYR 0.00</td>
                    <td>
                        <button class="action-btn" onclick="removeEditItemRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                itemCounter++;
            } catch (error) {
                console.error('Error adding new edit item:', error);
                showNotification('An error occurred while adding a new edit item. Please try again.', true);
            }
        }
        
        // Update item row calculations
        function updateItemRow(element) {
            try {
                const row = element.closest('tr');
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const itemSelect = row.querySelector('.item-select');
                const selectedItem = itemSelect.options[itemSelect.selectedIndex];
                const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                
                // If an item is selected, update the unit price
                if (selectedItem.value) {
                    const regularPrice = parseFloat(selectedItem.dataset.regular);
                    const memberPrice = parseFloat(selectedItem.dataset.member);
                    const minOrder = parseInt(selectedItem.dataset.min) || 0;
                    
                    // Check if quantity meets minimum order requirement
                    if (quantity < minOrder) {
                        showNotification(`Minimum order for ${selectedItem.text.split(' - ')[0]} is ${minOrder} sets!`, true);
                        row.querySelector('.quantity-input').value = minOrder;
                        return updateItemRow(row.querySelector('.quantity-input'));
                    }
                    
                    // Use member price if available, otherwise regular price
                    row.querySelector('.price-input').value = memberPrice || regularPrice;
                    return updateItemRow(row.querySelector('.price-input'));
                }
                
                // Calculate totals
                const totalExclTax = quantity * unitPrice;
                const totalTax = totalExclTax * (taxRate / 100);
                const adjTotal = totalExclTax + totalTax;
                
                // Update display
                row.querySelector('.total-excl-tax').textContent = `MYR ${totalExclTax.toFixed(2)}`;
                row.querySelector('.total-tax').textContent = `MYR ${totalTax.toFixed(2)}`;
                row.querySelector('.adj-total').textContent = `MYR ${adjTotal.toFixed(2)}`;
                
                // Update overall totals
                updateTotals();
            } catch (error) {
                console.error('Error updating item row:', error);
                showNotification('An error occurred while updating the item row. Please try again.', true);
            }
        }
        
        // Update edit item row calculations
        function updateEditItemRow(element) {
            try {
                const row = element.closest('tr');
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const itemSelect = row.querySelector('.item-select');
                const selectedItem = itemSelect.options[itemSelect.selectedIndex];
                const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                
                // If an item is selected, update the unit price
                if (selectedItem.value) {
                    const regularPrice = parseFloat(selectedItem.dataset.regular);
                    const memberPrice = parseFloat(selectedItem.dataset.member);
                    const minOrder = parseInt(selectedItem.dataset.min) || 0;
                    
                    // Check if quantity meets minimum order requirement
                    if (quantity < minOrder) {
                        showNotification(`Minimum order for ${selectedItem.text.split(' - ')[0]} is ${minOrder} sets!`, true);
                        row.querySelector('.quantity-input').value = minOrder;
                        return updateEditItemRow(row.querySelector('.quantity-input'));
                    }
                    
                    // Use member price if available, otherwise regular price
                    row.querySelector('.price-input').value = memberPrice || regularPrice;
                    return updateEditItemRow(row.querySelector('.price-input'));
                }
                
                // Calculate totals
                const totalExclTax = quantity * unitPrice;
                const totalTax = totalExclTax * (taxRate / 100);
                const adjTotal = totalExclTax + totalTax;
                
                // Update display
                row.querySelector('.total-excl-tax').textContent = `MYR ${totalExclTax.toFixed(2)}`;
                row.querySelector('.total-tax').textContent = `MYR ${totalTax.toFixed(2)}`;
                row.querySelector('.adj-total').textContent = `MYR ${adjTotal.toFixed(2)}`;
                
                // Update overall totals
                updateEditTotals();
            } catch (error) {
                console.error('Error updating edit item row:', error);
                showNotification('An error occurred while updating the edit item row. Please try again.', true);
            }
        }
        
        // Remove item row
        function removeItemRow(button) {
            try {
                const row = button.closest('tr');
                row.remove();
                updateTotals();
            } catch (error) {
                console.error('Error removing item row:', error);
                showNotification('An error occurred while removing the item row. Please try again.', true);
            }
        }
        
        // Remove edit item row
        function removeEditItemRow(button) {
            try {
                const row = button.closest('tr');
                row.remove();
                updateEditTotals();
            } catch (error) {
                console.error('Error removing edit item row:', error);
                showNotification('An error occurred while removing the edit item row. Please try again.', true);
            }
        }
        
        // Update overall totals
        function updateTotals() {
            try {
                const rows = document.querySelectorAll('#itemsTableBody tr');
                let subtotal = 0;
                let totalTax = 0;
                let adjTotal = 0;
                
                rows.forEach(row => {
                    const exclTaxText = row.querySelector('.total-excl-tax').textContent;
                    const taxText = row.querySelector('.total-tax').textContent;
                    const adjText = row.querySelector('.adj-total').textContent;
                    
                    subtotal += parseFloat(exclTaxText.replace('MYR ', '')) || 0;
                    totalTax += parseFloat(taxText.replace('MYR ', '')) || 0;
                    adjTotal += parseFloat(adjText.replace('MYR ', '')) || 0;
                });
                
                // Apply discount if any
                const totalAfterDiscount = adjTotal - discount;
                
                // Update display
                document.getElementById('subtotal').textContent = `MYR ${subtotal.toFixed(2)}`;
                document.getElementById('tax').textContent = `MYR ${totalTax.toFixed(2)}`;
                document.getElementById('discount').textContent = `MYR ${discount.toFixed(2)}`;
                document.getElementById('total').textContent = `MYR ${totalAfterDiscount.toFixed(2)}`;
                
                // Update payment display if payment is selected
                if (selectedPayment) {
                    updatePaymentDisplay();
                }
            } catch (error) {
                console.error('Error updating totals:', error);
                showNotification('An error occurred while updating totals. Please try again.', true);
            }
        }
        
        // Update edit overall totals
        function updateEditTotals() {
            try {
                const rows = document.querySelectorAll('#editItemsTableBody tr');
                let subtotal = 0;
                let totalTax = 0;
                let adjTotal = 0;
                
                rows.forEach(row => {
                    const exclTaxText = row.querySelector('.total-excl-tax').textContent;
                    const taxText = row.querySelector('.total-tax').textContent;
                    const adjText = row.querySelector('.adj-total').textContent;
                    
                    subtotal += parseFloat(exclTaxText.replace('MYR ', '')) || 0;
                    totalTax += parseFloat(taxText.replace('MYR ', '')) || 0;
                    adjTotal += parseFloat(adjText.replace('MYR ', '')) || 0;
                });
                
                // Apply discount if any
                const totalAfterDiscount = adjTotal - discount;
                
                // Update display
                document.getElementById('editSubtotal').textContent = `MYR ${subtotal.toFixed(2)}`;
                document.getElementById('editTax').textContent = `MYR ${totalTax.toFixed(2)}`;
                document.getElementById('editDiscount').textContent = `MYR ${discount.toFixed(2)}`;
                document.getElementById('editTotal').textContent = `MYR ${totalAfterDiscount.toFixed(2)}`;
                
                // Update payment display if payment is selected
                if (selectedPayment) {
                    updateEditPaymentDisplay();
                }
            } catch (error) {
                console.error('Error updating edit totals:', error);
                showNotification('An error occurred while updating edit totals. Please try again.', true);
            }
        }
        
        // Select payment type
        function selectPayment(type) {
            try {
                document.querySelectorAll('.payment-type').forEach(el => el.classList.remove('active'));
                document.querySelector(`.payment-type[data-payment="${type}"]`).classList.add('active');
                selectedPayment = type;
                
                // Show payment processing section
                paymentProcessing.classList.add('active');
                updatePaymentDisplay();
            } catch (error) {
                console.error('Error selecting payment type:', error);
                showNotification('An error occurred while selecting payment type. Please try again.', true);
            }
        }
        
        // Update payment display
        function updatePaymentDisplay() {
            try {
                if (!selectedPayment) return;
                
                const totalText = document.getElementById('total').textContent;
                const totalAmount = parseFloat(totalText.replace('MYR ', '')) || 0;
                
                // Update payment method description
                let paymentDesc = '';
                switch(selectedPayment) {
                    case 'cash':
                        paymentDesc = 'Cash Payment - Please prepare exact amount';
                        break;
                    case 'card':
                        paymentDesc = 'Card Payment - Please have your card ready';
                        break;
                    case 'ewallet':
                        paymentDesc = 'E-Wallet Payment - Please open your e-wallet app';
                        break;
                }
                
                paymentMethodDesc.textContent = paymentDesc;
                paymentAmount.textContent = `MYR ${totalAmount.toFixed(2)}`;
            } catch (error) {
                console.error('Error updating payment display:', error);
                showNotification('An error occurred while updating payment display. Please try again.', true);
            }
        }
        
        // Update edit payment display
        function updateEditPaymentDisplay() {
            try {
                if (!selectedPayment) return;
                
                const totalText = document.getElementById('editTotal').textContent;
                const totalAmount = parseFloat(totalText.replace('MYR ', '')) || 0;
                
                // Show edit payment processing section
                editPaymentProcessing.classList.add('active');
                
                // Update payment method description
                let paymentDesc = '';
                switch(selectedPayment) {
                    case 'cash':
                        paymentDesc = 'Cash Payment - Please prepare exact amount';
                        break;
                    case 'card':
                        paymentDesc = 'Card Payment - Please have your card ready';
                        break;
                    case 'ewallet':
                        paymentDesc = 'E-Wallet Payment - Please open your e-wallet app';
                        break;
                }
                
                editPaymentMethodDesc.textContent = paymentDesc;
                editPaymentAmount.textContent = `MYR ${totalAmount.toFixed(2)}`;
            } catch (error) {
                console.error('Error updating edit payment display:', error);
                showNotification('An error occurred while updating edit payment display. Please try again.', true);
            }
        }
        
        // Apply promo code
        function applyPromoCode() {
            try {
                const promoCode = promoCodeInput.value.toUpperCase();
                
                if (!promoCode) {
                    discount = 0;
                    appliedPromo = null;
                    updateTotals();
                    return;
                }
                
                if (promoCodes[promoCode]) {
                    const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('MYR ', '')) || 0;
                    discount = subtotal * promoCodes[promoCode];
                    appliedPromo = promoCode;
                    updateTotals();
                    showNotification(`Promo code ${promoCode} applied! ${discount * 100}% discount`);
                } else {
                    showNotification('Invalid promo code!', true);
                    promoCodeInput.value = '';
                }
            } catch (error) {
                console.error('Error applying promo code:', error);
                showNotification('An error occurred while applying promo code. Please try again.', true);
            }
        }
        
        // Apply edit promo code
        function applyEditPromoCode() {
            try {
                const promoCode = editPromoCodeInput.value.toUpperCase();
                
                if (!promoCode) {
                    discount = 0;
                    appliedPromo = null;
                    updateEditTotals();
                    return;
                }
                
                if (promoCodes[promoCode]) {
                    const subtotal = parseFloat(document.getElementById('editSubtotal').textContent.replace('MYR ', '')) || 0;
                    discount = subtotal * promoCodes[promoCode];
                    appliedPromo = promoCode;
                    updateEditTotals();
                    showNotification(`Promo code ${promoCode} applied! ${discount * 100}% discount`);
                } else {
                    showNotification('Invalid promo code!', true);
                    editPromoCodeInput.value = '';
                }
            } catch (error) {
                console.error('Error applying edit promo code:', error);
                showNotification('An error occurred while applying edit promo code. Please try again.', true);
            }
        }
        
        // Save cashbill as draft
        function saveCashbill() {
            try {
                const items = getItemsFromTable();
                
                if (items.length === 0) {
                    showNotification('Please add at least one item!', true);
                    return;
                }
                
                const firstName = document.getElementById('customerFirstName').value;
                const lastName = document.getElementById('customerLastName').value;
                const phone = document.getElementById('customerPhone').value;
                const email = document.getElementById('customerEmail').value;
                const address = document.getElementById('customerAddress').value;
                const remarks = document.getElementById('cashbillRemarks').value;
                
                if (!firstName || !lastName || !phone || !email) {
                    showNotification('Please fill in all customer details!', true);
                    return;
                }
                
                // Calculate totals
                const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
                const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
                const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
                
                // Generate new ID
                const lastId = cashbills.length > 0 ? cashbills[cashbills.length - 1].id : '#PNE0000';
                const newIdNum = parseInt(lastId.substring(4)) + 1;
                const newId = `#PNE${newIdNum.toString().padStart(4, '0')}`;
                
                const newCashbill = {
                    id: newId,
                    customer: { firstName, lastName, phone, email, address },
                    paymentType: selectedPayment || 'cash',
                    items,
                    subtotal,
                    tax,
                    discount,
                    total,
                    promoCode: appliedPromo,
                    remarks,
                    status: 'draft',
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                cashbills.push(newCashbill);
                saveCashbills();
                renderCashbills();
                closeNewCashbillModal();
                showNotification('Cashbill saved as draft!');
            } catch (error) {
                console.error('Error saving cashbill:', error);
                showNotification('An error occurred while saving cashbill. Please try again.', true);
            }
        }
        
        // Commit cashbill
        function commitCashbill() {
            try {
                const items = getItemsFromTable();
                
                if (items.length === 0) {
                    showNotification('Please add at least one item!', true);
                    return;
                }
                
                if (!selectedPayment) {
                    showNotification('Please select a payment type!', true);
                    return;
                }
                
                if (systemSettings.requirePayment && !paymentProcessed) {
                    showNotification('Please process the payment first!', true);
                    return;
                }
                
                const firstName = document.getElementById('customerFirstName').value;
                const lastName = document.getElementById('customerLastName').value;
                const phone = document.getElementById('customerPhone').value;
                const email = document.getElementById('customerEmail').value;
                const address = document.getElementById('customerAddress').value;
                const remarks = document.getElementById('cashbillRemarks').value;
                
                if (!firstName || !lastName || !phone || !email) {
                    showNotification('Please fill in all customer details!', true);
                    return;
                }
                
                // Calculate totals
                const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
                const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
                const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
                
                // Generate new ID
                const lastId = cashbills.length > 0 ? cashbills[cashbills.length - 1].id : '#PNE0000';
                const newIdNum = parseInt(lastId.substring(4)) + 1;
                const newId = `#PNE${newIdNum.toString().padStart(4, '0')}`;
                
                const newCashbill = {
                    id: newId,
                    customer: { firstName, lastName, phone, email, address },
                    paymentType: selectedPayment,
                    items,
                    subtotal,
                    tax,
                    discount,
                    total,
                    promoCode: appliedPromo,
                    remarks,
                    status: 'committed',
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                cashbills.push(newCashbill);
                saveCashbills();
                renderCashbills();
                closeNewCashbillModal();
                showNotification('Cashbill committed successfully!');
            } catch (error) {
                console.error('Error committing cashbill:', error);
                showNotification('An error occurred while committing cashbill. Please try again.', true);
            }
        }
        
        // Save edited cashbill
        function saveEditCashbill() {
            try {
                if (!currentEditingCashbill) return;
                
                const items = getEditItemsFromTable();
                
                if (items.length === 0) {
                    showNotification('Please add at least one item!', true);
                    return;
                }
                
                if (!selectedPayment) {
                    showNotification('Please select a payment type!', true);
                    return;
                }
                
                if (systemSettings.requirePayment && !editPaymentProcessed) {
                    showNotification('Please process the payment first!', true);
                    return;
                }
                
                const firstName = document.getElementById('editCustomerFirstName').value;
                const lastName = document.getElementById('editCustomerLastName').value;
                const phone = document.getElementById('editCustomerPhone').value;
                const email = document.getElementById('editCustomerEmail').value;
                const address = document.getElementById('editCustomerAddress').value;
                const remarks = document.getElementById('editCashbillRemarks').value;
                
                if (!firstName || !lastName || !phone || !email) {
                    showNotification('Please fill in all customer details!', true);
                    return;
                }
                
                // Calculate totals
                const subtotal = items.reduce((sum, item) => sum + item.totalExclTax, 0);
                const tax = items.reduce((sum, item) => sum + item.totalTax, 0);
                const total = items.reduce((sum, item) => sum + item.adjTotal, 0) - discount;
                
                // Update cashbill
                currentEditingCashbill.customer = { firstName, lastName, phone, email, address };
                currentEditingCashbill.paymentType = selectedPayment;
                currentEditingCashbill.items = items;
                currentEditingCashbill.subtotal = subtotal;
                currentEditingCashbill.tax = tax;
                currentEditingCashbill.discount = discount;
                currentEditingCashbill.total = total;
                currentEditingCashbill.remarks = remarks;
                currentEditingCashbill.status = 'committed';
                
                saveCashbills();
                renderCashbills();
                closeEditCashbillModal();
                closeCashbillDetailModal();
                showNotification('Cashbill updated successfully!');
            } catch (error) {
                console.error('Error saving edited cashbill:', error);
                showNotification('An error occurred while saving edited cashbill. Please try again.', true);
            }
        }
        
        // Get items from table
        function getItemsFromTable() {
            try {
                const rows = document.querySelectorAll('#itemsTableBody tr');
                const items = [];
                
                rows.forEach(row => {
                    const sno = parseInt(row.cells[0].textContent);
                    const qty = parseInt(row.querySelector('.quantity-input').value) || 0;
                    const description = row.querySelector('.item-select').options[row.querySelector('.item-select').selectedIndex].text.split(' - ')[0];
                    const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                    const totalExclTax = parseFloat(row.querySelector('.total-excl-tax').textContent.replace('MYR ', '')) || 0;
                    const totalTax = parseFloat(row.querySelector('.total-tax').textContent.replace('MYR ', '')) || 0;
                    const adjTotal = parseFloat(row.querySelector('.adj-total').textContent.replace('MYR ', '')) || 0;
                    
                    if (description && qty > 0) {
                        items.push({
                            sno,
                            qty,
                            description,
                            taxRate,
                            unitPrice,
                            totalExclTax,
                            totalTax,
                            adjTotal
                        });
                    }
                });
                
                return items;
            } catch (error) {
                console.error('Error getting items from table:', error);
                showNotification('An error occurred while getting items from table. Please try again.', true);
                return [];
            }
        }
        
        // Get items from edit table
        function getEditItemsFromTable() {
            try {
                const rows = document.querySelectorAll('#editItemsTableBody tr');
                const items = [];
                
                rows.forEach(row => {
                    const sno = parseInt(row.cells[0].textContent);
                    const qty = parseInt(row.querySelector('.quantity-input').value) || 0;
                    const description = row.querySelector('.item-select').options[row.querySelector('.item-select').selectedIndex].text.split(' - ')[0];
                    const taxRate = parseFloat(row.querySelector('.tax-input').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.price-input').value) || 0;
                    const totalExclTax = parseFloat(row.querySelector('.total-excl-tax').textContent.replace('MYR ', '')) || 0;
                    const totalTax = parseFloat(row.querySelector('.total-tax').textContent.replace('MYR ', '')) || 0;
                    const adjTotal = parseFloat(row.querySelector('.adj-total').textContent.replace('MYR ', '')) || 0;
                    
                    if (description && qty > 0) {
                        items.push({
                            sno,
                            qty,
                            description,
                            taxRate,
                            unitPrice,
                            totalExclTax,
                            totalTax,
                            adjTotal
                        });
                    }
                });
                
                return items;
            } catch (error) {
                console.error('Error getting edit items from table:', error);
                showNotification('An error occurred while getting edit items from table. Please try again.', true);
                return [];
            }
        }
        
        // Save profile
        function saveProfile() {
            try {
                const firstName = document.getElementById('profileFirstName').value;
                const lastName = document.getElementById('profileLastName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;
                const outlet = document.getElementById('profileOutlet').value;
                const password = document.getElementById('profilePassword').value;
                
                if (!firstName || !lastName || !email || !phone || !outlet) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Update current user
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.outlet = outlet;
                
                if (password) {
                    currentUser.password = password;
                }
                
                // Update user in the users array
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = { ...currentUser };
                }
                
                // Update localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                saveAllData();
                
                // Update UI
                userName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                userAvatar.textContent = `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;
                renderCrewProfile();
                closeEditProfileModal();
                showNotification('Profile updated successfully!');
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('An error occurred while saving profile. Please try again.', true);
            }
        }
        
        // Save logbook entry
        function saveLogbook() {
            try {
                const firstName = document.getElementById('logbookFirstName').value;
                const lastName = document.getElementById('logbookLastName').value;
                const phone = document.getElementById('logbookPhone').value;
                const email = document.getElementById('logbookEmail').value;
                const address = document.getElementById('logbookAddress').value;
                const city = document.getElementById('logbookCity').value;
                const notes = document.getElementById('logbookNotes').value;
                
                if (!firstName || !lastName || !phone || !email || !address || !city) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Generate new ID
                const lastId = logbookEntries.length > 0 ? logbookEntries[logbookEntries.length - 1].id : 'LOG0000';
                const newIdNum = parseInt(lastId.substring(3)) + 1;
                const newId = `LOG${newIdNum.toString().padStart(4, '0')}`;
                
                const newEntry = {
                    id: newId,
                    firstName,
                    lastName,
                    phone,
                    email,
                    address,
                    city,
                    notes,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                logbookEntries.push(newEntry);
                saveLogbook();
                renderLogbook();
                closeNewLogbookModal();
                showNotification('Logbook entry saved successfully!');
            } catch (error) {
                console.error('Error saving logbook entry:', error);
                showNotification('An error occurred while saving logbook entry. Please try again.', true);
            }
        }
        
        // Save add crew
        function saveAddCrew() {
            try {
                const id = document.getElementById('newCrewId').value;
                const password = document.getElementById('newCrewPassword').value;
                const firstName = document.getElementById('newCrewFirstName').value;
                const lastName = document.getElementById('newCrewLastName').value;
                const email = document.getElementById('newCrewEmail').value;
                const phone = document.getElementById('newCrewPhone').value;
                const outlet = document.getElementById('newCrewOutlet').value;
                
                if (!id || !password || !firstName || !lastName || !email || !phone || !outlet) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Check if ID already exists
                if (users.find(u => u.id === id)) {
                    showNotification('User ID already exists!', true);
                    return;
                }
                
                const newCrew = {
                    id,
                    password,
                    firstName,
                    lastName,
                    email,
                    phone,
                    outlet,
                    role: 'crew'
                };
                
                users.push(newCrew);
                saveAllData();
                renderCrewList();
                closeAddCrewModal();
                showNotification('Crew member added successfully!');
            } catch (error) {
                console.error('Error saving add crew:', error);
                showNotification('An error occurred while saving add crew. Please try again.', true);
            }
        }
        
        // Save edit crew
        function saveEditCrew() {
            try {
                if (!currentEditingCrew) return;
                
                const password = document.getElementById('editCrewPassword').value;
                const firstName = document.getElementById('editCrewFirstName').value;
                const lastName = document.getElementById('editCrewLastName').value;
                const email = document.getElementById('editCrewEmail').value;
                const phone = document.getElementById('editCrewPhone').value;
                const outlet = document.getElementById('editCrewOutlet').value;
                
                if (!firstName || !lastName || !email || !phone || !outlet) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Update crew member
                currentEditingCrew.firstName = firstName;
                currentEditingCrew.lastName = lastName;
                currentEditingCrew.email = email;
                currentEditingCrew.phone = phone;
                currentEditingCrew.outlet = outlet;
                
                if (password) {
                    currentEditingCrew.password = password;
                }
                
                // Update user in the users array
                const userIndex = users.findIndex(u => u.id === currentEditingCrew.id);
                if (userIndex !== -1) {
                    users[userIndex] = { ...currentEditingCrew };
                }
                
                saveAllData();
                renderCrewList();
                renderCrewProfile();
                closeEditCrewModal();
                showNotification('Crew member updated successfully!');
            } catch (error) {
                console.error('Error saving edit crew:', error);
                showNotification('An error occurred while saving edit crew. Please try again.', true);
            }
        }
        
        // Delete crew member
        function deleteCrewMember(id) {
            try {
                if (!confirm('Are you sure you want to delete this crew member?')) {
                    return;
                }
                
                users = users.filter(u => u.id !== id);
                saveAllData();
                renderCrewList();
                renderCrewProfile();
                showNotification('Crew member deleted successfully!');
            } catch (error) {
                console.error('Error deleting crew member:', error);
                showNotification('An error occurred while deleting crew member. Please try again.', true);
            }
        }
        
        // Edit crew member
        function editCrewMember(id) {
            try {
                openEditCrewModal(id);
            } catch (error) {
                console.error('Error editing crew member:', error);
                showNotification('An error occurred while editing crew member. Please try again.', true);
            }
        }
        
        // Save add item
        function saveAddItem() {
            try {
                const id = document.getElementById('newItemId').value;
                const name = document.getElementById('newItemName').value;
                const regularPrice = parseFloat(document.getElementById('newItemRegularPrice').value);
                const memberPrice = parseFloat(document.getElementById('newItemMemberPrice').value);
                const taxRate = parseFloat(document.getElementById('newItemTaxRate').value);
                const minOrder = parseInt(document.getElementById('newItemMinOrder').value) || 0;
                const description = document.getElementById('newItemDescription').value;
                
                if (!id || !name || isNaN(regularPrice) || isNaN(memberPrice) || isNaN(taxRate)) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Check if ID already exists
                if (itemTypes.find(i => i.id === id)) {
                    showNotification('Item ID already exists!', true);
                    return;
                }
                
                const newItem = {
                    id,
                    name,
                    regularPrice,
                    memberPrice,
                    taxRate,
                    minOrder,
                    description
                };
                
                itemTypes.push(newItem);
                saveAllData();
                renderItemsList();
                closeAddItemModal();
                showNotification('Item added successfully!');
            } catch (error) {
                console.error('Error saving add item:', error);
                showNotification('An error occurred while saving add item. Please try again.', true);
            }
        }
        
        // Save edit item
        function saveEditItem() {
            try {
                if (!currentEditingItem) return;
                
                const name = document.getElementById('editItemName').value;
                const regularPrice = parseFloat(document.getElementById('editItemRegularPrice').value);
                const memberPrice = parseFloat(document.getElementById('editItemMemberPrice').value);
                const taxRate = parseFloat(document.getElementById('editItemTaxRate').value);
                const minOrder = parseInt(document.getElementById('editItemMinOrder').value) || 0;
                const description = document.getElementById('editItemDescription').value;
                
                if (!name || isNaN(regularPrice) || isNaN(memberPrice) || isNaN(taxRate)) {
                    showNotification('Please fill in all required fields!', true);
                    return;
                }
                
                // Update item
                currentEditingItem.name = name;
                currentEditingItem.regularPrice = regularPrice;
                currentEditingItem.memberPrice = memberPrice;
                currentEditingItem.taxRate = taxRate;
                currentEditingItem.minOrder = minOrder;
                currentEditingItem.description = description;
                
                // Update item in the itemTypes array
                const itemIndex = itemTypes.findIndex(i => i.id === currentEditingItem.id);
                if (itemIndex !== -1) {
                    itemTypes[itemIndex] = { ...currentEditingItem };
                }
                
                saveAllData();
                renderItemsList();
                closeEditItemModal();
                showNotification('Item updated successfully!');
            } catch (error) {
                console.error('Error saving edit item:', error);
                showNotification('An error occurred while saving edit item. Please try again.', true);
            }
        }
        
        // Delete item
        function deleteItem(id) {
            try {
                if (!confirm('Are you sure you want to delete this item?')) {
                    return;
                }
                
                itemTypes = itemTypes.filter(i => i.id !== id);
                saveAllData();
                renderItemsList();
                showNotification('Item deleted successfully!');
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('An error occurred while deleting item. Please try again.', true);
            }
        }
        
        // Edit item
        function editItem(id) {
            try {
                openEditItemModal(id);
            } catch (error) {
                console.error('Error editing item:', error);
                showNotification('An error occurred while editing item. Please try again.', true);
            }
        }
        
        // Add promo code
        function addPromoCode() {
            try {
                const code = document.getElementById('newPromoCode').value.toUpperCase();
                const discount = parseFloat(document.getElementById('newPromoDiscount').value) / 100;
                
                if (!code || isNaN(discount)) {
                    showNotification('Please fill in all fields!', true);
                    return;
                }
                
                if (promoCodes[code]) {
                    showNotification('Promo code already exists!', true);
                    return;
                }
                
                promoCodes[code] = discount;
                saveAllData();
                showNotification('Promo code added successfully!');
                
                // Clear form
                document.getElementById('newPromoCode').value = '';
                document.getElementById('newPromoDiscount').value = '';
            } catch (error) {
                console.error('Error adding promo code:', error);
                showNotification('An error occurred while adding promo code. Please try again.', true);
            }
        }
        
        // View cashbill
        function viewCashbill(id) {
            try {
                openCashbillDetailModal(id);
            } catch (error) {
                console.error('Error viewing cashbill:', error);
                showNotification('An error occurred while viewing cashbill. Please try again.', true);
            }
        }
        
        // Generate PDF
        function generatePDF(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add company header
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('PNE ARENA', 105, 25, { align: 'center' });
                
                // Add invoice title
                doc.setFontSize(20);
                doc.text('INVOICE', 105, 40, { align: 'center' });
                
                // Add cashbill details
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Cashbill No: ${bill.id}`, 20, 60);
                doc.text(`Date: ${new Date(bill.createdAt).toLocaleDateString()}`, 20, 70);
                doc.text(`Status: ${bill.status}`, 20, 80);
                
                // Add customer information
                doc.setFont('helvetica', 'bold');
                doc.text('Bill To:', 20, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`${bill.customer.firstName} ${bill.customer.lastName}`, 20, 110);
                doc.text(bill.customer.phone, 20, 120);
                doc.text(bill.customer.email, 20, 130);
                
                if (bill.customer.address) {
                    const addressLines = doc.splitTextToSize(bill.customer.address, 80);
                    doc.text(addressLines, 20, 140);
                }
                
                // Add payment information
                doc.setFont('helvetica', 'bold');
                doc.text('Payment Method:', 120, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(bill.paymentType.charAt(0).toUpperCase() + bill.paymentType.slice(1), 120, 110);
                
                // Add items table
                doc.setFont('helvetica', 'bold');
                doc.text('Description', 20, 170);
                doc.text('Qty', 100, 170);
                doc.text('Unit Price', 130, 170);
                doc.text('Total', 170, 170);
                
                // Add line
                doc.line(20, 175, 190, 175);
                
                // Add items
                doc.setFont('helvetica', 'normal');
                let yPosition = 185;
                
                bill.items.forEach(item => {
                    doc.text(item.description, 20, yPosition);
                    doc.text(item.qty.toString(), 100, yPosition);
                    doc.text(`MYR ${item.unitPrice.toFixed(2)}`, 130, yPosition);
                    doc.text(`MYR ${item.adjTotal.toFixed(2)}`, 170, yPosition);
                    yPosition += 10;
                });
                
                // Add another line
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 10;
                
                // Add summary
                doc.text('Subtotal:', 130, yPosition);
                doc.text(`MYR ${bill.subtotal.toFixed(2)}`, 170, yPosition);
                yPosition += 10;
                
                doc.text('Tax:', 130, yPosition);
                doc.text(`MYR ${bill.tax.toFixed(2)}`, 170, yPosition);
                yPosition += 10;
                
                doc.text('Discount:', 130, yPosition);
                doc.text(`MYR ${bill.discount.toFixed(2)}`, 170, yPosition);
                yPosition += 10;
                
                // Add total with bold font
                doc.setFont('helvetica', 'bold');
                doc.text('Total:', 130, yPosition);
                doc.text(`MYR ${bill.total.toFixed(2)}`, 170, yPosition);
                
                // Add remarks if any
                if (bill.remarks) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Remarks:', 20, yPosition + 20);
                    doc.setFont('helvetica', 'normal');
                    const remarksLines = doc.splitTextToSize(bill.remarks, 170);
                    doc.text(remarksLines, 20, yPosition + 30);
                }
                
                // Add footer
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('Thank you for your business!', 105, 280, { align: 'center' });
                
                // Save the PDF
                doc.save(`PNE_ARENA_${bill.id}_${bill.customer.firstName}_${bill.customer.lastName}.pdf`);
                
                showNotification('Invoice generated successfully!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('An error occurred while generating PDF. Please try again.', true);
            }
        }
        
        // Print cashbill detail
        function printCashbillDetail() {
            try {
                const billId = document.querySelector('.cashbill-detail-title').textContent;
                generatePDF(billId);
            } catch (error) {
                console.error('Error printing cashbill detail:', error);
                showNotification('An error occurred while printing cashbill detail. Please try again.', true);
            }
        }
        
        // Request amendment
        function requestAmendment(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                if (currentUser.role === 'admin') {
                    // Admin can edit directly
                    openEditCashbillModal(id);
                    closeCashbillDetailModal();
                } else {
                    // Crew needs to request approval
                    openApprovalModal(
                        `Amending cashbill ${bill.id} requires admin approval. Please enter your crew credentials to request approval.`,
                        () => {
                            bill.status = 'amendment';
                            saveCashbills();
                            renderCashbills();
                            closeCashbillDetailModal();
                            showNotification(`Amendment request for cashbill ${bill.id} sent to admin!`);
                        }
                    );
                }
            } catch (error) {
                console.error('Error requesting amendment:', error);
                showNotification('An error occurred while requesting amendment. Please try again.', true);
            }
        }
        
        // Edit cashbill
        function editCashbill(id) {
            try {
                openEditCashbillModal(id);
                closeCashbillDetailModal();
            } catch (error) {
                console.error('Error editing cashbill:', error);
                showNotification('An error occurred while editing cashbill. Please try again.', true);
            }
        }
        
        // Reverse cashbill
        function reverseCashbill(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                if (currentUser.role === 'admin') {
                    // Admin can reverse directly
                    bill.status = 'reversed';
                    saveCashbills();
                    renderCashbills();
                    closeCashbillDetailModal();
                    showNotification(`Cashbill ${bill.id} reversed successfully!`);
                } else {
                    // Crew needs to request approval
                    openApprovalModal(
                        `Reversing cashbill ${bill.id} requires admin approval. Please enter your crew credentials to request approval.`,
                        () => {
                            bill.status = 'pending';
                            saveCashbills();
                            renderCashbills();
                            closeCashbillDetailModal();
                            showNotification(`Reversal request for cashbill ${bill.id} sent to admin!`);
                        }
                    );
                }
            } catch (error) {
                console.error('Error reversing cashbill:', error);
                showNotification('An error occurred while reversing cashbill. Please try again.', true);
            }
        }
        
        // Approve reverse
        function approveReverse(id) {
            try {
                const bill = cashbills.find(b => b.id === id);
                if (!bill) return;
                
                openApprovalModal(
                    `Approving reversal of cashbill ${bill.id} requires admin approval.`,
                    () => {
                        bill.status = 'reversed';
                        saveCashbills();
                        renderCashbills();
                        closeCashbillDetailModal();
                        showNotification(`Cashbill ${bill.id} reversal approved!`);
                    }
                );
            } catch (error) {
                console.error('Error approving reverse:', error);
                showNotification('An error occurred while approving reverse. Please try again.', true);
            }
        }
        
        // Process untally payment
        function processUntallyPayment() {
            try {
                const cashbillId = document.getElementById('untallyCashbillId').value;
                const amount = parseFloat(document.getElementById('untallyAmount').value);
                const reason = document.getElementById('untallyReason').value;
                
                if (!cashbillId || !amount || !reason) {
                    showNotification('Please fill in all fields!', true);
                    return;
                }
                
                const bill = cashbills.find(b => b.id === cashbillId);
                if (!bill) {
                    showNotification('Cashbill not found!', true);
                    return;
                }
                
                // Adjust the cashbill total
                bill.total += amount;
                bill.discount -= amount; // Negative discount means adding to total
                
                // Add a note about the adjustment
                if (!bill.adjustments) {
                    bill.adjustments = [];
                }
                
                bill.adjustments.push({
                    amount,
                    reason,
                    adjustedBy: currentUser.id,
                    adjustedAt: new Date().toISOString()
                });
                
                saveCashbills();
                renderCashbills();
                untallyForm.classList.remove('active');
                
                // Clear form
                document.getElementById('untallyCashbillId').value = '';
                document.getElementById('untallyAmount').value = '';
                document.getElementById('untallyReason').value = '';
                
                showNotification(`Payment adjustment of MYR ${amount.toFixed(2)} processed for ${cashbillId}!`);
            } catch (error) {
                console.error('Error processing untally payment:', error);
                showNotification('An error occurred while processing untally payment. Please try again.', true);
            }
        }
        
        // Request approval
        function requestApproval() {
            try {
                const crewId = document.getElementById('crewId').value;
                const crewPassword = document.getElementById('crewPassword').value;
                
                const crew = users.find(u => u.id === crewId && u.password === crewPassword && u.role === 'crew');
                
                if (crew) {
                    if (pendingAction) {
                        pendingAction();
                        closeApprovalModal();
                    }
                } else {
                    showNotification('Invalid crew credentials!', true);
                }
            } catch (error) {
                console.error('Error requesting approval:', error);
                showNotification('An error occurred while requesting approval. Please try again.', true);
            }
        }
        
        // Save cashbills to localStorage
        function saveCashbills() {
            try {
                localStorage.setItem('cashbills', JSON.stringify(cashbills));
            } catch (error) {
                console.error('Error saving cashbills:', error);
                showNotification('An error occurred while saving cashbills. Please try again.', true);
            }
        }
        
        // Save logbook to localStorage
        function saveLogbook() {
            try {
                localStorage.setItem('logbookEntries', JSON.stringify(logbookEntries));
            } catch (error) {
                console.error('Error saving logbook:', error);
                showNotification('An error occurred while saving logbook. Please try again.', true);
            }
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            try {
                notification.textContent = message;
                notification.className = 'notification';
                
                if (isError) {
                    notification.classList.add('error');
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
